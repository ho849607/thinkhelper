<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ThinkHelper 3.1</title>
  <link rel="icon" href="data:,"/>

  <!-- Google Identity & Drive -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>
  <meta name="google-signin-client_id"
        content="609565568467-cmagnrdngsojg5q62ljf5gi8ljk7moac.apps.googleusercontent.com"/>
  <meta name="google-api-key"
        content="AIzaSyDaBLLoSo5zwFhl72L9R7VeQqa1eybwqKk"/>

  <!-- Libraries -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€ STYLE â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <style>
  /* ===== Color Tokens ===== */
  :root {
    --primary: #1976d2;
    --primary-light: #e3f2fd;
    --primary-hover: #bbdefb;
    --bg: #f4f4f4;
    --fg: #333;
    --box: #fff;
    --border: #ccc;
    --text-light: #fff;
    --sug-bg: #e3f2fd;
    --sug-hover: #bbdefb;
    --sug-text: #000;
  }
  body.dark {
    --bg: #1e1e1e;
    --fg: #e0e0e0;
    --box: #2c2c2c;
    --border: #555;
    --sug-bg: #ffcc80;
    --sug-hover: #ffb74d;
    --sug-text: #000;
    --primary-light: #4a90e2;
    --primary-hover: #357abd;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    height: 100vh; display: flex; flex-direction: column;
    font-family: -apple-system, Segoe UI, Roboto, sans-serif;
    background: var(--bg); color: var(--fg); transition: background 0.3s, color 0.3s;
  }

  /* ===== Login Gate ===== */
  #loginGate { display: none; position: absolute; inset: 0; background: rgba(0,0,0,.82); z-index: 2000;
    color: #fff; font-size: 1.1rem; flex-direction: column; align-items: center; justify-content: center;
    text-align: center; padding: 1rem; }
  #loginGate button { margin-top: 1rem; padding: .6rem 1.2rem; border: none; border-radius: 4px;
    background: #4285f4; color: #fff; font-size: 1rem; cursor: pointer; }

  /* ===== Header ===== */
  header { display: flex; justify-content: space-between; align-items: center;
    padding: .55rem .9rem; background: var(--primary); color: var(--text-light);
    position: sticky; top: 0; z-index: 100; border-bottom: 1px solid rgba(255,255,255,.25); }
  #logoWrap { display: flex; align-items: center; gap: .65rem; }
  #logoWrap h1 { font-size: 1.1rem; font-weight: 600; }
  #menuToggle { display: none; cursor: pointer; font-size: 1.35rem; line-height: 1; }
  .toolbar { display: flex; align-items: center; gap: .4rem; }
  .btn { padding: .32rem .7rem; border: none; border-radius: 4px; background: var(--box);
    color: var(--primary); cursor: pointer; font-size: .86rem; transition: background .2s; }
  .btn:hover { background: var(--primary-light); }
  .btn.tiny { padding: .2rem .5rem; font-size: .8rem; }
  .toolbar .divider { width: 1px; height: 24px; background: var(--primary-hover); }
  select { padding: .32rem; border: none; border-radius: 4px; background: var(--box); color: var(--primary); font-size: .86rem; }

  /* ===== Main Layout ===== */
  main { flex: 1; display: flex; min-height: 0; }

  /* Left Sidebar (Document List & Actions) */
  aside { width: 230px; background: var(--primary-light); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; overflow: auto; transition: left .3s; }
  aside h3 { font-size: 1rem; font-weight: 600; padding: 1rem .9rem; border-bottom: 1px solid var(--border); }
  #mobileActions { display: none; flex-direction: column; gap: .4rem; padding: .8rem; }
  #mobileActions button, #mobileActions select { width: 100%; }
  #docList { list-style: none; font-size: .9rem; }
  #docList li { display: flex; justify-content: space-between; align-items: center;
    padding: .55rem .85rem; border-bottom: 1px dashed var(--border); cursor: pointer; }
  #docList li:hover { background: var(--primary-hover); }
  .doc-del { margin-left: .4rem; color: #888; cursor: pointer; }
  .doc-del:hover { color: #f44336; }
  #emptyCTA { padding: 1.4rem .9rem; text-align: center; font-size: .88rem; color: #555; }
  #newDocBtn { margin-top: .7rem; padding: .5rem 1rem; border: none; border-radius: 4px;
    background: var(--primary); color: #fff; cursor: pointer; font-size: .88rem; }
  #newDocBtn:hover { background: #1565c0; }

  /* Editor */
  section { flex: 1; display: flex; flex-direction: column; padding: 1rem; position: relative;
    background: var(--box); min-width: 0; transition: height .25s; }
  section.collapsed { height: 66px !important; }
  #editor { flex: 1; border: 1px solid var(--border); border-radius: 4px; padding: .9rem; overflow: auto;
    background: inherit; color: inherit; }
  #editor:empty::before { content: 'ì—¬ê¸°ì— ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”...'; color: #aaa; font-style: italic; }
  section.collapsed #editor { height: 0; padding: 0; border: none; overflow: hidden; }
  .ck-editor__editable_inline { min-height: 60vh !important; }
  #charCount { text-align: right; margin-top: .4rem; font-size: .82rem; color: var(--primary); }

  /* Search & AI Suggestions */
  #inlineSearch { display: flex; gap: .5rem; margin-top: 1rem; position: relative; }
  #inlineSearch input { flex: 1; padding: .55rem; font-size: 1rem; border: 1px solid var(--border);
    border-radius: 4px; background: inherit; color: inherit; }
  #autocomplete { display: none; position: absolute; top: 100%; left: 0; right: 0; z-index: 25; list-style: none;
    margin: .35rem 0 0; padding: 0; max-height: 160px; overflow: auto; border: 1px solid var(--border);
    border-radius: 4px; background: var(--box); font-size: .9rem; }
  #autocomplete li { padding: .45rem .55rem; border-bottom: 1px dashed var(--border); cursor: pointer; }
  #autocomplete li:hover { background: var(--primary-light); }
  #suggestions { display: none; position: absolute; z-index: 40; max-height: 220px; overflow: auto; min-width: 180px;
    background: var(--sug-bg); border: 1px solid var(--border); border-radius: 6px; padding: .25rem 0;
    box-shadow: 0 3px 8px rgba(0,0,0,.2); font-size: .9rem; }
  .suggestion-item { padding: .4rem .8rem; border-bottom: 1px dashed var(--border); cursor: pointer; color: var(--sug-text); }
  .suggestion-item:last-child { border-bottom: none; }
  .suggestion-item:hover { background: var(--sug-hover); }
  #previewPopup { display: none; position: absolute; z-index: 50; background: var(--box); border: 1px solid var(--border);
    border-radius: 6px; box-shadow: 0 3px 8px rgba(0,0,0,.2); padding: .6rem; max-width: 280px; }
  #previewPopup h4 { margin-bottom: .5rem; font-size: 1rem; }

  /* Chat */
  #chatPanel { display: none; position: fixed; bottom: 1.2rem; right: 1.2rem; width: 360px; height: 460px;
    background: var(--box); border: 1px solid var(--border); border-radius: 6px;
    box-shadow: 0 3px 8px rgba(0,0,0,.2); flex-direction: column; overflow: hidden; z-index: 300; }
  #chatHeader { display: flex; justify-content: space-between; align-items: center;
    padding: .55rem; background: var(--primary); color: var(--text-light); }
  #chatLog { flex: 1; overflow-y: auto; padding: .6rem; font-size: .85rem; }
  .chatMsg { margin: .45rem 0; padding: .5rem .75rem; border-radius: 6px; max-width: 85%; word-break: break-word; }
  .chatMsg.user { align-self: flex-end; background: var(--primary-light); }
  .chatMsg.ai { align-self: flex-start; background: #eee; }
  #chatInput { border: none; border-top: 1px solid var(--border); padding: .6rem; width: 100%; background: inherit; color: inherit; outline: none; }

  /* Consent Modal */
  #consent { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; z-index: 500; }
  #consentBox { max-width: 420px; margin: 15vh auto; background: var(--box); padding: 1.6rem; border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,.4); text-align: center; }

  /* Settings Modal */
  #settingsModal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; z-index: 500; align-items: center; justify-content: center; }
  #settingsBox { max-width: 420px; margin: 15vh auto; background: var(--box); padding: 1.6rem; border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,.4); text-align: left; }
  #settingsBox h3 { margin-bottom: 1rem; font-size: 1.2rem; }
  #settingsBox label { display: block; margin: 0.8rem 0; font-size: 0.9rem; }
  #settingsBox input[type="checkbox"] { margin-right: 0.5rem; }
  #settingsBox button { margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; }

  /* Help Modal */
  #helpModal { position: fixed; inset: 0; background: rgba(0,0,0,.55); display: none; z-index: 500; align-items: center; justify-content: center; }
  #helpBox { max-width: 600px; max-height: 80vh; overflow: auto; margin: 15vh auto; background: var(--box); padding: 1.6rem; border-radius: 10px;
    box-shadow: 0 6px 18px rgba(0,0,0,.4); text-align: left; }
  #helpBox h3 { margin-bottom: 1rem; font-size: 1.2rem; }
  #helpBox section { margin-bottom: 1.5rem; }
  #helpBox p { margin-bottom: 0.8rem; }
  #helpBox button { margin-top: 1rem; padding: 0.5rem 1rem; background: var(--primary); color: #fff; border: none; border-radius: 4px; cursor: pointer; }

  /* Footer */
  footer { text-align: center; padding: .6rem; font-size: .8rem; color: #666; border-top: 1px solid var(--border); }

  /* ===== Mobile (iPhone 14 Pro â‰¤430px) ===== */
  @media (max-width:430px) {
    #menuToggle { display: block; }
    main { flex-direction: column; }
    aside { position: fixed; left: -240px; top: 48px; height: calc(100% - 48px); z-index: 150; width: 230px; }
    body.menu-open aside { left: 0; }
    #mobileActions { display: flex; }
    section { padding: .8rem; }
    #inlineSearch { flex-direction: column; }
    #chatPanel { width: 92%; right: 4%; bottom: 4%; height: 54%; }
    .desktop-only { display: none; }
  }
  </style>
</head>
<body>

  <!-- Login Gate -->
  <div id="loginGate" class="flex">
    <h2>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h2>
    <p>ì €ì¥ ë˜ëŠ” ë‚´ë³´ë‚´ê¸° ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.</p>
    <button id="loginBtn" aria-label="Google ë¡œê·¸ì¸">Google ë¡œê·¸ì¸</button>
  </div>

  <!-- Header -->
  <header>
    <div id="logoWrap">
      <span id="menuToggle" aria-label="ë©”ë‰´ í† ê¸€">â˜°</span>
      <h1>ThinkHelper 3.1</h1>
    </div>
  
    <div class="toolbar">
      <span id="loginDisplay" style="color:#fff;margin-right:.4rem"></span>
      <button class="btn" id="authBtn" aria-label="Google ë¡œê·¸ì¸">Google ë¡œê·¸ì¸</button>
      <select id="modeSelect" class="desktop-only" aria-label="ëª¨ë“œ ì„ íƒ">
        <option value="basic">ğŸ›  Basic</option>
        <option value="journalist">ğŸ“° Journalist</option>
        <option value="research">ğŸ“‘ Research</option>
        <option value="law">âš–ï¸ Legal</option>
        <option value="dev">ğŸ’» Developer</option>
      </select>
      <button class="btn desktop-only" id="foldBtn" aria-label="ì ‘ê¸°/í¼ì¹˜ê¸°">ğŸ“„ ì ‘ê¸°/í¼ì¹˜ê¸°</button>
      <button class="btn" id="saveBtn" aria-label="ì €ì¥">ğŸ’¾ ì €ì¥</button>
      <button class="btn" id="exportBtn" aria-label="Google Driveë¡œ ë‚´ë³´ë‚´ê¸°">ğŸ“‚ Driveâ†’Docs</button>
      <button class="btn desktop-only" id="chatBtn" aria-label="ì±„íŒ…">ğŸ’¬ Chat</button>
      <button class="btn desktop-only" id="themeBtn" aria-label="í…Œë§ˆ ì „í™˜">ğŸŒ™ í…Œë§ˆ</button>
      <button class="btn desktop-only" id="settingsBtn" aria-label="ì„¤ì •">âš™ï¸ ì„¤ì •</button>
      <button class="btn desktop-only" id="helpBtn" aria-label="ë„ì›€ë§">â“</button>
    </div>
  </header>
  
  <!-- Main -->
  <main>
    <!-- Sidebar (Document List & Mobile Actions) -->
    <aside>
      <div id="mobileActions" class="mobile-only">
        <select id="mModeSelect" aria-label="ëª¨ë“œ ì„ íƒ">
          <option value="basic">ğŸ›  Basic</option>
          <option value="journalist">ğŸ“° Journalist</option>
          <option value="research">ğŸ“‘ Research</option>
          <option value="law">âš–ï¸ Legal</option>
          <option value="dev">ğŸ’» Developer</option>
        </select>
        <button class="btn" id="mChatBtn" aria-label="ì±„íŒ…">ğŸ’¬ Chat</button>
        <button class="btn" id="mThemeBtn" aria-label="í…Œë§ˆ ì „í™˜">ğŸŒ™ í…Œë§ˆ</button>
        <button class="btn" id="mSettingsBtn" aria-label="ì„¤ì •">âš™ï¸ ì„¤ì •</button>
        <button class="btn" id="mHelpBtn" aria-label="ë„ì›€ë§">â“ ë„ì›€ë§</button>
      </div>
      <h3>ë¬¸ì„œ ëª©ë¡</h3>
      <div id="emptyCTA" style="display:none">
        ì•„ì§ ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.<br/>
        <button id="newDocBtn" aria-label="ìƒˆ ë¬¸ì„œ ë§Œë“¤ê¸°">+ ìƒˆ ë¬¸ì„œ ë§Œë“¤ê¸°</button>
      </div>
      <ul id="docList"></ul>
    </aside>

    <!-- Editor Area -->
    <section id="wrap">
      <div id="editor"></div>
      <div id="charCount">0ì</div>

      <div id="inlineSearch">
        <input id="searchInput" placeholder="ê²€ìƒ‰(/) ë˜ëŠ” Ctrl+K" autocomplete="off" aria-label="ê²€ìƒ‰"/>
        <button class="btn" id="searchBtn" aria-label="ê²€ìƒ‰ ì‹¤í–‰">ğŸ” ê²€ìƒ‰</button>
      </div>

      <ul id="autocomplete"></ul>
      <div id="suggestions"></div>
      <div id="previewPopup"></div>
    </section>
  </main>

  <!-- Chat -->
  <div id="chatPanel" role="dialog" aria-label="ì±„íŒ… íŒ¨ë„">
    <div id="chatHeader">ğŸ’¬ Gemini Chat <button class="btn" id="chatClose" aria-label="ì±„íŒ… ë‹«ê¸°">âœ–ï¸ ë‹«ê¸°</button></div>
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Enter ë¡œ ì „ì†¡" aria-label="ì±„íŒ… ì…ë ¥"/>
  </div>

  <!-- Consent Modal -->
  <div id="consent" aria-label="ê°œì¸ì •ë³´ ë™ì˜ ëª¨ë‹¬">
    <div id="consentBox">
      <h3>ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ë™ì˜</h3>
      <p>ë³¸ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•˜ë©´ ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš©ì— ë™ì˜í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼ë©ë‹ˆë‹¤.<br/>ë¯¼ê°ì •ë³´ëŠ” ì…ë ¥í•˜ì§€ ë§ˆì„¸ìš”.</p>
      <button class="btn" id="agreeBtn" aria-label="ë™ì˜ í™•ì¸">í™•ì¸</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" aria-label="ì„¤ì • ëª¨ë‹¬">
    <div id="settingsBox">
      <h3>ì„¤ì •</h3>
      <label><input type="checkbox" id="enableSuggestions" checked> ë§ì¶¤ ì¶”ì²œ í™œì„±í™”</label>
      <label><input type="checkbox" id="enableInstant" checked> ì¦‰ì‹œ ì¶”ì²œ í™œì„±í™” (ëª¨ë°”ì¼ ë‹¨ì¼ ë‹¨ì–´ ì…ë ¥)</label>
      <button id="settingsCloseBtn" aria-label="ì„¤ì • ë‹«ê¸°">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- Help Modal -->
  <div id="helpModal" aria-label="ë„ì›€ë§ ëª¨ë‹¬">
    <div id="helpBox">
      <h3>ThinkHelper ë„ì›€ë§</h3>
      <section id="termsOfService">
        <h4>ì´ìš©ì•½ê´€</h4>
        <p>1. ë³¸ ì„œë¹„ìŠ¤ëŠ” AIë¥¼ ì´ìš©í•œ ìƒê° ì •ë¦¬ ë„êµ¬ì…ë‹ˆë‹¤.</p>
        <p>2. ì‚¬ìš©ìëŠ” ì„œë¹„ìŠ¤ ì´ìš© ì‹œ ëª¨ë“  ì½˜í…ì¸ ì— ëŒ€í•œ ì±…ì„ì„ ì§‘ë‹ˆë‹¤.</p>
        <p>3. ì„œë¹„ìŠ¤ëŠ” ì˜ˆê³  ì—†ì´ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      </section>
      <section id="privacyPolicy">
        <h4>ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</h4>
        <p>1. ìˆ˜ì§‘ í•­ëª©: ì´ë©”ì¼, ì‚¬ìš© ë¡œê·¸.</p>
        <p>2. ì´ìš© ëª©ì : ì„œë¹„ìŠ¤ ì œê³µ ë° ê°œì„ .</p>
        <p>3. ë³´ìœ ê¸°ê°„: ì‚¬ìš©ìê°€ ìš”ì²­ ì‹œ ì‚­ì œ.</p>
        <p>4. ì œ3ì ì œê³µ: ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      </section>
      <section id="usageGuide">
        <h4>ThinkHelper ì´ìš©ë²•</h4>
        <p>1. ì—ë””í„°ì— í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥: AI ì œì•ˆì´ ìë™ìœ¼ë¡œ ë‚˜íƒ€ë‚©ë‹ˆë‹¤ (ë§ì¶¤ ì¶”ì²œ í™œì„±í™” ì‹œ).</p>
        <p>2. ì €ì¥ ë²„íŠ¼ìœ¼ë¡œ ë¬¸ì„œ ì €ì¥ (ë¡œê·¸ì¸ í•„ìš”).</p>
        <p>3. ì±„íŒ… ê¸°ëŠ¥ìœ¼ë¡œ AIì™€ ëŒ€í™”.</p>
        <p>4. ê²€ìƒ‰ìœ¼ë¡œ ì›¹ ì½˜í…ì¸  ì‚½ì….</p>
        <p>5. í…Œë§ˆ ì „í™˜ìœ¼ë¡œ ë‹¤í¬ëª¨ë“œ ì‚¬ìš©.</p>
        <p>6. ëª¨ë“œ ì„ íƒìœ¼ë¡œ ë¦¬ì„œì¹˜, ê¸°ì‚¬, ë²•ë¥  ë¬¸ì„œ, ê°œë°œ ì‘ì—… ì§€ì›.</p>
      </section>
      <button id="helpCloseBtn" aria-label="ë„ì›€ë§ ë‹«ê¸°">ë‹«ê¸°</button>
    </div>
  </div>

  <footer>
    âš ï¸ AI ì¶œë ¥ì€ ì˜¤ë¥˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. <strong>ì¤‘ìš”í•œ ë‚´ìš©ì€ ë°˜ë“œì‹œ ê²€ì¦í•˜ì„¸ìš”.</strong><br/>
    âš ï¸ ë¯¼ê°ì •ë³´ëŠ” ì…ë ¥Â·ì €ì¥í•˜ì§€ ë§ˆì„¸ìš”.
  </footer>

<script>
/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ Google Login & Drive Initialization â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let isLoggedIn = false;
let startTime = 0;

function handleCredentialResponse(res) {
  const p = JSON.parse(atob(res.credential.split('.')[1]));
  document.getElementById('loginDisplay').textContent = `${p.name}ë‹˜`;
  isLoggedIn = true;
  document.getElementById('loginGate').style.display = 'none';
  const authBtn = document.getElementById('authBtn');
  authBtn.textContent = 'ë¡œê·¸ì•„ì›ƒ';
  authBtn.onclick = logout;
  gapi.load('client', () => {
    gapi.client.init({
      apiKey: document.querySelector('meta[name="google-api-key"]').content,
      clientId: document.querySelector('meta[name="google-signin-client_id"]').content,
      discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
      scope: "https://www.googleapis.com/auth/drive.file"
    }).catch(console.error);
  });
}

function initGoogleLogin() {
  google.accounts.id.initialize({
    client_id: document.querySelector('meta[name="google-signin-client_id"]').content,
    callback: handleCredentialResponse
  });
  google.accounts.id.renderButton(
    document.getElementById('authBtn'),
    { theme: 'outline', size: 'small' }
  );
}

function logout() {
  isLoggedIn = false;
  document.getElementById('loginDisplay').textContent = '';
  const authBtn = document.getElementById('authBtn');
  authBtn.textContent = 'Google ë¡œê·¸ì¸';
  authBtn.onclick = () => google.accounts.id.prompt();
  google.accounts.id.renderButton(authBtn, { theme: 'outline', size: 'small' });
}

function checkGate() {
  if (isLoggedIn) return;
  document.getElementById('loginGate').style.display = 'flex';
}

window.onload = function() {
  initGoogleLogin();
  document.getElementById('loginBtn').onclick = () => google.accounts.id.prompt();

  const $ = id => document.getElementById(id);
  const deb = (fn, ms = 300) => {
    let t;
    return (...a) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...a), ms);
    };
  };

  /* Settings */
  let enableSuggestions = localStorage.getItem('enableSuggestions') !== 'false';
  let enableInstant = localStorage.getItem('enableInstant') !== 'false';
  $('enableSuggestions').checked = enableSuggestions;
  $('enableInstant').checked = enableInstant;
  $('enableSuggestions').onchange = () => {
    enableSuggestions = $('enableSuggestions').checked;
    localStorage.setItem('enableSuggestions', enableSuggestions);
  };
  $('enableInstant').onchange = () => {
    enableInstant = $('enableInstant').checked;
    localStorage.setItem('enableInstant', enableInstant);
  };
  $('settingsBtn').onclick = () => $('settingsModal').style.display = 'flex';
  $('mSettingsBtn').onclick = () => $('settingsModal').style.display = 'flex';
  $('settingsCloseBtn').onclick = () => $('settingsModal').style.display = 'none';
  $('settingsModal').addEventListener('click', e => {
    if (e.target === $('settingsModal')) $('settingsModal').style.display = 'none';
  });

  /* Theme */
  function setTheme(dark) {
    console.log('Setting theme:', dark ? 'dark' : 'light');
    document.body.classList.toggle('dark', dark);
    localStorage.setItem('theme', dark ? 'dark' : 'light');
  }
  (() => {
    const savedTheme = localStorage.getItem('theme');
    const isDark = savedTheme ? savedTheme === 'dark' : (new Date().getHours() >= 18 || new Date().getHours() < 6);
    setTheme(isDark);
  })();
  $('themeBtn').onclick = () => setTheme(!document.body.classList.contains('dark'));
  $('mThemeBtn').onclick = () => setTheme(!document.body.classList.contains('dark'));

  /* Consent */
  (() => {
    if (!localStorage.getItem('consent-ok')) {
      $('consent').style.display = 'block';
      $('agreeBtn').onclick = () => {
        localStorage.setItem('consent-ok', '1');
        $('consent').style.display = 'none';
      };
    }
  })();

  /* Fold/Unfold (Editor on Desktop) */
  $('foldBtn').onclick = () => $('wrap').classList.toggle('collapsed');

  /* Mode Selection */
  let mode = 'basic';
  $('modeSelect').onchange = e => {
    mode = e.target.value;
    applyModePrompt(mode);
  };
  $('mModeSelect').onchange = e => {
    mode = e.target.value;
    applyModePrompt(mode);
  };

  function applyModePrompt(mode) {
    const prompts = {
      journalist: 'ê¸°ì‚¬ ì‘ì„±ì— ë„ì›€ì´ ë˜ëŠ” ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆ: "ê¸°ì‚¬ ì£¼ì œì— ëŒ€í•œ ê°œìš”ë¥¼ ì‘ì„±í•˜ì„¸ìš”."',
      research: 'ë¦¬ì„œì¹˜ ë…¼ë¬¸ ì‘ì„±ì— ì í•©í•œ ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆ: "ì£¼ì œì— ëŒ€í•œ ë¬¸í—Œ ê²€í† ë¥¼ ìš”ì•½í•˜ì„¸ìš”."',
      law: 'ë²•ë¥  ë¬¸ì„œ ì‘ì„±ì— í•„ìš”í•œ ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆ: "ê³„ì•½ì„œ ì´ˆì•ˆì„ ì‘ì„±í•˜ì„¸ìš”."',
      dev: 'ì½”ë“œ ì‘ì„± ë° ë””ë²„ê¹…ì— ë„ì›€ì´ ë˜ëŠ” ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤. ì˜ˆ: "í•´ë‹¹ ê¸°ëŠ¥ì˜ ì½”ë“œ ìŠ¤ë‹ˆí«ì„ ì‘ì„±í•˜ì„¸ìš”."',
      basic: 'ì¼ë°˜ì ì¸ ê¸€ì“°ê¸° ì œì•ˆì„ ì œê³µí•©ë‹ˆë‹¤.'
    };
    const promptText = prompts[mode] || prompts.basic;
    appendChat('ai', `ëª¨ë“œ ë³€ê²½: ${promptText}`);
  }

  const API = 'https://api-w7dmw4n5zq-du.a.run.app/api';

  /* PII Masking */
  const PII_PATTERNS = [
    /\b\d{2,3}-\d{2,4}-\d{4}\b/g,
    /\b[0-9]{6}-[1-4][0-9]{6}\b/g,
    /(ë¹„ë°€ë²ˆí˜¸|password)\s*[:=]?\s*\S+/gi,
    /(ì£¼ì†Œ)\s*[:=]?\s*.+/gi
  ];
  const maskSensitive = t => PII_PATTERNS.reduce((s, r) => s.replace(r, 'â˜… ë¯¼ê°ì •ë³´ ìˆ¨ê¹€ â˜…'), t);

  /* Fallback/Guess Intent/Post Suggest/Search API */
  const KO_MAP = {
    ê°€: ['ê°€ë°©', 'ê°€ê²Œ', 'ê°€êµ¬', 'ê°€ì¡±', 'ê°€ì¹˜'],
    ë‚˜: ['ë‚˜ë¬´', 'ë‚˜ë¼', 'ë‚˜ë¹„', 'ë‚˜ì´', 'ë‚˜ì—´'],
    ë‹¤: ['ë‹¤ë¦¬', 'ë‹¤ì§', 'ë‹¤ë°©', 'ë‹¤ì–‘', 'ë‹¤íˆ¼'],
    ë¼: ['ë¼ë””ì˜¤', 'ë¼ë©´', 'ë¼ë²¨', 'ë¼ì´ë¸Œ', 'ë¼ìš´ë“œ'],
    ë§ˆ: ['ë§ˆìŒ', 'ë§ˆì„', 'ë§ˆë²•', 'ë§ˆì°¨', 'ë§ˆì¼“'],
    ë°”: ['ë°”ë‹¤', 'ë°”ëŒ', 'ë°”ëŠ˜', 'ë°”ë³´', 'ë°”ìœ„'],
    ì‚¬: ['ì‚¬ê³¼', 'ì‚¬ë‘', 'ì‚¬ì „', 'ì‚¬ë§‰', 'ì‚¬ìŠ´'],
    ì•„: ['ì•„ì¹¨', 'ì•„ì´', 'ì•„ì´ìŠ¤', 'ì•„íŒŒíŠ¸', 'ì•„ë¹ '],
    ì: ['ììœ ', 'ìë™ì°¨', 'ìë£Œ', 'ìì—°', 'ìì „ê±°'],
    ì°¨: ['ì°¨ëŸ‰', 'ì°¨íŠ¸', 'ì°¨í‘œ', 'ì°¨ì´', 'ì°¨ì›'],
    ì¹´: ['ì¹´ë“œ', 'ì¹´ë©”ë¼', 'ì¹´ì¹´ì˜¤', 'ì¹´í˜', 'ì¹´ìš´íŠ¸'],
    íƒ€: ['íƒ€ì›Œ', 'íƒ€ì', 'íƒ€ì„', 'íƒ€ì¼', 'íƒ€ê¹ƒ'],
    íŒŒ: ['íŒŒë‘', 'íŒŒë„', 'íŒŒì›Œ', 'íŒŒì¼', 'íŒŒí‹°'],
    í•˜: ['í•˜ëŠ˜', 'í•˜íŠ¸', 'í•˜ì´', 'í•˜ë§ˆ', 'í•˜ë£¨']
  };
  const EN_MAP = {
    a: ['apple', 'angel', 'album', 'area', 'award'],
    b: ['banana', 'bird', 'bridge', 'brown', 'brave'],
    c: ['city', 'cloud', 'circle', 'coffee', 'candle'],
    d: ['dog', 'dance', 'dream', 'drama', 'draft'],
    e: ['eagle', 'earth', 'energy', 'event', 'extra'],
    f: ['flower', 'forest', 'future', 'focus', 'fresh'],
    g: ['grape', 'green', 'garden', 'giant', 'glory'],
    h: ['house', 'heart', 'happy', 'human', 'hobby'],
    i: ['island', 'idea', 'image', 'issue', 'iron'],
    j: ['juice', 'jungle', 'jewel', 'judge', 'joint'],
    k: ['kite', 'king', 'kitchen', 'kit', 'kind'],
    l: ['lion', 'light', 'logic', 'lake', 'leaf'],
    m: ['moon', 'music', 'market', 'magic', 'model'],
    n: ['night', 'note', 'nature', 'number', 'noble'],
    o: ['ocean', 'orange', 'orbit', 'order', 'owner'],
    p: ['piano', 'paper', 'peace', 'power', 'party'],
    q: ['queen', 'quick', 'quiet', 'quest', 'quote'],
    r: ['river', 'road', 'robot', 'rain', 'ready'],
    s: ['sun', 'star', 'smart', 'story', 'style'],
    t: ['tree', 'travel', 'table', 'trend', 'trust'],
    u: ['umbrella', 'union', 'unique', 'urban', 'upper'],
    v: ['violet', 'value', 'voice', 'visit', 'vivid'],
    w: ['whale', 'water', 'world', 'window', 'wise'],
    x: ['xylophone', 'xenon', 'xerox', 'xmas', 'x-ray'],
    y: ['yacht', 'yellow', 'youth', 'yield', 'yummy'],
    z: ['zebra', 'zero', 'zone', 'zoom', 'zen']
  };
  const koQA = w => `${w}ì´(ê°€) ë¬´ì—‡ì¸ê°€ìš”?`;
  const enQA = w => `What is ${w}?`;
  const fallback = k => {
    const ch = k[0] || 'a';
    if (/[ê°€-í£]/.test(ch)) {
      const w = KO_MAP[ch] || KO_MAP['ê°€'];
      return { words: w, sentences: w.slice(0, 3).map(koQA) };
    }
    const w = EN_MAP[ch.toLowerCase()] || EN_MAP['a'];
    return { words: w, sentences: w.slice(0, 3).map(enQA) };
  };
  const guessIntent = t => /^[ê°€-í£]{1,2}$/.test(t) ? 'define' : /\?\s*$/.test(t) ? 'ask' : (/[.!?]$/.test(t) && t.split(' ').length > 5) ? 'write' : 'other';
  const postSuggest = async k => {
    if (!enableSuggestions || k.trim().length < 2) return fallback(k);
    try {
      let modePrompt = '';
      switch (mode) {
        case 'journalist': modePrompt = 'Provide suggestions for writing a news article about '; break;
        case 'research': modePrompt = 'Provide suggestions for a research paper on '; break;
        case 'law': modePrompt = 'Provide suggestions for drafting a legal document about '; break;
        case 'dev': modePrompt = 'Provide code snippet suggestions for '; break;
        default: modePrompt = 'Provide general writing suggestions for '; break;
      }
      const r = await fetch(`${API}/suggestAI`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ keyword: modePrompt + k, mode, intent: guessIntent(k), context: '' })
      });
      if (!r.ok) throw new Error('Suggest API failed');
      return await r.json();
    } catch {
      return fallback(k);
    }
  };
  const searchAPI = async q => {
    try {
      const r = await fetch(`${API}/search?q=${encodeURIComponent(q)}`);
      if (!r.ok) throw new Error('Search API failed');
      return (await r.json()).links || [];
    } catch {
      return [];
    }
  };
  const popup = $('previewPopup');
  const hidePopup = () => popup.style.display = 'none';
  const showPopup = (html, l, t) => {
    popup.innerHTML = html;
    popup.style.left = l + 'px';
    popup.style.top = t + 'px';
    popup.style.display = 'block';
  };
  document.addEventListener('click', e => {
    if (!popup.contains(e.target)) hidePopup();
    if (window.innerWidth <= 430 && !$(e.target).closest('#wrap, #menuToggle, #aside, #loginGate, #chatPanel, #consent, #settingsModal, #helpModal')) {
      document.body.classList.remove('menu-open');
    }
  });

  /* CKEditor */
  ClassicEditor.create($('editor')).then(ed => {
    window.editor = ed;
    startTime = Date.now();

    ed.model.document.on('change:data', () => {
      $('charCount').textContent = ed.getData().replace(/<[^>]*>/g, '').length + 'ì';
    });

    /* Suggestions */
    const sug = $('suggestions');
    ed.model.document.on('change:data', deb(async () => {
      if (!enableSuggestions) {
        sug.style.display = 'none';
        return;
      }
      const plain = ed.getData().replace(/<[^>]*>/g, '');
      const pos = ed.model.document.selection.getFirstPosition();
      const word = plain.slice(0, pos.offset).match(/(\S+)$/)?.[1] || '';
      if (!word) {
        sug.style.display = 'none';
        return;
      }
      if (enableInstant && window.innerWidth <= 430 && plain.trim().split(/\s+/).length === 1) {
        const topic = prompt('ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
        if (topic) {
          try {
            const r = await fetch(`${API}/gpt`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ text: `Generate ${mode === 'journalist' ? 'a news article' : mode === 'research' ? 'a research summary' : mode === 'law' ? 'a legal document' : mode === 'dev' ? 'a code snippet' : 'content'} about ${topic} related to ${word}` })
            });
            const j = await r.json();
            const generated = j.response?.text || '(ì˜¤ë¥˜)';
            ed.model.change(writer => {
              writer.insertText(generated, ed.model.document.selection.getFirstPosition());
            });
          } catch {
            alert('(ì„œë²„ ì˜¤ë¥˜)');
          }
          return;
        }
      }
      const { words, sentences } = await postSuggest(word);
      const list = sentences.length ? sentences : words.slice(0, 5);
      if (!list.length) {
        sug.style.display = 'none';
        return;
      }
      const rangeRect = window.getSelection().getRangeAt(0).getBoundingClientRect();
      const wrapRect = $('wrap').getBoundingClientRect();
      sug.innerHTML = list.map((t, i) => `<div class="suggestion-item" data-i="${i}">${DOMPurify.sanitize(t)}</div>`).join('');
      sug.querySelectorAll('.suggestion-item').forEach(el => {
        el.onclick = () => {
          const txt = maskSensitive(list[+el.dataset.i]);
          ed.model.change(writer => {
            writer.insertText(txt + ' ', ed.model.document.selection.getFirstPosition());
          });
          sug.style.display = 'none';
        };
      });
      sug.style.visibility = 'hidden';
      sug.style.display = 'block';
      const h = sug.offsetHeight, w = sug.offsetWidth;
      sug.style.visibility = 'visible';
      let top = rangeRect.bottom - wrapRect.top + 4;
      let left = Math.min(Math.max(rangeRect.left - wrapRect.left, 0), wrapRect.width - w);
      if (top + h > wrapRect.height) {
        top = rangeRect.top - wrapRect.top - h - 4;
        if (top < 0) top = wrapRect.height - h;
      }
      sug.style.left = `${left}px`;
      sug.style.top = `${top}px`;
    }, 250));

    /* Search Autocomplete */
    const ac = $('autocomplete');
    $('searchInput').addEventListener('input', deb(async e => {
      const q = e.target.value.trim();
      if (q.length < 2) {
        ac.style.display = 'none';
        return;
      }
      const links = await searchAPI(q);
      ac.innerHTML = links.slice(0, 6).map((l, i) => `
        <li data-i="${i}">
          <strong>${DOMPurify.sanitize(l.title)}</strong><br>
          <small>${DOMPurify.sanitize(l.snippet)}</small><br>
          <button class="btn tiny" data-open="${l.link}">ì´ë™</button>
        </li>`).join('');
      ac.querySelectorAll('li').forEach(li => {
        const item = links[+li.dataset.i];
        li.onclick = () => {
          const wRect = $('wrap').getBoundingClientRect();
          const r = li.getBoundingClientRect();
          showPopup(`<h4>${DOMPurify.sanitize(item.title)}</h4><p>${DOMPurify.sanitize(item.snippet)}</p><button id="btnInsert">ì‚½ì…</button>`,
            r.left - wRect.left, r.bottom - wRect.top + 4);
          document.getElementById('btnInsert').onclick = () => {
            ac.style.display = 'none';
            hidePopup();
            ed.model.change(writer => {
              const h = `<blockquote><p><a href="${item.link}" target="_blank">${DOMPurify.sanitize(item.title)}</a></p><small>${DOMPurify.sanitize(item.snippet)}</small></blockquote><p></p>`;
              writer.insert(ed.data.toModel(ed.data.processor.toView(h)), ed.model.document.selection.getFirstPosition());
            });
          };
        };
        li.querySelector('[data-open]').onclick = e => {
          e.stopPropagation();
          window.open(e.currentTarget.dataset.open, '_blank');
        };
      });
      ac.style.display = links.length ? 'block' : 'none';
    }, 250));
    $('searchInput').addEventListener('keydown', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        $('searchBtn').click();
      }
    });

    $('searchBtn').onclick = () => {
      const q = $('searchInput').value.trim();
      if (!q) return;
      if (confirm(`Googleì—ì„œ "${q}" ê²€ìƒ‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank');
        return;
      }
      searchAPI(q).then(links => {
        if (!links.length) {
          alert('ê²€ìƒ‰ê²°ê³¼ ì—†ìŒ');
          return;
        }
        const it = links[0];
        ed.model.change(writer => {
          const h = `<blockquote><p><a href="${it.link}" target="_blank">${DOMPurify.sanitize(it.title)}</a></p><small>${DOMPurify.sanitize(it.snippet)}</small></blockquote><p></p>`;
          writer.insert(ed.data.toModel(ed.data.processor.toView(h)), ed.model.document.selection.getFirstPosition());
        });
      });
    };

    /* Save / Load Docs */
    const loadDocs = () => {
      const ul = $('docList');
      ul.innerHTML = '';
      const ks = Object.keys(localStorage).filter(k => k.startsWith('doc-')).sort().reverse();
      $('emptyCTA').style.display = ks.length ? 'none' : 'block';
      if (!ks.length) return;
      ks.forEach(k => {
        try {
          const { title, html } = JSON.parse(localStorage.getItem(k));
          const li = document.createElement('li');
          li.textContent = title;
          li.onclick = () => ed.setData(html);
          const del = document.createElement('span');
          del.textContent = 'âœ–ï¸';
          del.className = 'doc-del';
          del.onclick = e => {
            e.stopPropagation();
            localStorage.removeItem(k);
            loadDocs();
          };
          li.appendChild(del);
          ul.appendChild(li);
        } catch (e) {
          console.error(`Failed to parse doc ${k}:`, e);
        }
      });
    };
    $('saveBtn').onclick = () => {
      if (!isLoggedIn) {
        checkGate();
        return;
      }
      const html = ed.getData();
      const title = html.replace(/<[^>]*>/g, '').trim().split(/[\n\.]/)[0] || 'ë¬´ì œ';
      localStorage.setItem('doc-' + Date.now(), JSON.stringify({ title, html }));
      loadDocs();
      appendChat('ai', 'ë¬¸ì„œë¥¼ ê²€í† í•´ ë“œë¦´ê¹Œìš”?');
      $('chatPanel').style.display = 'flex';
    };
    $('newDocBtn').onclick = () => ed.setData('');
    loadDocs();

    /* Drive Export */
    $('exportBtn').onclick = async () => {
      if (!isLoggedIn) {
        checkGate();
        return;
      }
      const htmlContent = window.editor.getData();
      const meta = { name: 'thinkhelper.html', mimeType: 'application/vnd.google-apps.document' };
      const form = new FormData();
      form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
      form.append('file', new Blob([htmlContent], { type: 'text/html' }));
      try {
        const token = gapi.auth.getToken()?.access_token;
        if (!token) throw new Error('No access token available');
        const r = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id', {
          method: 'POST',
          headers: { Authorization: 'Bearer ' + token },
          body: form
        });
        const j = await r.json();
        if (j.id) {
          window.open(`https://docs.google.com/document/d/${j.id}/edit`, '_blank');
        } else {
          throw new Error('Upload failed');
        }
      } catch (e) {
        console.error(e);
        alert('Google Docs ì—…ë¡œë“œ ì‹¤íŒ¨');
      }
    };

    /* Chat */
    $('chatBtn').onclick = () => $('chatPanel').style.display = 'flex';
    $('mChatBtn').onclick = () => $('chatPanel').style.display = 'flex';
    $('chatClose').onclick = () => $('chatPanel').style.display = 'none';

    const appendChat = (cls, txt) => {
      const d = document.createElement('div');
      d.className = 'chatMsg ' + cls;
      d.textContent = txt;
      $('chatLog').appendChild(d);
      $('chatLog').scrollTop = $('chatLog').scrollHeight;
      saveChat();
      return d;
    };
    const saveChat = () => localStorage.setItem('chat-history', $('chatLog').innerHTML);
    const loadChat = () => {
      const h = localStorage.getItem('chat-history');
      if (h) $('chatLog').innerHTML = h;
    };
    loadChat();

    $('chatInput').addEventListener('keydown', async e => {
      if (e.key !== 'Enter' || e.isComposing) return;
      const q = e.target.value.trim();
      if (!q) return;
      e.target.value = '';
      appendChat('user', q);
      const ai = appendChat('ai', 'â³');
      try {
        const r = await fetch(`${API}/gpt`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: q })
        });
        const j = await r.json();
        ai.textContent = j.response?.text || '(ì˜¤ë¥˜)';
      } catch {
        ai.textContent = '(ì„œë²„ ì˜¤ë¥˜)';
      }
      saveChat();
    });

    /* Help Modal */
    $('helpBtn').onclick = () => $('helpModal').style.display = 'flex';
    $('mHelpBtn').onclick = () => $('helpModal').style.display = 'flex';
    $('helpCloseBtn').onclick = () => $('helpModal').style.display = 'none';
    $('helpModal').addEventListener('click', e => {
      if (e.target === $('helpModal')) $('helpModal').style.display = 'none';
    });

    /* Mobile Menu Toggle */
    $('menuToggle').onclick = () => {
      document.body.classList.toggle('menu-open');
    };
    window.addEventListener('resize', () => {
      if (window.innerWidth > 430) document.body.classList.remove('menu-open');
    });
  });
};
</script>
</body>
</html>
