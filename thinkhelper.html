# We'll build a **no-API** GitHub Pages package that strips or disables Gemini/own-API usage.
# What this script does:
# 1) Splits the provided single-file HTML into index.html + assets/styles.css + assets/app.js
# 2) Removes sensitive/abusable bits (Gemini API key meta, GA/reCAPTCHA/GIS/Pay/Paddle scripts)
# 3) Tightens CSP to a minimal set for the demo
# 4) Patches JS to disable chat/search backend calls, rely only on client features,
#    and avoid any calls to ipapi/Drive/GIS/etc.
# 5) Produces README and manifest, then zips for easy download.

import os, re, json, textwrap, shutil, pathlib, zipfile

root = "/mnt/data/thinkhelper-pages-noapi"
assets_dir = os.path.join(root, "assets")
os.makedirs(assets_dir, exist_ok=True)

original_html = r"""<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="
        default-src 'self';
        script-src 'self' https://accounts.google.com https://www.gstatic.com https://cdn.ckeditor.com https://apis.google.com https://cdn.jsdelivr.net https://ipapi.co https://pay.google.com https://cdn.paddle.com https://www.googletagmanager.com https://www.google-analytics.com https://www.google.com 'unsafe-inline' 'unsafe-eval';
        frame-src https://accounts.google.com/gsi/ https://pay.google.com https://checkout.paddle.com https://*.paddle.com https://www.googletagmanager.com https://www.google.com;
        connect-src 'self' https://accounts.google.com/gsi/ https://ipapi.co https://api-w7dmw4n5zq-du.a.run.app https://www.googleapis.com https://oauth2.googleapis.com https://generativelanguage.googleapis.com https://pay.google.com https://api.paddle.com https://www.google-analytics.com https://region1.google-analytics.com https://www.google.com wss: ws:;
        style-src 'self' 'unsafe-inline' https://cdn.ckeditor.com;
        img-src 'self' data: https://*.paddle.com https://www.google-analytics.com;
        object-src 'none';
        "/>

  <meta http-equiv="Permissions-Policy" content="identity-credentials-get=()"/>

  <title>ThinkHelper 3.1</title>
  <link rel="icon" href="data:,"/>
  <link rel="manifest" href="manifest.json"/>

  <!-- Google reCAPTCHA Enterprise -->
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LdrQpwrAAAAAEfS6GhTaZwnTY5MpC69IEeRNDIT"></script>

  <!-- (옵션) 결제 스크립트 -->
  <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
  <script src="https://cdn.paddle.com/paddle/v2/paddle.js" async></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Editor & sanitize -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js" async></script>

  <!-- OAuth/Gemini API Key -->
  <meta name="google-signin_client_id" content="609565568467-cmagnrdngsojg5q62ljf5gi8ljk7moac.apps.googleusercontent.com"/>
  <meta name="google-api-key" content="AIzaSyDaBLLoSo5zwFhl72L9R7VeQqa1eybwqKk"/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9PM41E1HFW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-9PM41E1HFW');
  </script>

  <style>
    :root{
      --primary:#1976d2; --primary-light:#e3f2fd; --primary-hover:#bbdefb;
      --bg:#f6f7fb; --fg:#262b33; --box:#fff; --border:#ccd3e0; --text-light:#fff;
      --sug-bg:#ffffff; --sug-hover:#eef4ff; --sug-text:#0f172a;
      --pill-bg:#ffe7e7; --pill-border:#f44336; --pill-dot:#b71c1c;
    }
    body.dark{
      --bg:#0f172a; --fg:#e2e8f0; --box:#0b1220; --border:#2a3550;
      --sug-bg:#0b1220; --sug-hover:#111a2e; --sug-text:#e2e8f0;
      --primary-light:#90CAF9; --primary-hover:#64B5F6;
      --pill-bg:#2a1111; --pill-border:#ef9a9a; --pill-dot:#ffb4b4;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;display:flex;flex-direction:column;font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--fg);transition:background .3s,color .3s}

    header{display:flex;justify-content:space-between;align-items:center;padding:.6rem .9rem;background:var(--primary);color:var(--text-light);position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,255,255,.2)}
    #logoWrap{display:flex;align-items:center;gap:.6rem}
    #logoWrap h1{font-size:1.05rem;font-weight:700}
    .toolbar{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
    .btn{padding:.34rem .72rem;border:none;border-radius:10px;background:var(--box);color:var(--primary);cursor:pointer;font-size:.9rem;transition:background .2s}
    .btn:hover{background:var(--primary-light)}
    .btn.tiny{padding:.24rem .5rem;font-size:.84rem}
    select{padding:.34rem;border:none;border-radius:10px;background:var(--box);color:var(--primary);font-size:.9rem}

    /* 데스크탑: 햄버거 숨김 / 모바일(≤860px): 햄버거 표시 */
    #sidebarToggle{display:none}
    @media (max-width:860px){
      #sidebarToggle{display:inline-flex}
      .toolbar> :not(#authBtn):not(#saveBtn):not(#helpBtn):not(#menuBtn):not(#recaptchaBtn){display:none !important}
      #menuBtn{display:inline-flex}
    }
    #menuBtn{display:none}

    .badge{display:inline-block;padding:.16rem .5rem;border-radius:999px;font-size:.78rem;background:rgba(255,255,255,.25);color:#fff}
    .badge.off{background:#d32f2f}

    main{flex:1;display:flex;min-height:0}
    aside{width:260px;background:var(--primary-light);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:auto}
    body.dark aside{background:#0f2334}
    @media (max-width:860px){
      aside{display:none}
      aside.open{display:flex;position:fixed;top:54px;bottom:0;left:0;z-index:250;width:80vw;max-width:320px}
    }
    aside h3{font-size:1rem;font-weight:700;padding:1rem .9rem;border-bottom:1px solid var(--border)}
    #docList,#chatList{list-style:none;font-size:.92rem}
    #docList li,#chatList li{display:flex;justify-content:space-between;align-items:center;padding:.6rem .85rem;border-bottom:1px dashed var(--border);cursor:pointer}
    #docList li small{opacity:.7}
    #docList li:hover,#chatList li:hover{background:var(--primary-hover)}
    #emptyCTA{padding:1rem .9rem;text-align:center;font-size:.88rem;color:#555}
    #newDocBtn{margin:.7rem; padding:.6rem 1rem;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer;font-size:.92rem}
    #newDocBtn:hover{background:#1565c0}

    section{flex:1;display:flex;flex-direction:column;padding:1rem;background:var(--box);min-width:0;position:relative}
    #editor{flex:1;border:1px solid var(--border);border-radius:12px;padding:1rem;overflow:auto;background:inherit;color:inherit}
    #editor:empty::before{content:attr(data-placeholder);color:#9aa3b2;font-style:italic}
    .ck-editor__editable_inline{min-height:58vh!important}
    .ck-content{color:inherit;background:inherit;font-size:1.02rem;line-height:1.7}
    .ck-content a{color:var(--primary-hover)} body.dark .ck-content a{color:#90caf9}
    #charCount{display:none}

    /* 에디터 Quick Actions (복사만) */
    #quickActions{display:flex;gap:.5rem;margin:.6rem 0 .2rem 0}
    #quickActions .btn{padding:.28rem .6rem;font-size:.85rem}

    #inlineSearch{display:flex;gap:.5rem;margin-top:1rem;position:relative}
    #inlineSearch input{flex:1;padding:.7rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:12px;background:inherit;color:inherit}
    #inlineSearch button{border-radius:12px}
    #inlineSearch input::placeholder{color:#8a93a3} body.dark #inlineSearch input::placeholder{color:#b8c1d4}

    /* 검색 자동 제안 */
    #searchSuggest{
      position:absolute; top:100%; left:0; right:0; margin-top:6px;
      background:var(--sug-bg); color:var(--sug-text); border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(0,0,0,.22);
      display:none; z-index:1200; max-height:280px; overflow:auto;
    }
    .search-sug-item{padding:.6rem .9rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;gap:.5rem;align-items:center}
    .search-sug-item:last-child{border-bottom:none}
    .search-sug-item:hover,.search-sug-item.selected{background:var(--sug-hover)}
    .search-sug-item .icon{opacity:.8}
    .search-sug-item .text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* 검색 직행 제안 배너 */
    #searchJump{
      margin-top:8px; display:none; align-items:center; gap:.5rem;
      background:var(--sug-bg); color:var(--sug-text);
      border:1px solid var(--border); border-radius:12px; padding:8px 10px;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
    }
    #searchJump .label{font-weight:700}
    #searchJump .meta{opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:45%}
    @media (max-width:860px){ #searchJump .meta{max-width:55%} }

    /* 입력 제안(에디터 칩) */
    #suggestions{
      position:fixed;z-index:99999;max-height:240px;overflow:auto;min-width:260px;
      background:var(--sug-bg);border:1px solid var(--border);border-radius:12px;padding:.25rem 0;
      box-shadow:0 12px 28px rgba(0,0,0,.22);font-size:.96rem;display:none;-webkit-overflow-scrolling:touch;
    }
    .suggestion-item{padding:.55rem .9rem;border-bottom:1px dashed var(--border);cursor:pointer;color:var(--sug-text);white-space:nowrap}
    .suggestion-item:last-child{border-bottom:none}
    .suggestion-item:hover,.suggestion-item.selected{background:var(--sug-hover)}
    .suggestion-item.selected{outline:2px solid var(--primary)}

    /* PII pill */
    .ck-content .pii-pill{
      background:var(--pill-bg); border:1px dashed var(--pill-border);
      color:transparent; border-radius:999px; padding:0 .5em; user-select:none;
      box-decoration-break:clone;
    }
    .ck-content .pii-pill::after{content:"••••"; color:var(--pill-dot); letter-spacing:.12em;}

    /* 저장 메뉴 */
    #saveMenu{position:fixed;display:none;z-index:1600;min-width:240px;background:var(--box);color:var(--fg);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.22)}
    #saveMenu button{display:block;width:100%;border:0;background:transparent;color:#0d1b2a;font-weight:700;font-size:.95rem;padding:.75rem 1rem;text-align:left;letter-spacing:.01em;border-bottom:1px dashed var(--border)}
    #saveMenu button:last-child{border-bottom:none}
    body.dark #saveMenu{background:#0b1220;border-color:#2a3550}
    body.dark #saveMenu button{color:#eaeef9}
    #saveMenu button:hover,#saveMenu button:focus{background:var(--primary);color:#fff}
    #saveMenu button:focus-visible{outline:3px solid var(--primary);outline-offset:2px}

    /* 공통 모달 */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000}
    .modal .card{width:min(92vw,760px);max-height:85vh;overflow:auto;background:var(--box);color:var(--fg);border:1px solid var(--border);border-radius:12px;box-shadow:0 20px 48px rgba(0,0,0,.35)}
    .modal .card header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal .card .content{padding:14px 16px}
    .modal .close{border:none;background:transparent;font-size:20px;cursor:pointer;color:inherit}

    /* 드로어(모바일) */
    #drawer{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:flex-end;z-index:1600}
    #drawer .sheet{width:min(92vw,380px);height:100%;background:var(--box);color:var(--fg);border-left:1px solid var(--border);padding:1rem;display:flex;flex-direction:column;gap:.8rem}
    #drawer .row{display:flex;gap:.5rem;align-items:center}
    #drawer .row select, #drawer .row button, #drawer .row input{flex:1}
    #helpInlineMobile{font-size:.92rem;line-height:1.6;border-top:1px solid var(--border);padding-top:.6rem}

    /* 숨길 요소들 */
    .grecaptcha-badge,
    .site-error,
    .error,
    small[style*="color:red"],
    .ck.ck-notification__message{display:none !important;}
    footer#legal{font-size:.8rem;opacity:.7;padding:.6rem 1rem;background:transparent;color:inherit}

    /* Gemini Chat */
    #chatPanel{
      position:fixed; right:16px; bottom:16px; width:420px; height:520px;
      display:none; flex-direction:column;
      background:var(--box); color:var(--fg); border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(0,0,0,.22); z-index:1800;
    }
    #chatPanel.fullscreen{ left:0; right:0; top:54px; bottom:0; width:auto; height:auto; border-radius:0; }
    #chatHeader{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border); background:var(--primary-light)}
    #chatHeader .right{display:flex; gap:.4rem}
    #chatLog{flex:1; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:6px}
    .chatMsg{max-width:80%; padding:8px 10px; border-radius:12px; line-height:1.45}
    .chatMsg.user{align-self:flex-end; background:var(--primary-light)}
    .chatMsg.ai{align-self:flex-start; background:#eceff1}
    #chatInput{border:1px solid var(--border); border-radius:10px; padding:10px 12px; margin:10px}

    @media (max-width:860px){
      #chatPanel{ left:8px; right:8px; bottom:10px; width:auto; height:65vh; }
    }
  </style>
</head>
<body>
  <header>
    <div id="logoWrap">
      <button class="btn tiny" id="sidebarToggle" title="사이드바" aria-label="사이드바">☰</button>
      <h1 id="appTitle">ThinkHelper 3.1</h1>
    </div>
    <div class="toolbar">
      <span id="loginDisplay" style="color:#fff;margin-right:.2rem"></span>
      <span id="consentBadge" class="badge" title="개인정보 동의 상태"></span>
      <button class="btn" id="authBtn">Google 로그인</button>

      <!-- 데스크탑 언어/모드 -->
      <select id="languageSelect" aria-label="Language">
        <option value="ko">한국어</option>
        <option value="en">English</option>
        <option value="ja">日本語</option>
      </select>
      <select id="modeSelect" aria-label="Mode">
        <option value="basic">🛠 Basic</option>
        <option value="journalist">📰 Journalist</option>
        <option value="research">📑 Research</option>
        <option value="law">⚖️ Legal</option>
        <option value="dev">💻 Developer</option>
      </select>

      <button class="btn" id="saveBtn">💾 저장</button>
      <button class="btn" id="chatBtn">💬 채팅</button>
      <button class="btn" id="themeBtn">🌙 테마</button>
      <button class="btn" id="settingsBtn">⚙️ 설정</button>
      <button class="btn" id="helpBtn">❓ 도움말</button>
      <button class="btn" id="shareNaverBtn">네이버 블로그</button>
      <button class="btn" id="shareTwitterBtn">트위터</button>
      <button class="btn g-recaptcha" id="recaptchaBtn"
        data-sitekey="6LdrQpwrAAAAAEfS6GhTaZwnTY5MpC69IEeRNDIT"
        data-callback="onSubmit"
        data-action="submit">reCAPTCHA</button>

      <!-- 모바일 햄버거 -->
      <button class="btn" id="menuBtn" aria-label="메뉴">☰</button>
    </div>

    <div id="saveMenu" role="menu" aria-label="Save options">
      <button id="saveMenuPdf">🖨️ <span>PDF로 저장</span></button>
      <button id="saveMenuDevice">💾 <span>기기에 저장하기(HTML)</span></button>
      <button id="exportBtn">📂 <span>Drive로 내보내기(Google Docs)</span></button>
    </div>
  </header>

  <main>
    <aside id="sidebar">
      <h3 id="docListTitle">문서 목록</h3>
      <div id="emptyCTA" style="display:none">
        <span id="emptyText">아직 저장된 문서가 없습니다.</span><br/>
        <button id="newDocCTA" class="btn">+ 새 문서</button>
      </div>
      <button class="btn" id="newDocBtn">➕ 새 문서</button>
      <ul id="docList"></ul>

      <h3 id="chatListTitle">채팅 기록</h3>
      <ul id="chatList"></ul>
    </aside>

    <section id="wrap">
      <!-- 에디터 Quick Actions (복사만) -->
      <div id="quickActions">
        <button class="btn tiny" id="copyBtn">📋 Copy (Ctrl/Cmd+C)</button>
      </div>

      <div id="editor" data-placeholder="여기에 글을 입력하세요..."></div>
      <div id="charCount">0 자</div>

      <div id="inlineSearch">
        <input id="searchInput" placeholder="검색 (/ 또는 Ctrl+K)" autocomplete="off"/>
        <button class="btn" id="searchBtn">🔍 <span id="searchBtnText">검색</span></button>
        <div id="searchSuggest"></div>
        <!-- 검색 직행 제안 배너 -->
        <div id="searchJump" role="region" aria-live="polite"></div>
      </div>

      <!-- 입력 중 의도 제안 칩 -->
      <div id="suggestions"></div>
    </section>
  </main>

  <!-- 하단 고지문 -->
  <footer id="legal">
    This site is protected by reCAPTCHA and the Google
    <a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a> and
    <a href="https://policies.google.com/terms" target="_blank" rel="noopener">Terms of Service</a> apply.
  </footer>

  <!-- 모바일/아이패드 드로어 -->
  <div id="drawer" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="Quick Menu">
      <div class="row">
        <label style="min-width:88px" id="labelLang">Language</label>
        <select id="languageSelectMobile">
          <option value="ko">한국어</option>
          <option value="en">English</option>
          <option value="ja">日本語</option>
        </select>
      </div>
      <div class="row">
        <label style="min-width:88px" id="labelMode">Mode</label>
        <select id="modeSelectMobile">
          <option value="basic">🛠 Basic</option>
          <option value="journalist">📰 Journalist</option>
          <option value="research">📑 Research</option>
          <option value="law">⚖️ Legal</option>
          <option value="dev">💻 Developer</option>
        </select>
      </div>
      <div class="row">
        <button class="btn" id="themeBtnMobile">🌙 테마</button>
        <button class="btn" id="settingsBtnMobile">⚙️ 설정</button>
      </div>
      <div class="row">
        <button class="btn" id="shareNaverBtnMobile">네이버 블로그</button>
        <button class="btn" id="shareTwitterBtnMobile">트위터</button>
      </div>

      <!-- 모바일 도움말 인라인 -->
      <div id="helpInlineMobile"></div>

      <button class="btn" id="drawerClose" style="margin-top:auto">닫기</button>
    </div>
  </div>

  <!-- reCAPTCHA 데모 폼(요청 코드 유지) -->
  <form id="demo-form" action="#" method="post" style="display:none"></form>

  <!-- 동의 모달 -->
  <div id="consent" class="modal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
    <div class="card">
      <header>
        <h3 id="consentTitle">개인정보 수집·이용 안내</h3>
        <button class="close" id="consentClose" aria-label="닫기">✕</button>
      </header>
      <div class="content">
        <p id="consentBody" style="line-height:1.7;margin:.4rem 0">
          사용자는 로그인 없이도 본 서비스를 이용할 수 있습니다. 다만,
          <strong>로그인 시 및 문서를 작성할 때</strong> 사용자가 작성하는 내용 중 일부는 품질 개선과 기능 제공을 위해 수집될 수 있다는 것에 동의합니다.
          동의를 거부하더라도 서비스는 이용 가능하지만,
          <strong>이 경우 추천 에디터 기능은 비활성화</strong>됩니다.
        </p>
        <p style="margin:.4rem 0">
          <a id="privacyLink" href="https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing" target="_blank" rel="noopener">개인정보 처리방침 자세히 보기</a> ·
          <a id="tosLink" href="https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing" target="_blank" rel="noopener">서비스 이용약관 자세히 보기</a>
        </p>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:10px">
          <button class="btn" id="declineBtn" style="background:#eee">거부</button>
          <button class="btn" id="agreeBtn" style="background:#1976d2;color:#fff">동의</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 도움말 모달(데스크탑용) -->
  <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="card">
      <header>
        <h3 id="helpTitle">도움말</h3>
      <button class="close" data-close="#helpModal" aria-label="닫기">✕</button>
      </header>
      <div class="content" id="helpContent"></div>
    </div>
  </div>

  <!-- 설정 모달 -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="card">
      <header>
        <h3 id="settingsTitle">설정</h3>
        <button class="close" data-close="#settingsModal" aria-label="닫기">✕</button>
      </header>
      <div class="content">
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="toggleSuggestions" id="labelSuggest">추천 에디터 사용</label>
          <input type="checkbox" id="toggleSuggestions"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="toggleInstant" id="labelInstant">모바일 즉시 제안(저사양 비활성 권장)</label>
          <input type="checkbox" id="toggleInstant"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="togglePdfMask" id="labelPdfMask">PDF 저장 시 마스킹 적용</label>
          <input type="checkbox" id="togglePdfMask"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="togglePiiHighlight" id="labelPiiHighlight">에디터에서 PII 하이라이트 표시</label>
          <input type="checkbox" id="togglePiiHighlight"/>
        </div>
        <hr style="margin:10px 0; border:none; border-top:1px solid var(--border)"/>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap">
          <button class="btn" id="reopenConsent">개인정보 동의 다시 설정</button>
          <button class="btn" id="toggleThemeInSettings">테마 토글</button>
        </div>
        <p style="margin-top:10px;font-size:.92rem;color:#555">
          • 복사는 상단 <b>Copy</b> 버튼, <b>붙여넣기</b>는 <code>Ctrl/⌘+V</code>.<br/>
          • <b>되돌리기/다시하기</b>: <code>Ctrl/⌘+Z</code> / <code>Ctrl/⌘+Shift+Z</code> 또는 <code>Ctrl/⌘+Y</code>.<br/>
          • PDF 저장 시 PII 마스킹은 위 토글로 설정합니다.
        </p>
      </div>
    </div>
  </div>

  <!-- Gemini Chat -->
  <div id="chatPanel" role="dialog" aria-label="Gemini Chat">
    <div id="chatHeader">
      <span id="chatTitle">💬 Gemini Chat</span>
      <div class="right">
        <button class="btn tiny" id="chatFullscreenToggle">⤢ Full</button>
        <button class="btn tiny" id="chatClose">Close</button>
      </div>
    </div>
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Enter로 전송" aria-label="Chat Input"/>
  </div>

  <!-- External scripts kept minimal for demo -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js" async></script>
  <link rel="stylesheet" href="assets/styles.css"/>
  <script defer src="assets/app.js"></script>
</body>
</html>
"""

# Extract CSS and the main inline app script from the original
style_match = re.search(r"<style>([\s\S]*?)</style>", original_html, re.IGNORECASE)
css = style_match.group(1).strip() if style_match else ""

# The original has multiple <script> blocks; we want the **last inline** one (the big app)
script_blocks = re.findall(r"<script>([\s\S]*?)</script>", original_html, re.IGNORECASE)
app_js = script_blocks[-1].strip() if script_blocks else ""

# Prepare index.html with tightened CSP and removed sensitive scripts/meta
index_html = original_html

# 1) Replace CSP meta with a minimal safer one (no remote API endpoints)
new_csp = (
  '<meta http-equiv="Content-Security-Policy"\n'
  '        content="\n'
  "        default-src 'self';\n"
  "        script-src 'self' https://cdn.ckeditor.com https://cdn.jsdelivr.net 'unsafe-inline';\n"
  "        connect-src 'self';\n"
  "        style-src 'self' 'unsafe-inline' https://cdn.ckeditor.com;\n"
  "        img-src 'self' data:;\n"
  "        object-src 'none';\n"
  '        "/>'
)
index_html = re.sub(r'<meta http-equiv="Content-Security-Policy"[\s\S]*?/>', new_csp, index_html, flags=re.IGNORECASE)

# 2) Remove GA/reCAPTCHA/GIS/Pay/Paddle external scripts
patterns_to_remove = [
    r'<script src="https://www\.google\.com/recaptcha/enterprise\.js[^"]*"></script>',
    r'<script async src="https://pay\.google\.com/gp/p/js/pay\.js"></script>',
    r'<script src="https://cdn\.paddle\.com/paddle/v2/paddle\.js" async></script>',
    r'<script src="https://accounts\.google\.com/gsi/client" async defer></script>',
    r'<script async src="https://www\.googletagmanager\.com/gtag/js\?id=[^"]+"></script>',
]
for pat in patterns_to_remove:
    index_html = re.sub(pat, '', index_html)

# 3) Remove the inline GA init block
index_html = re.sub(
    r"<script>\s*window\.dataLayer[\s\S]*?<\/script>",
    "",
    index_html,
    flags=re.IGNORECASE
)

# 4) Remove the Google API key meta (Gemini key) and keep/neutralize client_id
index_html = re.sub(
    r'<meta name="google-api-key" content="[^"]*"\s*/?>',
    '',
    index_html,
    flags=re.IGNORECASE
)

# 5) Replace the <style> with link to assets css
if style_match:
    index_html = index_html.replace(style_match.group(0), '<link rel="stylesheet" href="assets/styles.css"/>')

# 6) Remove **all** inline <script> blocks EXCEPT we will add our external app.js at the end.
#    We'll rebuild the end of body to include minimal externals only.
# First, strip every <script>...</script> without src
index_html = re.sub(r"<script>([\s\S]*?)</script>", "", index_html)
# Also strip any previous CKEditor/DOMPurify tags; we will add them at the bottom in a clean block
index_html = re.sub(r'<script[^>]*src="https://cdn\.ckeditor\.com[^"]*"[^>]*></script>', "", index_html)
index_html = re.sub(r'<script[^>]*src="https://cdn\.jsdelivr\.net[^"]*"[^>]*></script>', "", index_html)

# Add back minimal scripts and our external js before </body>
index_html = index_html.replace(
    "</body>",
    (
        '  <!-- External scripts kept minimal for demo -->\n'
        '  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>\n'
        '  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js" async></script>\n'
        '  <script defer src="assets/app.js"></script>\n'
        '</body>'
    )
)

# 7) Patch the JS to disable API usage
patched_js = app_js

# Replace API_ORIGIN and apiUrl
patched_js = re.sub(
    r"const\s+API_ORIGIN\s*=\s*'[^']*';",
    "const API_ORIGIN = null; const NO_API = true;",
    patched_js
)
patched_js = re.sub(
    r"const\s+apiUrl\s*=\s*\(p=''\)\s*=>\s*`[^`]+`;",
    "const apiUrl = (p='') => '#';",
    patched_js
)

# Patch sendChat() to a local stub
def replace_function_js(src, func_name, new_body):
    start = src.find(f"async function {func_name}(")
    if start == -1:
        return src  # nothing to do
    brace_start = src.find("{", start)
    if brace_start == -1:
        return src
    # Walk braces to find matching end
    depth = 0
    i = brace_start
    while i < len(src):
        c = src[i]
        if c == "{":
            depth += 1
        elif c == "}":
            depth -= 1
            if depth == 0:
                end = i
                break
        i += 1
    else:
        return src
    new_func = f"async function {func_name}" + new_body
    return src[:start] + new_func + src[end+1:]

patched_js = replace_function_js(
    patched_js,
    "sendChat",
    """(){
  const v=$('#chatInput').value.trim(); if(!v) return;
  appendChat('user',v); $('#chatInput').value='';
  appendChat('ai','(데모) 서버 API가 비활성화되어 채팅 기능을 사용할 수 없어요.');
}"""
)

# Patch doSearch() to open external search (no backend)
patched_js = replace_function_js(
    patched_js,
    "doSearch",
    """(preferNavigate=false){
  const q=$('#searchInput').value.replace(/\\u00A0/g,' ').trim();
  if(q.length<2) return showToast(L.msg.searchTooShort);
  addHistory(q);
  const url = 'https://duckduckgo.com/?q='+encodeURIComponent(q);
  openExternal(url);
}"""
)

# Patch detectLangByIP() to avoid ipapi call
patched_js = replace_function_js(
    patched_js,
    "detectLangByIP",
    """(){
  const nav=(navigator.language||'en').slice(0,2).toLowerCase();
  return ['ko','en','ja'].includes(nav)?nav:'en';
}"""
)

# Also hide/disable buttons that previously relied on APIs at runtime
extra_js = r"""
// ===== NO-API DEMO PATCHES =====
(function(){
  try{
    // Hide/disable API-related buttons
    const hide = (sel)=>{ const el=document.querySelector(sel); if(el){ el.style.display='none'; } };
    hide('#authBtn'); hide('#exportBtn'); hide('#recaptchaBtn');

    // Add small badge to title
    const h1 = document.getElementById('appTitle');
    if(h1 && !/Demo/.test(h1.textContent)) h1.textContent = h1.textContent + ' — Demo (No API)';
  }catch(e){}
})();
"""
patched_js += "\n" + extra_js + "\n"

# Write files
with open(os.path.join(assets_dir, "styles.css"), "w", encoding="utf-8") as f:
    f.write(css + "\n")

with open(os.path.join(assets_dir, "app.js"), "w", encoding="utf-8") as f:
    f.write(patched_js + "\n")

with open(os.path.join(root, "index.html"), "w", encoding="utf-8") as f:
    f.write(index_html)

manifest = {
    "name": "ThinkHelper 3.1 (Demo)",
    "short_name": "ThinkHelper",
    "display": "standalone",
    "start_url": ".",
    "background_color": "#ffffff",
    "theme_color": "#1976d2",
    "icons": []
}
with open(os.path.join(root, "manifest.json"), "w", encoding="utf-8") as f:
    json.dump(manifest, f, ensure_ascii=False, indent=2)

readme = textwrap.dedent("""
# ThinkHelper 3.1 — GitHub Pages **No-API** Demo

이 패키지는 공개 저장소에서 **Gemini/내 백엔드 API를 노출하지 않도록** 만들어진 데모 빌드입니다.
- Chat(서버 호출), 내부 `/api/*` 검색, Google 로그인/Drive 내보내기, ipapi 기반 위치 감지, GA/reCAPTCHA/결제 관련 스크립트는 제거/비활성화했습니다.
- 에디터, PII 마스킹, 로컬 저장(HTML/PDF), 다국어 UI 등은 그대로 동작합니다.

## 사용법
1. 이 폴더를 GitHub Pages로 배포하면 됩니다. (브랜치 `main`의 `/` 또는 `docs/`)
2. `index.html`의 CSP는 데모에 맞게 최소화되어 있습니다.
3. 다시 서버 API를 붙이고 싶다면 `assets/app.js`에서 아래만 되돌리면 됩니다.
   - `const API_ORIGIN = null; const NO_API = true;` → 원래 API 엔드포인트로
   - `sendChat`, `doSearch`, `detectLangByIP`의 데모 구현 → 원래 구현으로

## 보안 메모
- 이 빌드는 클라이언트에서 **어떠한 API 키도 포함하지 않습니다.**
- 공개 저장소에선 API 키/비밀을 절대 커밋하지 마세요. 필요 시 서버(Cloud Run/Functions 등)에서만 보관하고, 프런트는 **토큰 없는 공개 엔드포인트를 호출하지 않도록** 하세요.

즐 배포! 🚀
""").strip()
with open(os.path.join(root, "README.md"), "w", encoding="utf-8") as f:
    f.write(readme + "\n")

# Zip it
zip_path = "/mnt/data/thinkhelper-pages-noapi.zip"
with zipfile.ZipFile(zip_path, "w", compression=zipfile.ZIP_DEFLATED) as z:
    for folder_name, subfolders, filenames in os.walk(root):
        for filename in filenames:
            file_path = os.path.join(folder_name, filename)
            arcname = os.path.relpath(file_path, root)
            z.write(file_path, arcname)

zip_path
