<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="
        default-src 'self';
        script-src 'self' https://accounts.google.com https://www.gstatic.com https://cdn.ckeditor.com https://apis.google.com https://cdn.jsdelivr.net https://ipapi.co https://pay.google.com https://cdn.paddle.com https://www.googletagmanager.com https://www.google-analytics.com https://www.google.com 'unsafe-inline' 'unsafe-eval';
        frame-src https://accounts.google.com/gsi/ https://pay.google.com https://checkout.paddle.com https://*.paddle.com https://www.googletagmanager.com https://www.google.com;
        connect-src 'self' https://accounts.google.com/gsi/ https://ipapi.co https://api-w7dmw4n5zq-du.a.run.app https://www.googleapis.com https://oauth2.googleapis.com https://generativelanguage.googleapis.com https://pay.google.com https://api.paddle.com https://www.google-analytics.com https://region1.google-analytics.com https://www.google.com wss: ws:;
        style-src 'self' 'unsafe-inline' https://cdn.ckeditor.com;
        img-src 'self' data: https://*.paddle.com https://www.google-analytics.com;
        object-src 'none';
        "/>

  <meta http-equiv="Permissions-Policy" content="identity-credentials-get=()"/>

  <title>ThinkHelper 3.1</title>
  <link rel="icon" href="data:,"/>
  <link rel="manifest" href="manifest.json"/>

  <!-- Google reCAPTCHA Enterprise -->
  <script src="https://www.google.com/recaptcha/enterprise.js?render=6LdrQpwrAAAAAEfS6GhTaZwnTY5MpC69IEeRNDIT"></script>

  <!-- (ì˜µì…˜) ê²°ì œ ìŠ¤í¬ë¦½íŠ¸ -->
  <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
  <script src="https://cdn.paddle.com/paddle/v2/paddle.js" async></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Editor & sanitize -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js" async></script>

  <!-- OAuth/Gemini API Key -->
  <meta name="google-signin_client_id" content="609565568467-cmagnrdngsojg5q62ljf5gi8ljk7moac.apps.googleusercontent.com"/>
  <meta name="google-api-key" content="AIzaSyDaBLLoSo5zwFhl72L9R7VeQqa1eybwqKk"/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9PM41E1HFW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-9PM41E1HFW');
  </script>

  <style>
    :root{
      --primary:#1976d2; --primary-light:#e3f2fd; --primary-hover:#bbdefb;
      --bg:#f6f7fb; --fg:#262b33; --box:#fff; --border:#ccd3e0; --text-light:#fff;
      --sug-bg:#ffffff; --sug-hover:#eef4ff; --sug-text:#0f172a;
      --pill-bg:#ffe7e7; --pill-border:#f44336; --pill-dot:#b71c1c;
    }
    body.dark{
      --bg:#0f172a; --fg:#e2e8f0; --box:#0b1220; --border:#2a3550;
      --sug-bg:#0b1220; --sug-hover:#111a2e; --sug-text:#e2e8f0;
      --primary-light:#90CAF9; --primary-hover:#64B5F6;
      --pill-bg:#2a1111; --pill-border:#ef9a9a; --pill-dot:#ffb4b4;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;display:flex;flex-direction:column;font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--fg);transition:background .3s,color .3s}

    header{display:flex;justify-content:space-between;align-items:center;padding:.6rem .9rem;background:var(--primary);color:var(--text-light);position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,255,255,.2)}
    #logoWrap{display:flex;align-items:center;gap:.6rem}
    #logoWrap h1{font-size:1.05rem;font-weight:700}
    .toolbar{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
    .btn{padding:.34rem .72rem;border:none;border-radius:10px;background:var(--box);color:var(--primary);cursor:pointer;font-size:.9rem;transition:background .2s}
    .btn:hover{background:var(--primary-light)}
    .btn.tiny{padding:.24rem .5rem;font-size:.84rem}
    select{padding:.34rem;border:none;border-radius:10px;background:var(--box);color:var(--primary);font-size:.9rem}

    /* ë°ìŠ¤í¬íƒ‘: í–„ë²„ê±° ìˆ¨ê¹€ / ëª¨ë°”ì¼(â‰¤860px): í–„ë²„ê±° í‘œì‹œ */
    #sidebarToggle{display:none}
    @media (max-width:860px){
      #sidebarToggle{display:inline-flex}
      .toolbar> :not(#authBtn):not(#saveBtn):not(#helpBtn):not(#menuBtn):not(#recaptchaBtn){display:none !important}
      #menuBtn{display:inline-flex}
    }
    #menuBtn{display:none}

    .badge{display:inline-block;padding:.16rem .5rem;border-radius:999px;font-size:.78rem;background:rgba(255,255,255,.25);color:#fff}
    .badge.off{background:#d32f2f}

    main{flex:1;display:flex;min-height:0}
    aside{width:260px;background:var(--primary-light);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:auto}
    body.dark aside{background:#0f2334}
    @media (max-width:860px){
      aside{display:none}
      aside.open{display:flex;position:fixed;top:54px;bottom:0;left:0;z-index:250;width:80vw;max-width:320px}
    }
    aside h3{font-size:1rem;font-weight:700;padding:1rem .9rem;border-bottom:1px solid var(--border)}
    #docList,#chatList{list-style:none;font-size:.92rem}
    #docList li,#chatList li{display:flex;justify-content:space-between;align-items:center;padding:.6rem .85rem;border-bottom:1px dashed var(--border);cursor:pointer}
    #docList li small{opacity:.7}
    #docList li:hover,#chatList li:hover{background:var(--primary-hover)}
    #emptyCTA{padding:1rem .9rem;text-align:center;font-size:.88rem;color:#555}
    #newDocBtn{margin:.7rem; padding:.6rem 1rem;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer;font-size:.92rem}
    #newDocBtn:hover{background:#1565c0}

    section{flex:1;display:flex;flex-direction:column;padding:1rem;background:var(--box);min-width:0;position:relative}
    #editor{flex:1;border:1px solid var(--border);border-radius:12px;padding:1rem;overflow:auto;background:inherit;color:inherit}
    #editor:empty::before{content:attr(data-placeholder);color:#9aa3b2;font-style:italic}
    .ck-editor__editable_inline{min-height:58vh!important}
    .ck-content{color:inherit;background:inherit;font-size:1.02rem;line-height:1.7}
    .ck-content a{color:var(--primary-hover)} body.dark .ck-content a{color:#90caf9}
    #charCount{display:none}

    /* ì—ë””í„° Quick Actions (ë³µì‚¬ë§Œ) */
    #quickActions{display:flex;gap:.5rem;margin:.6rem 0 .2rem 0}
    #quickActions .btn{padding:.28rem .6rem;font-size:.85rem}

    #inlineSearch{display:flex;gap:.5rem;margin-top:1rem;position:relative}
    #inlineSearch input{flex:1;padding:.7rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:12px;background:inherit;color:inherit}
    #inlineSearch button{border-radius:12px}
    #inlineSearch input::placeholder{color:#8a93a3} body.dark #inlineSearch input::placeholder{color:#b8c1d4}

    /* ê²€ìƒ‰ ìë™ ì œì•ˆ */
    #searchSuggest{
      position:absolute; top:100%; left:0; right:0; margin-top:6px;
      background:var(--sug-bg); color:var(--sug-text); border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(0,0,0,.22);
      display:none; z-index:1200; max-height:280px; overflow:auto;
    }
    .search-sug-item{padding:.6rem .9rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;gap:.5rem;align-items:center}
    .search-sug-item:last-child{border-bottom:none}
    .search-sug-item:hover,.search-sug-item.selected{background:var(--sug-hover)}
    .search-sug-item .icon{opacity:.8}
    .search-sug-item .text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* ê²€ìƒ‰ ì§í–‰ ì œì•ˆ ë°°ë„ˆ */
    #searchJump{
      margin-top:8px; display:none; align-items:center; gap:.5rem;
      background:var(--sug-bg); color:var(--sug-text);
      border:1px solid var(--border); border-radius:12px; padding:8px 10px;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
    }
    #searchJump .label{font-weight:700}
    #searchJump .meta{opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:45%}
    @media (max-width:860px){ #searchJump .meta{max-width:55%} }

    /* ì…ë ¥ ì œì•ˆ(ì—ë””í„° ì¹©) */
    #suggestions{
      position:fixed;z-index:99999;max-height:240px;overflow:auto;min-width:260px;
      background:var(--sug-bg);border:1px solid var(--border);border-radius:12px;padding:.25rem 0;
      box-shadow:0 12px 28px rgba(0,0,0,.22);font-size:.96rem;display:none;-webkit-overflow-scrolling:touch;
    }
    .suggestion-item{padding:.55rem .9rem;border-bottom:1px dashed var(--border);cursor:pointer;color:var(--sug-text);white-space:nowrap}
    .suggestion-item:last-child{border-bottom:none}
    .suggestion-item:hover,.suggestion-item.selected{background:var(--sug-hover)}
    .suggestion-item.selected{outline:2px solid var(--primary)}

    /* PII pill */
    .ck-content .pii-pill{
      background:var(--pill-bg); border:1px dashed var(--pill-border);
      color:transparent; border-radius:999px; padding:0 .5em; user-select:none;
      box-decoration-break:clone;
    }
    .ck-content .pii-pill::after{content:"â€¢â€¢â€¢â€¢"; color:var(--pill-dot); letter-spacing:.12em;}

    /* ì €ì¥ ë©”ë‰´ */
    #saveMenu{position:fixed;display:none;z-index:1600;min-width:240px;background:var(--box);color:var(--fg);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.22)}
    #saveMenu button{display:block;width:100%;border:0;background:transparent;color:#0d1b2a;font-weight:700;font-size:.95rem;padding:.75rem 1rem;text-align:left;letter-spacing:.01em;border-bottom:1px dashed var(--border)}
    #saveMenu button:last-child{border-bottom:none}
    body.dark #saveMenu{background:#0b1220;border-color:#2a3550}
    body.dark #saveMenu button{color:#eaeef9}
    #saveMenu button:hover,#saveMenu button:focus{background:var(--primary);color:#fff}
    #saveMenu button:focus-visible{outline:3px solid var(--primary);outline-offset:2px}

    /* ê³µí†µ ëª¨ë‹¬ */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000}
    .modal .card{width:min(92vw,760px);max-height:85vh;overflow:auto;background:var(--box);color:var(--fg);border:1px solid var(--border);border-radius:12px;box-shadow:0 20px 48px rgba(0,0,0,.35)}
    .modal .card header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal .card .content{padding:14px 16px}
    .modal .close{border:none;background:transparent;font-size:20px;cursor:pointer;color:inherit}

    /* ë“œë¡œì–´(ëª¨ë°”ì¼) */
    #drawer{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:flex-end;z-index:1600}
    #drawer .sheet{width:min(92vw,380px);height:100%;background:var(--box);color:var(--fg);border-left:1px solid var(--border);padding:1rem;display:flex;flex-direction:column;gap:.8rem}
    #drawer .row{display:flex;gap:.5rem;align-items:center}
    #drawer .row select, #drawer .row button, #drawer .row input{flex:1}
    #helpInlineMobile{font-size:.92rem;line-height:1.6;border-top:1px solid var(--border);padding-top:.6rem}

    /* ìˆ¨ê¸¸ ìš”ì†Œë“¤ */
    .grecaptcha-badge,
    .site-error,
    .error,
    small[style*="color:red"],
    .ck.ck-notification__message{display:none !important;}
    footer#legal{font-size:.8rem;opacity:.7;padding:.6rem 1rem;background:transparent;color:inherit}

    /* Gemini Chat */
    #chatPanel{
      position:fixed; right:16px; bottom:16px; width:420px; height:520px;
      display:none; flex-direction:column;
      background:var(--box); color:var(--fg); border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(0,0,0,.22); z-index:1800;
    }
    #chatPanel.fullscreen{ left:0; right:0; top:54px; bottom:0; width:auto; height:auto; border-radius:0; }
    #chatHeader{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border); background:var(--primary-light)}
    #chatHeader .right{display:flex; gap:.4rem}
    #chatLog{flex:1; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:6px}
    .chatMsg{max-width:80%; padding:8px 10px; border-radius:12px; line-height:1.45}
    .chatMsg.user{align-self:flex-end; background:var(--primary-light)}
    .chatMsg.ai{align-self:flex-start; background:#eceff1}
    #chatInput{border:1px solid var(--border); border-radius:10px; padding:10px 12px; margin:10px}

    @media (max-width:860px){
      #chatPanel{ left:8px; right:8px; bottom:10px; width:auto; height:65vh; }
    }
  </style>
</head>
<body>
  <header>
    <div id="logoWrap">
      <button class="btn tiny" id="sidebarToggle" title="ì‚¬ì´ë“œë°”" aria-label="ì‚¬ì´ë“œë°”">â˜°</button>
      <h1 id="appTitle">ThinkHelper 3.1</h1>
    </div>
    <div class="toolbar">
      <span id="loginDisplay" style="color:#fff;margin-right:.2rem"></span>
      <span id="consentBadge" class="badge" title="ê°œì¸ì •ë³´ ë™ì˜ ìƒíƒœ"></span>
      <button class="btn" id="authBtn">Google ë¡œê·¸ì¸</button>

      <!-- ë°ìŠ¤í¬íƒ‘ ì–¸ì–´/ëª¨ë“œ -->
      <select id="languageSelect" aria-label="Language">
        <option value="ko">í•œêµ­ì–´</option>
        <option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option>
      </select>
      <select id="modeSelect" aria-label="Mode">
        <option value="basic">ğŸ›  Basic</option>
        <option value="journalist">ğŸ“° Journalist</option>
        <option value="research">ğŸ“‘ Research</option>
        <option value="law">âš–ï¸ Legal</option>
        <option value="dev">ğŸ’» Developer</option>
      </select>

      <button class="btn" id="saveBtn">ğŸ’¾ ì €ì¥</button>
      <button class="btn" id="chatBtn">ğŸ’¬ ì±„íŒ…</button>
      <button class="btn" id="themeBtn">ğŸŒ™ í…Œë§ˆ</button>
      <button class="btn" id="settingsBtn">âš™ï¸ ì„¤ì •</button>
      <button class="btn" id="helpBtn">â“ ë„ì›€ë§</button>
      <button class="btn" id="shareNaverBtn">ë„¤ì´ë²„ ë¸”ë¡œê·¸</button>
      <button class="btn" id="shareTwitterBtn">íŠ¸ìœ„í„°</button>
      <button class="btn g-recaptcha" id="recaptchaBtn"
        data-sitekey="6LdrQpwrAAAAAEfS6GhTaZwnTY5MpC69IEeRNDIT"
        data-callback="onSubmit"
        data-action="submit">reCAPTCHA</button>

      <!-- ëª¨ë°”ì¼ í–„ë²„ê±° -->
      <button class="btn" id="menuBtn" aria-label="ë©”ë‰´">â˜°</button>
    </div>

    <div id="saveMenu" role="menu" aria-label="Save options">
      <button id="saveMenuPdf">ğŸ–¨ï¸ <span>PDFë¡œ ì €ì¥</span></button>
      <button id="saveMenuDevice">ğŸ’¾ <span>ê¸°ê¸°ì— ì €ì¥í•˜ê¸°(HTML)</span></button>
      <button id="exportBtn">ğŸ“‚ <span>Driveë¡œ ë‚´ë³´ë‚´ê¸°(Google Docs)</span></button>
    </div>
  </header>

  <main>
    <aside id="sidebar">
      <h3 id="docListTitle">ë¬¸ì„œ ëª©ë¡</h3>
      <div id="emptyCTA" style="display:none">
        <span id="emptyText">ì•„ì§ ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</span><br/>
        <button id="newDocCTA" class="btn">+ ìƒˆ ë¬¸ì„œ</button>
      </div>
      <button class="btn" id="newDocBtn">â• ìƒˆ ë¬¸ì„œ</button>
      <ul id="docList"></ul>

      <h3 id="chatListTitle">ì±„íŒ… ê¸°ë¡</h3>
      <ul id="chatList"></ul>
    </aside>

    <section id="wrap">
      <!-- ì—ë””í„° Quick Actions (ë³µì‚¬ë§Œ) -->
      <div id="quickActions">
        <button class="btn tiny" id="copyBtn">ğŸ“‹ Copy (Ctrl/Cmd+C)</button>
      </div>

      <div id="editor" data-placeholder="ì—¬ê¸°ì— ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
      <div id="charCount">0 ì</div>

      <div id="inlineSearch">
        <input id="searchInput" placeholder="ê²€ìƒ‰ (/ ë˜ëŠ” Ctrl+K)" autocomplete="off"/>
        <button class="btn" id="searchBtn">ğŸ” <span id="searchBtnText">ê²€ìƒ‰</span></button>
        <div id="searchSuggest"></div>
        <!-- ê²€ìƒ‰ ì§í–‰ ì œì•ˆ ë°°ë„ˆ -->
        <div id="searchJump" role="region" aria-live="polite"></div>
      </div>

      <!-- ì…ë ¥ ì¤‘ ì˜ë„ ì œì•ˆ ì¹© -->
      <div id="suggestions"></div>
    </section>
  </main>

  <!-- í•˜ë‹¨ ê³ ì§€ë¬¸ -->
  <footer id="legal">
    This site is protected by reCAPTCHA and the Google
    <a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a> and
    <a href="https://policies.google.com/terms" target="_blank" rel="noopener">Terms of Service</a> apply.
  </footer>

  <!-- ëª¨ë°”ì¼/ì•„ì´íŒ¨ë“œ ë“œë¡œì–´ -->
  <div id="drawer" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="Quick Menu">
      <div class="row">
        <label style="min-width:88px" id="labelLang">Language</label>
        <select id="languageSelectMobile">
          <option value="ko">í•œêµ­ì–´</option>
          <option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option>
        </select>
      </div>
      <div class="row">
        <label style="min-width:88px" id="labelMode">Mode</label>
        <select id="modeSelectMobile">
          <option value="basic">ğŸ›  Basic</option>
          <option value="journalist">ğŸ“° Journalist</option>
          <option value="research">ğŸ“‘ Research</option>
          <option value="law">âš–ï¸ Legal</option>
          <option value="dev">ğŸ’» Developer</option>
        </select>
      </div>
      <div class="row">
        <button class="btn" id="themeBtnMobile">ğŸŒ™ í…Œë§ˆ</button>
        <button class="btn" id="settingsBtnMobile">âš™ï¸ ì„¤ì •</button>
      </div>
      <div class="row">
        <button class="btn" id="shareNaverBtnMobile">ë„¤ì´ë²„ ë¸”ë¡œê·¸</button>
        <button class="btn" id="shareTwitterBtnMobile">íŠ¸ìœ„í„°</button>
      </div>

      <!-- ëª¨ë°”ì¼ ë„ì›€ë§ ì¸ë¼ì¸ -->
      <div id="helpInlineMobile"></div>

      <button class="btn" id="drawerClose" style="margin-top:auto">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- reCAPTCHA ë°ëª¨ í¼(ìš”ì²­ ì½”ë“œ ìœ ì§€) -->
  <form id="demo-form" action="#" method="post" style="display:none"></form>

  <!-- ë™ì˜ ëª¨ë‹¬ -->
  <div id="consent" class="modal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
    <div class="card">
      <header>
        <h3 id="consentTitle">ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ì•ˆë‚´</h3>
        <button class="close" id="consentClose" aria-label="ë‹«ê¸°">âœ•</button>
      </header>
      <div class="content">
        <p id="consentBody" style="line-height:1.7;margin:.4rem 0">
          ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ ì—†ì´ë„ ë³¸ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ,
          <strong>ë¡œê·¸ì¸ ì‹œ ë° ë¬¸ì„œë¥¼ ì‘ì„±í•  ë•Œ</strong> ì‚¬ìš©ìê°€ ì‘ì„±í•˜ëŠ” ë‚´ìš© ì¤‘ ì¼ë¶€ëŠ” í’ˆì§ˆ ê°œì„ ê³¼ ê¸°ëŠ¥ ì œê³µì„ ìœ„í•´ ìˆ˜ì§‘ë  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.
          ë™ì˜ë¥¼ ê±°ë¶€í•˜ë”ë¼ë„ ì„œë¹„ìŠ¤ëŠ” ì´ìš© ê°€ëŠ¥í•˜ì§€ë§Œ,
          <strong>ì´ ê²½ìš° ì¶”ì²œ ì—ë””í„° ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”</strong>ë©ë‹ˆë‹¤.
        </p>
        <p style="margin:.4rem 0">
          <a id="privacyLink" href="https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing" target="_blank" rel="noopener">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ìì„¸íˆ ë³´ê¸°</a> Â·
          <a id="tosLink" href="https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing" target="_blank" rel="noopener">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ìì„¸íˆ ë³´ê¸°</a>
        </p>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:10px">
          <button class="btn" id="declineBtn" style="background:#eee">ê±°ë¶€</button>
          <button class="btn" id="agreeBtn" style="background:#1976d2;color:#fff">ë™ì˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë„ì›€ë§ ëª¨ë‹¬(ë°ìŠ¤í¬íƒ‘ìš©) -->
  <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="card">
      <header>
        <h3 id="helpTitle">ë„ì›€ë§</h3>
        <button class="close" data-close="#helpModal" aria-label="ë‹«ê¸°">âœ•</button>
      </header>
      <div class="content" id="helpContent"></div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="card">
      <header>
        <h3 id="settingsTitle">ì„¤ì •</h3>
        <button class="close" data-close="#settingsModal" aria-label="ë‹«ê¸°">âœ•</button>
      </header>
      <div class="content">
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="toggleSuggestions" id="labelSuggest">ì¶”ì²œ ì—ë””í„° ì‚¬ìš©</label>
          <input type="checkbox" id="toggleSuggestions"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="toggleInstant" id="labelInstant">ëª¨ë°”ì¼ ì¦‰ì‹œ ì œì•ˆ(ì €ì‚¬ì–‘ ë¹„í™œì„± ê¶Œì¥)</label>
          <input type="checkbox" id="toggleInstant"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="togglePdfMask" id="labelPdfMask">PDF ì €ì¥ ì‹œ ë§ˆìŠ¤í‚¹ ì ìš©</label>
          <input type="checkbox" id="togglePdfMask"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="togglePiiHighlight" id="labelPiiHighlight">ì—ë””í„°ì—ì„œ PII í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ</label>
          <input type="checkbox" id="togglePiiHighlight"/>
        </div>
        <hr style="margin:10px 0; border:none; border-top:1px solid var(--border)"/>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap">
          <button class="btn" id="reopenConsent">ê°œì¸ì •ë³´ ë™ì˜ ë‹¤ì‹œ ì„¤ì •</button>
          <button class="btn" id="toggleThemeInSettings">í…Œë§ˆ í† ê¸€</button>
        </div>
        <p style="margin-top:10px;font-size:.92rem;color:#555">
          â€¢ ë³µì‚¬ëŠ” ìƒë‹¨ <b>Copy</b> ë²„íŠ¼, <b>ë¶™ì—¬ë„£ê¸°</b>ëŠ” <code>Ctrl/âŒ˜+V</code>.<br/>
          â€¢ <b>ë˜ëŒë¦¬ê¸°/ë‹¤ì‹œí•˜ê¸°</b>: <code>Ctrl/âŒ˜+Z</code> / <code>Ctrl/âŒ˜+Shift+Z</code> ë˜ëŠ” <code>Ctrl/âŒ˜+Y</code>.<br/>
          â€¢ PDF ì €ì¥ ì‹œ PII ë§ˆìŠ¤í‚¹ì€ ìœ„ í† ê¸€ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  </div>

  <!-- Gemini Chat -->
  <div id="chatPanel" role="dialog" aria-label="Gemini Chat">
    <div id="chatHeader">
      <span id="chatTitle">ğŸ’¬ Gemini Chat</span>
      <div class="right">
        <button class="btn tiny" id="chatFullscreenToggle">â¤¢ Full</button>
        <button class="btn tiny" id="chatClose">Close</button>
      </div>
    </div>
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Enterë¡œ ì „ì†¡" aria-label="Chat Input"/>
  </div>

  <script>
    /* ===== i18n (ko/en/ja ì§€ì›) ===== */
    const I18N = {
      ko: {
        ui: {
          authLogin:'Google ë¡œê·¸ì¸',authLogout:'ë¡œê·¸ì•„ì›ƒ',
          save:'ì €ì¥',chat:'ì±„íŒ…',theme:'í…Œë§ˆ',settings:'ì„¤ì •',help:'ë„ì›€ë§',
          naver:'ë„¤ì´ë²„ ë¸”ë¡œê·¸',twitter:'íŠ¸ìœ„í„°',
          documents:'ë¬¸ì„œ ëª©ë¡',chats:'ì±„íŒ… ê¸°ë¡',
          newDoc:'â• ìƒˆ ë¬¸ì„œ',newDocCTA:'+ ìƒˆ ë¬¸ì„œ',empty:'ì•„ì§ ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.',
          searchPH:'ê²€ìƒ‰ (/ ë˜ëŠ” Ctrl+K)',searchBtn:'ê²€ìƒ‰',
          savePdf:'PDFë¡œ ì €ì¥',saveHtml:'ê¸°ê¸°ì— ì €ì¥í•˜ê¸°(HTML)',exportDrive:'Driveë¡œ ë‚´ë³´ë‚´ê¸°(Google Docs)',
          drawerClose:'ë‹«ê¸°',drawerLang:'Language',drawerMode:'Mode',
          consentTitle:'ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ì•ˆë‚´',
          consentBody:'You can use the service without signing in. ...',
          privacy:'ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ìì„¸íˆ ë³´ê¸°',tos:'ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ìì„¸íˆ ë³´ê¸°',
          agree:'ë™ì˜',decline:'ê±°ë¶€',badgeOn:'ì¶”ì²œ ON',badgeOff:'ì¶”ì²œ OFF',badgeWait:'ë™ì˜ ëŒ€ê¸°',
          helpTitle:'ë„ì›€ë§',
          helpHtml:'<ul style="line-height:1.8;margin-left:1rem"><li>ë¬¸ì„œ ì‘ì„±Â·ìš”ì•½</li><li>ì›¹ ê²€ìƒ‰ ê²°ê³¼ ì‚½ì…</li><li>PII ë§ˆìŠ¤í‚¹</li><li>ë³µì‚¬ ë²„íŠ¼ / ë¶™ì—¬ë„£ê¸° ë‹¨ì¶•í‚¤</li></ul>',
          settingsTitle:'ì„¤ì •',
          labelSuggest:'ì¶”ì²œ ì—ë””í„° ì‚¬ìš©',
          labelInstant:'ëª¨ë°”ì¼ ì¦‰ì‹œ ì œì•ˆ',
          labelPdfMask:'PDF ì €ì¥ ì‹œ ë§ˆìŠ¤í‚¹ ì ìš©',
          labelPiiHighlight:'ì—ë””í„°ì—ì„œ PII í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ',
          reopenConsent:'ê°œì¸ì •ë³´ ë™ì˜ ë‹¤ì‹œ ì„¤ì •',toggleTheme:'í…Œë§ˆ í† ê¸€',
          chatTitle:'ğŸ’¬ Gemini Chat',chatFull:'â¤¢ Full',chatClose:'Close',chatPH:'Enterë¡œ ì „ì†¡',
          jumpFirst:'ì²« ê²°ê³¼',jumpOpen:'ë°”ë¡œ ì´ë™',jumpInsert:'ì—ë””í„°ì— ì‚½ì…'
        },
        msg:{
          insertDone:'ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.',
          searchTooShort:'ê²€ìƒ‰ì–´ë¥¼ 2ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.',
          noResults:'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.',
          searchOK:'ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê°€ì ¸ì™”ì–´ìš”.',
          searchErr:'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.',
          newDoc:'ìƒˆ ë¬¸ì„œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.',
          loginOK:'ë¡œê·¸ì¸ ì„±ê³µ',loginFail:'ë¡œê·¸ì¸ ì‹¤íŒ¨',needLogin:'ë¨¼ì € ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.',logoutOK:'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.',
          pdfFail:'PDF ì €ì¥ ì‹¤íŒ¨',pdfOK:'âœ… PDFë¡œ ì €ì¥í–ˆì–´ìš”',fileOK:'âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í–ˆì–´ìš”',
          exportFail:'ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨',exportOK:'âœ… Driveë¡œ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ',
          cloudLoaded:'â˜ï¸ í´ë¼ìš°ë“œ ì´ˆì•ˆì„ ë¶ˆëŸ¬ì™”ì–´ìš”.',docLoaded:'ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì™”ì–´ìš”.',
          consentSaved:'ë™ì˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',consentOff:'ì¶”ì²œ ì—ë””í„°ê°€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.',
          attachOK:'ì²¨ë¶€ë¥¼ ì‚½ì…í–ˆì–´ìš”.',popupBlocked:'íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”!'
        }
      },
      en: {
        ui: {
          authLogin:'Sign in with Google',authLogout:'Sign out',
          save:'Save',chat:'Chat',theme:'Theme',settings:'Settings',help:'Help',
          naver:'Naver Blog',twitter:'Twitter',
          documents:'Documents',chats:'Chat History',
          newDoc:'â• New document',newDocCTA:'+ New document',empty:'No documents yet.',
          searchPH:'Search (/ or Ctrl+K)',searchBtn:'Search',
          savePdf:'Save as PDF',saveHtml:'Save to device (HTML)',exportDrive:'Export to Drive (Google Docs)',
          drawerClose:'Close',drawerLang:'Language',drawerMode:'Mode',
          consentTitle:'Privacy Notice',
          consentBody:'You can use the service without signing in. ...',
          privacy:'View Privacy Policy',tos:'View Terms of Service',
          agree:'Agree',decline:'Decline',badgeOn:'Suggest ON',badgeOff:'Suggest OFF',badgeWait:'Pending',
          helpTitle:'Help',
          helpHtml:'<ul style="line-height:1.8;margin-left:1rem"><li>Draft & summarize</li><li>Insert web results</li><li>PII masking</li><li>Copy button / paste shortcut</li></ul>',
          settingsTitle:'Settings',
          labelSuggest:'Use suggestion editor',
          labelInstant:'Instant suggestions (mobile)',
          labelPdfMask:'Apply masking when saving PDF',
          labelPiiHighlight:'Show PII highlight in editor',
          reopenConsent:'Review privacy consent',toggleTheme:'Toggle theme',
          chatTitle:'ğŸ’¬ Gemini Chat',chatFull:'â¤¢ Full',chatClose:'Close',chatPH:'Press Enter to send',
          jumpFirst:'Top result',jumpOpen:'Open now',jumpInsert:'Insert to editor'
        },
        msg:{
          insertDone:'Inserted.',
          searchTooShort:'Type at least 2 characters.',
          noResults:'No results.',
          searchOK:'Inserted a search result.',
          searchErr:'Search failed.',
          newDoc:'Starting a new document.',
          loginOK:'Signed in.',loginFail:'Failed to handle sign-in.',needLogin:'Please sign in first.',logoutOK:'Signed out.',
          pdfFail:'Failed to create PDF â€” please try again.',pdfOK:'âœ… Saved as PDF',fileOK:'âœ… Started downloading the file',
          exportFail:'Export failed â€” please try again.',exportOK:'âœ… Exported to Google Docs',
          cloudLoaded:'â˜ï¸ Loaded your cloud draft.',docLoaded:'Loaded the document.',
          consentSaved:'Consent saved.',consentOff:'Suggestion editor will be disabled.',
          attachOK:'Attachment inserted.',popupBlocked:'Popup blocked; copied the link instead!'
        }
      },
      ja: {
        ui: {
          authLogin:'Googleã§ãƒ­ã‚°ã‚¤ãƒ³',authLogout:'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
          save:'ä¿å­˜',chat:'ãƒãƒ£ãƒƒãƒˆ',theme:'ãƒ†ãƒ¼ãƒ',settings:'è¨­å®š',help:'ãƒ˜ãƒ«ãƒ—',
          naver:'ãƒã‚¤ãƒãƒ¼ãƒ–ãƒ­ã‚°',twitter:'X(æ—§Twitter)',
          documents:'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',chats:'ãƒãƒ£ãƒƒãƒˆå±¥æ­´',
          newDoc:'â• æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',newDocCTA:'+ æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',empty:'ã¾ã ä¿å­˜ã•ã‚ŒãŸæ–‡æ›¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚',
          searchPH:'æ¤œç´¢ (/ ã¾ãŸã¯ Ctrl+K)',searchBtn:'æ¤œç´¢',
          savePdf:'PDFã§ä¿å­˜',saveHtml:'ç«¯æœ«ã«ä¿å­˜(HTML)',exportDrive:'Driveã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(Google Docs)',
          drawerClose:'é–‰ã˜ã‚‹',drawerLang:'Language',drawerMode:'Mode',
          consentTitle:'å€‹äººæƒ…å ±ã®å–æ‰±ã„',
          consentBody:'ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãªã—ã§ã‚‚åˆ©ç”¨ã§ãã¾ã™ãŒâ€¦',
          privacy:'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼',tos:'åˆ©ç”¨è¦ç´„',
          agree:'åŒæ„',decline:'æ‹’å¦',badgeOn:'ææ¡ˆ ON',badgeOff:'ææ¡ˆ OFF',badgeWait:'ä¿ç•™',
          helpTitle:'ãƒ˜ãƒ«ãƒ—',
          helpHtml:'<ul style="line-height:1.8;margin-left:1rem"><li>ä¸‹æ›¸ãï¼†è¦ç´„</li><li>ã‚¦ã‚§ãƒ–çµæœã®æŒ¿å…¥</li><li>PIIãƒã‚¹ã‚­ãƒ³ã‚°</li><li>ã‚³ãƒ”ãƒ¼/ãƒšãƒ¼ã‚¹ãƒˆã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</li></ul>',
          settingsTitle:'è¨­å®š',
          labelSuggest:'ææ¡ˆã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½¿ç”¨',
          labelInstant:'ãƒ¢ãƒã‚¤ãƒ«å³æ™‚ææ¡ˆ',
          labelPdfMask:'PDFä¿å­˜æ™‚ã«ãƒã‚¹ã‚­ãƒ³ã‚°',
          labelPiiHighlight:'ã‚¨ãƒ‡ã‚£ã‚¿ã§PIIã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ',
          reopenConsent:'åŒæ„ã‚’å†è¨­å®š',toggleTheme:'ãƒ†ãƒ¼ãƒåˆ‡æ›¿',
          chatTitle:'ğŸ’¬ Gemini ãƒãƒ£ãƒƒãƒˆ',chatFull:'â¤¢ å…¨ç”»é¢',chatClose:'é–‰ã˜ã‚‹',chatPH:'Enterã§é€ä¿¡',
          jumpFirst:'ä¸Šä½çµæœ',jumpOpen:'ä»Šã™ãé–‹ã',jumpInsert:'ã‚¨ãƒ‡ã‚£ã‚¿ã«æŒ¿å…¥'
        },
        msg:{
          insertDone:'æŒ¿å…¥ã—ã¾ã—ãŸã€‚',
          searchTooShort:'2æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',
          noResults:'çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚',
          searchOK:'æ¤œç´¢çµæœã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚',
          searchErr:'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',
          newDoc:'æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚',
          loginOK:'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ',loginFail:'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—',needLogin:'å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚',logoutOK:'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚',
          pdfFail:'PDFã®ä½œæˆã«å¤±æ•—',pdfOK:'âœ… PDFã§ä¿å­˜ã—ã¾ã—ãŸ',fileOK:'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ',
          exportFail:'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—',exportOK:'âœ… Google Docsã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†',
          cloudLoaded:'â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚',docLoaded:'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚',
          consentSaved:'åŒæ„ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚',consentOff:'ææ¡ˆã‚¨ãƒ‡ã‚£ã‚¿ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚',
          attachOK:'æ·»ä»˜ã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚',popupBlocked:'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'
        }
      }
    };

    /* ===== Helpers & Config ===== */
    const API_ORIGIN = 'https://api-w7dmw4n5zq-du.a.run.app';
    const apiUrl = (p='') => `${API_ORIGIN}/api/${String(p).replace(/^\/+/,'')}`;
    const $ = id => document.querySelector(id.startsWith('#')?id:('#'+id));

    // HTML -> Plain text
    const htmlToText = (html='')=>{
      const tmp=document.createElement('div'); tmp.innerHTML=html;
      const t=(tmp.textContent||'').replace(/\u00A0/g,' ');
      return t.replace(/\s+/g,' ').trim();
    };

    // ì‘ì€ ë¹¨ê°„ ì—ëŸ¬ í…ìŠ¤íŠ¸ ì œê±°
    function hideSmallRedHints(){
      document.querySelectorAll('small[style*="color:red"]').forEach(n=>n.remove());
    }

    // i18n ì ìš©
    let uiLang = localStorage.getItem('lang') || 'ko';
    let L = I18N[uiLang] || I18N.ko;
    function applyLang(lang){
      uiLang = ['ko','en','ja'].includes(lang)?lang:'ko';
      L = I18N[uiLang] || I18N.ko;

      $('#saveBtn').textContent = 'ğŸ’¾ '+L.ui.save;
      $('#chatBtn').textContent = 'ğŸ’¬ '+L.ui.chat;
      $('#themeBtn').textContent = 'ğŸŒ™ '+L.ui.theme;
      $('#settingsBtn').textContent = 'âš™ï¸ '+L.ui.settings;
      $('#helpBtn').textContent = 'â“ '+L.ui.help;
      $('#shareNaverBtn').textContent = L.ui.naver;
      $('#shareTwitterBtn').textContent = L.ui.twitter;
      $('#docListTitle').textContent = L.ui.documents;
      $('#chatListTitle').textContent = L.ui.chats;
      $('#newDocBtn').textContent = L.ui.newDoc;
      if($('#newDocCTA')) $('#newDocCTA').textContent = L.ui.newDocCTA;
      $('#emptyText').textContent = L.ui.empty;
      $('#searchInput').placeholder = L.ui.searchPH;
      $('#searchBtnText').textContent = L.ui.searchBtn;
      $('#saveMenuPdf span').textContent = L.ui.savePdf;
      $('#saveMenuDevice span').textContent = L.ui.saveHtml;
      $('#exportBtn span').textContent = L.ui.exportDrive;
      $('#labelLang').textContent = L.ui.drawerLang;
      $('#labelMode').textContent = L.ui.drawerMode;
      $('#themeBtnMobile').textContent = 'ğŸŒ™ '+L.ui.theme;
      $('#settingsBtnMobile').textContent = 'âš™ï¸ '+L.ui.settings;
      $('#shareNaverBtnMobile').textContent = L.ui.naver;
      $('#shareTwitterBtnMobile').textContent = L.ui.twitter;
      $('#drawerClose').textContent = L.ui.drawerClose;
      $('#helpTitle').textContent = L.ui.helpTitle;
      $('#helpContent').innerHTML = L.ui.helpHtml;
      const helpInline = $('#helpInlineMobile');
      if(helpInline){ helpInline.innerHTML = `<h3 style="margin:.2rem 0 .4rem 0">${L.ui.helpTitle}</h3>` + (L.ui.helpHtml||''); }
      $('#settingsTitle').textContent = L.ui.settingsTitle;
      $('#labelSuggest').textContent = L.ui.labelSuggest;
      $('#labelInstant').textContent = L.ui.labelInstant;
      $('#reopenConsent').textContent = L.ui.reopenConsent;
      $('#toggleThemeInSettings').textContent = L.ui.toggleTheme;

      $('#chatTitle').textContent = L.ui.chatTitle;
      $('#chatFullscreenToggle').textContent = L.ui.chatFull;
      $('#chatClose').textContent = L.ui.chatClose;
      $('#chatInput').placeholder = L.ui.chatPH;

      localStorage.setItem('lang', uiLang);
      if($('#languageSelect')) $('#languageSelect').value = uiLang;
      if($('#languageSelectMobile')) $('#languageSelectMobile').value = uiLang;

      // ê²€ìƒ‰ ì§í–‰ ë°°ë„ˆ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•  ìˆ˜ ìˆìœ¼ë‹ˆ ìˆ¨ê¹€ë§Œ ì²˜ë¦¬
      $('#searchJump').style.display='none';
    }

    /* ===== State ===== */
    let editor;
    let isLoggedIn=false, userProfile=null;
    let tokenClient=null, accessToken=null, tokenExpiresAt=0;
    let piiLockActive=false;
    let cloudDraftFileId=null;

    const CLIENT_ID = (document.querySelector('meta[name="google-signin_client_id"]')?.content || '');
    const OAUTH_SCOPES = [
      'openid',
      'https://www.googleapis.com/auth/userinfo.email',
      'https://www.googleapis.com/auth/userinfo.profile',
      'https://www.googleapis.com/auth/drive.file',
      'https://www.googleapis.com/auth/drive.appdata'
    ].join(' ');

    /* ===== Theme ===== */
    function applyTimeTheme(){ const h=new Date().getHours(); document.body.classList.toggle('dark',(h>=18||h<6)); }
    applyTimeTheme(); setInterval(applyTimeTheme,5*60*1000);
    $('#themeBtn').onclick = ()=> document.body.classList.toggle('dark');
    $('#themeBtnMobile').onclick = ()=> document.body.classList.toggle('dark');

    /* ===== Sidebar toggle (ëª¨ë°”ì¼) ===== */
    $('#sidebarToggle').onclick = ()=> $('#sidebar').classList.toggle('open');

    /* ===== Drawer (ëª¨ë°”ì¼ í–„ë²„ê±°) ===== */
    const drawer = $('#drawer');
    $('#menuBtn').onclick = ()=>{ drawer.style.display='flex'; drawer.setAttribute('aria-hidden','false'); };
    $('#drawerClose').onclick = ()=>{ drawer.style.display='none'; drawer.setAttribute('aria-hidden','true'); };
    drawer.addEventListener('click', (e)=>{ if(e.target===drawer){ drawer.style.display='none'; drawer.setAttribute('aria-hidden','true'); } });

    /* ===== Toast ===== */
    function showToast(text,ms=2300){
      const t=document.createElement('div'); t.className='toast'; t.textContent=text;
      Object.assign(t.style,{position:'fixed',left:'50%',transform:'translateX(-50%)',bottom:'18px',background:'#333',color:'#fff',padding:'.6rem .9rem',borderRadius:'8px',zIndex:3000});
      document.body.appendChild(t);
      setTimeout(()=>{t.style.opacity='0'; t.style.transition='opacity .25s';}, ms-250);
      setTimeout(()=>t.remove(), ms);
    }

    /* ===== Local docs ===== */
    const LOCAL_DOCS_KEY='thinkhelper:localDocs:v1';
    const DRAFT_KEY='thinkhelper:editorDraft:v1';
    const loadLocalDocs=()=>{try{return JSON.parse(localStorage.getItem(LOCAL_DOCS_KEY)||'[]');}catch(e){return[];}};
    const saveLocalDocs=(l)=>{try{localStorage.setItem(LOCAL_DOCS_KEY,JSON.stringify(l));}catch(e){}};
    function addLocalDoc(title, html){
      const list=loadLocalDocs();
      list.unshift({id:'local-'+Date.now(), title, html, updatedAt:Date.now()});
      saveLocalDocs(list); renderDocList(); return list[0];
    }
    function renderDocList(cloudMeta=null){
      const ul=$('#docList'); ul.innerHTML='';
      const safe = window.DOMPurify?.sanitize || (x=>x);
      if(cloudMeta){
        const li=document.createElement('li');
        li.innerHTML=`<span>â˜ï¸ ${safe(cloudMeta.title||'Cloud Draft')}</span><small>${new Date(cloudMeta.updatedAt||Date.now()).toLocaleString()}</small>`;
        li.onclick=()=>{ if(cloudMeta.html){ editor.setData(cloudMeta.html); showToast(L.msg.cloudLoaded); } };
        ul.appendChild(li);
      }
      const list=loadLocalDocs();
      if(!cloudMeta && list.length===0 && ul.children.length===0) $('#emptyCTA').style.display='block';
      else $('#emptyCTA').style.display='none';
      list.forEach(d=>{
        const li=document.createElement('li');
        li.innerHTML=`<span>ğŸ’¾ ${safe(d.title)}</span><small>${new Date(d.updatedAt).toLocaleString()}</small>`;
        li.onclick=()=>{ editor.setData(d.html||''); showToast(L.msg.docLoaded); };
        ul.appendChild(li);
      });
    }

    /* ===== Share ===== */
    function openPopup(u){
      const w=600,h=640,y=(window.outerHeight/2+window.screenY-h/2),x=(window.outerWidth/2+window.screenX-w/2);
      const win=window.open(u,'_blank',`noopener,width=${w},height=${h},left=${x},top=${y}`);
      if(!win && navigator.clipboard?.writeText){ navigator.clipboard.writeText(u).then(()=> showToast(L.msg.popupBlocked)); }
    }
    function openExternal(u){
      const win=window.open(u,'_blank','noopener');
      if(!win && navigator.clipboard?.writeText){ navigator.clipboard.writeText(u).then(()=> showToast(L.msg.popupBlocked)); }
    }
    function getSharePayload(){
      const html=editor?.getData?.()||'';
      const text=htmlToText(html);
      return { title: text.slice(0,80)||'ThinkHelper', url: location.href };
    }
    function bindShare(btn, builder){
      if(btn) btn.onclick = ()=>{ const p=getSharePayload(); openPopup(builder(p.title,p.url)); };
    }
    bindShare($('#shareNaverBtn'),(t,u)=>`https://share.naver.com/web/shareView?url=${encodeURIComponent(u)}&title=${encodeURIComponent(t)}`);
    bindShare($('#shareTwitterBtn'),(t,u)=>`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(u)}`);
    bindShare($('#shareNaverBtnMobile'),(t,u)=>`https://share.naver.com/web/shareView?url=${encodeURIComponent(u)}&title=${encodeURIComponent(t)}`);
    bindShare($('#shareTwitterBtnMobile'),(t,u)=>`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(u)}`);

    /* ===== CKEditor Upload ===== */
    const fileToDataURL=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});
    class Base64UploadAdapter{ constructor(loader){this.loader=loader;} async upload(){const f=await this.loader.file;if(f.size>5*1024*1024) throw new Error('ì´ë¯¸ì§€ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤.(ìµœëŒ€ 5MB)'); return {default: await fileToDataURL(f)};} abort(){} }

    /* ===== PII detection ===== */
    const PII_PATTERNS = [
      {type:'rrn',     rx:/\b\d{6}[- ]?\d{7}\b/g},
      {type:'card',    rx:/\b(?:\d{4}[- ]?){3}\d{4}\b/g},
      {type:'dl',      rx:/\b\d{2}-\d{2}-\d{6}-\d{2}\b/g},
      {type:'passport',rx:/\b[A-Z]{1}\d{7,8}\b/g},
      {type:'phone',   rx:/\b(?:01[016789]|0\d{1,2})[- ]?\d{3,4}[- ]?\d{4}\b/g},
      {type:'email',   rx:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g},
      {type:'acct',    rx:/\b\d{2,6}(?:-\d{2,6}){1,3}\b/g},
      {type:'addr',    rx:/(?:[ê°€-í£]{2,10}(ì‹œ|êµ°|êµ¬))\s?.{0,20}?\d{1,4}(?:-\d{1,3})?\b/g}
    ];
    const NAME_WITH_CUE = /(?:ì´ë¦„|ì„±í•¨|Name)\s*[:ï¼š]?\s*([ê°€-í£]{2,4}|[A-Z][a-z]+(?:\s[A-Z][a-z]+)+)/u;
    function findPIIMatches(text){
      const m=[];
      for(const o of PII_PATTERNS){
        o.rx.lastIndex=0; let r; while((r=o.rx.exec(text))!==null){ m.push({start:r.index,end:r.index+r[0].length,type:o.type}); }
      }
      const nm = NAME_WITH_CUE.exec(text); if(nm) m.push({start:nm.index,end:nm.index+nm[0].length,type:'name'});
      m.sort((a,b)=> a.start===b.start? b.end-a.end : a.start-b.start);
      const out=[]; let last=-1;
      for(const x of m){ if(x.start>=last){ out.push(x); last=x.end; } } return out;
    }

    /* ===== Suggestions (íƒ€ì´í•‘) ===== */
    let enableSuggestions = (localStorage.getItem('enableSuggestions')!=='false');
    let enableInstant = (localStorage.getItem('enableInstant')!=='false');
    const STOP_WORDS = new Set(['nbsp','amp','lt','gt','quot','apos','copy','reg','deg','ndash','mdash','â„¢','Â®','Â©','Â·','â€¢','â€”','â€“','...','â€¦','&nbsp;','',' ']);

    const getLangByContent=s=>/[ê°€-í£]/.test(s)?'ko':'en';
    const arraysEqual=(a,b)=>a.length===b.length&&a.every((v,i)=>v===b[i]);

    function lastWordFromSelection(){
      const sel=window.getSelection();
      if(!sel || !sel.anchorNode) return '';
      let s = (sel.anchorNode.textContent || '').slice(0, sel.anchorOffset || undefined);
      s = s.replace(/\u00A0/g,' ');
      const parts = s.trim().split(/\s+/);
      let w = (parts[parts.length-1]||'').replace(/[^\p{L}\p{N}_-]+/gu,'').toLowerCase();
      if(STOP_WORDS.has(w) || w.length<2) return '';
      return w;
    }
    function buildQuickPrompts(word){
      if(!enableSuggestions||!word) return [];
      const lang=uiLang || getLangByContent(word);
      const base = lang==='ko'
        ? [`${word}ì€(ëŠ”) ë¬´ì—‡?`,`${word} í•µì‹¬ 3ê°€ì§€`,`${word} ì˜ˆì‹œ`,`${word} ì¥ë‹¨ì `,`${word} ì‰½ê²Œ ì„¤ëª…`]
        : lang==='ja'
        ? [`${word}ã¨ã¯ï¼Ÿ`,`${word} ã®è¦ç‚¹3ã¤`,`${word} ã®ä¾‹`,`${word} ã®é•·æ‰€/çŸ­æ‰€`,`${word} ã‚’ã‚„ã•ã—ãèª¬æ˜`]
        : [`What is ${word}?`,`${word}: 3 key points`,`Examples of ${word}`,`${word} pros & cons`,`Explain ${word} simply`];
      return base;
    }

    let suggestionIndex=-1, currentSuggestions=[];
    function positionSuggestions(){
      const el=$('#suggestions'); if(!el) return;
      const r=window.getSelection()?.getRangeAt(0)?.getClientRects?.()[0];
      const rect = r || $('#editor').getBoundingClientRect();
      el.style.left = Math.max(8,(r?rect.left:rect.left+12))+'px';
      el.style.top  = ((r?rect.bottom:rect.top+48)+6)+'px';
    }
    function renderSuggestions(list){
      const el=$('#suggestions');
      if(!list.length){ el.style.display='none'; suggestionIndex=-1; currentSuggestions=[]; return; }
      const safe = window.DOMPurify?.sanitize || (x=>x);
      el.innerHTML=list.map((t,i)=>`<div class="suggestion-item" data-i="${i}">${safe(t)}</div>`).join('');
      el.querySelectorAll('.suggestion-item').forEach(n=> n.onclick=()=>{ insertAtCursorText(list[+n.dataset.i]); el.style.display='none'; });
      currentSuggestions=list; suggestionIndex=0; highlightSuggestion(); el.style.display='block'; requestAnimationFrame(positionSuggestions);
    }
    function highlightSuggestion(){ document.querySelectorAll('#suggestions .suggestion-item').forEach((n,i)=> n.classList.toggle('selected',i===suggestionIndex)); }
    function insertAtCursorText(text){
      if(!editor||!text) return;
      editor.model.change(w=>{ const node=w.createText(text+' '); editor.model.insertContent(node, editor.model.document.selection); });
      showToast(L.msg.insertDone,900);
    }
    function showSuggestionsImmediate(){
      if(piiLockActive) return;
      const w=lastWordFromSelection();
      const list = buildQuickPrompts(w).filter(s=>!/[^\S\r\n]/.test(s.replace(/&nbsp;/g,'')));
      renderSuggestions(list);
    }
    const deb=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
    const showSuggestionsDebounced = deb(showSuggestionsImmediate, 160);

    document.addEventListener('keydown',function(e){
      const el=$('#suggestions'); const visible=el&&el.style.display==='block'; if(!visible||!currentSuggestions.length) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); suggestionIndex=(suggestionIndex+1)%currentSuggestions.length; highlightSuggestion(); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); suggestionIndex=(suggestionIndex-1+currentSuggestions.length)%currentSuggestions.length; highlightSuggestion(); }
      else if(e.key==='Tab' && !e.ctrlKey && !e.metaKey){ e.preventDefault(); const idx=suggestionIndex>=0?suggestionIndex:0; insertAtCursorText(currentSuggestions[idx]); el.style.display='none'; }
      else if(e.key==='Escape'){ el.style.display='none'; }
    });

    /* ===== Copy only ===== */
    async function copySelection(){
      try{
        const sel = window.getSelection();
        const text = sel && sel.toString ? sel.toString() : '';
        if(text){
          await navigator.clipboard?.writeText(text);
          showToast('âœ… Copied'); return;
        }
      }catch(e){}
      try{
        const tmp=document.createElement('textarea'); tmp.style.position='fixed'; tmp.style.opacity='0';
        tmp.value = htmlToText(editor?.getData?.()||'');
        document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); tmp.remove();
        showToast('âœ… Copied');
      }catch(e){ showToast('Copy failed'); }
    }
    $('#copyBtn').onclick = copySelection;

    /* ===== Editor init ===== */
    (async function initEditor(){
      const ed = await ClassicEditor.create($('#editor'), { extraPlugins: [] });
      ed.plugins.get('FileRepository').createUploadAdapter = function(loader){ return new Base64UploadAdapter(loader); };
      editor = ed;

      // Attribute for PII mask
      editor.model.schema.extend('$text', { allowAttributes: ['piiType'] });
      editor.conversion.for('downcast').attributeToElement({
        model:'piiType',
        view:(val,api)=> api.writer.createAttributeElement('span',{class:'pii-pill','data-type':val},{priority:5})
      });
      editor.conversion.for('dataDowncast').attributeToElement({
        model:'piiType',
        view:(val,api)=> api.writer.createAttributeElement('span',{class:'pii-pill','data-type':val},{priority:5})
      });

      // Draft load
      try{ const saved=localStorage.getItem(DRAFT_KEY); if(saved && !editor.getData()) editor.setData(saved); }catch(e){}

      // FIX: CKEditorError getShiftedBy â€” use previousPosition as base
      const scanPII = function(){
        editor.model.change(function(writer){
          const root=editor.model.document.getRoot();
          writer.removeAttribute('piiType', editor.model.createRangeIn(root));
          const walker=editor.model.createRangeIn(root).getWalker({ignoreElementEnd:true});
          for(const step of walker){
            if(!step.item.is('textProxy')) continue;
            const base = step.previousPosition;
            const data = step.item.data||''; if(!data.trim()||!base) continue;
            const matches=findPIIMatches(data);
            for(const m of matches){
              const s=base.getShiftedBy(m.start), e=base.getShiftedBy(m.end);
              writer.setAttribute('piiType', m.type, writer.createRange(s,e));
            }
          }
        });
        const sel = editor.model.document.selection;
        piiLockActive = !!sel.getAttribute('piiType');
        if(piiLockActive) $('#suggestions').style.display='none';
      };

      const saveDraft = deb(function(){
        try{ localStorage.setItem(DRAFT_KEY, editor.getData()||''); }catch(e){}
        saveCloudDraftDebounced();
      }, 500);

      const onChanged=function(){
        scanPII();
        if(enableInstant && window.innerWidth<=430) showSuggestionsImmediate();
        else showSuggestionsDebounced();
        saveDraft();
      };
      ed.model.document.on('change:data', onChanged);
      ed.model.document.selection.on('change:range', function(){
        const sel = editor.model.document.selection;
        piiLockActive = !!sel.getAttribute('piiType');
        if(!piiLockActive) showSuggestionsDebounced(); else $('#suggestions').style.display='none';
      });

      const el = ed.ui.view.editable.element;
      el.addEventListener('keyup', function(){ if(!piiLockActive) showSuggestionsImmediate(); });
      el.addEventListener('mouseup', function(){ if(!piiLockActive) showSuggestionsImmediate(); });
      el.addEventListener('focus', function(){ if(!piiLockActive) showSuggestionsImmediate(); });

      window.addEventListener('resize', function(){ if($('#suggestions').style.display==='block') positionSuggestions(); });
      document.addEventListener('scroll', function(){ if($('#suggestions').style.display==='block') positionSuggestions(); }, true);

      // íŒŒì¼ ë“œë¡­(ë¹„ì´ë¯¸ì§€ ë§í¬ë¡œ ì²¨ë¶€)
      el.addEventListener('drop', async function(e){
        const files=e.dataTransfer?.files; if(!files||!files.length) return;
        const non=[]; for(let i=0;i<files.length;i++){ if(!files[i].type.startsWith('image/')) non.push(files[i]); }
        if(!non.length) return;
        e.preventDefault();
        for(const f of non){
          const url=URL.createObjectURL(f);
          editor.model.change(function(w){
            const frag=editor.data.toModel(editor.data.processor.toView('<p>ğŸ“ <a href="'+url+'" download="'+encodeURIComponent(f.name)+'">'+f.name+'</a></p>'));
            w.insert(frag, editor.model.document.selection.getFirstPosition());
          });
        }
        showToast(L.msg.attachOK);
      });

      renderDocList();
      hideSmallRedHints();
    })();

    /* ===== Settings ===== */
    function syncSettingsUI(){
      $('#toggleSuggestions').checked = (localStorage.getItem('enableSuggestions')!=='false');
      $('#toggleInstant').checked     = (localStorage.getItem('enableInstant')!=='false');
      $('#togglePdfMask').checked     = (localStorage.getItem('pdfMask')!=='false'); // ê¸°ë³¸ ON
      $('#togglePiiHighlight').checked= (localStorage.getItem('piiHighlight')!=='false'); // ê¸°ë³¸ ON
      const denied = localStorage.getItem('consent-ok')==='0';
      $('#toggleSuggestions').disabled = denied;
    }
    $('#settingsBtn').onclick = function(){ syncSettingsUI(); document.querySelector('#settingsModal').style.display='flex'; };
    $('#settingsBtnMobile').onclick = function(){ syncSettingsUI(); document.querySelector('#settingsModal').style.display='flex'; };
    document.querySelectorAll('.modal .close,[data-close]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const sel=btn.getAttribute('data-close'); if(sel) document.querySelector(sel).style.display='none'; else document.querySelector('#consent').style.display='none'; });
    });
    document.querySelectorAll('.modal').forEach(m=>{
      m.addEventListener('click',e=>{ if(e.target===m) m.style.display='none'; });
    });

    $('#toggleSuggestions').addEventListener('change', e=>{ localStorage.setItem('enableSuggestions', e.target.checked?'true':'false'); enableSuggestions=e.target.checked; if(!enableSuggestions) $('#suggestions').style.display='none'; });
    $('#toggleInstant').addEventListener('change', e=>{ localStorage.setItem('enableInstant', e.target.checked?'true':'false'); enableInstant=e.target.checked; });
    $('#togglePdfMask').addEventListener('change', e=>{ localStorage.setItem('pdfMask', e.target.checked?'true':'false'); });
    $('#togglePiiHighlight').addEventListener('change', e=>{
      localStorage.setItem('piiHighlight', e.target.checked?'true':'false');
      document.body.classList.toggle('hide-pii', !e.target.checked);
      const cssId='pii-hide-style';
      let s=document.getElementById(cssId);
      if(!e.target.checked){
        if(!s){ s=document.createElement('style'); s.id=cssId; s.textContent='.ck-content .pii-pill{visibility:hidden}'; document.head.appendChild(s); }
      }else if(s){ s.remove(); }
    });
    $('#toggleThemeInSettings').onclick = ()=> document.body.classList.toggle('dark');
    $('#reopenConsent').onclick = ()=> document.querySelector('#consent').style.display='flex';

    /* ===== Help ===== */
    $('#helpBtn').onclick = ()=> document.querySelector('#helpModal').style.display='flex';

    /* ===== Search w/ autosuggest & ë°”ë¡œì´ë™ ì œì•ˆ ===== */
    const SEARCH_HISTORY_KEY='thinkhelper:searchHistory';
    const getHistory=()=>{try{return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY)||'[]');}catch(e){return[];}};
    const addHistory=q=>{if(!q) return; const arr=getHistory().filter(x=>x!==q); arr.unshift(q); localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(arr.slice(0,30)));};

    function buildSearchSuggestions(q){
      q = (q||'').replace(/\u00A0/g,' ').trim();
      if(!q) return getHistory().slice(0,8);
      const hist = getHistory().filter(h=>h.toLowerCase().startsWith(q.toLowerCase()));
      const exp = uiLang==='ko'
        ? [`${q} ëœ»`,`${q} ì˜ˆì‹œ`,`${q} í•µì‹¬`,`${q} ìš”ì•½`,`${q} ì¥ë‹¨ì `,`${q} ì‰½ê²Œ ì„¤ëª…`]
        : uiLang==='ja'
        ? [`${q} ã¨ã¯`,`${q} ä¾‹`,`${q} è¦ç‚¹`,`${q} è¦ç´„`,`${q} é•·æ‰€ çŸ­æ‰€`,`ã‚„ã•ã—ã ${q}`]
        : [`${q} meaning`,`${q} examples`,`${q} key points`,`${q} summary`,`${q} pros and cons`,`explain ${q}`];
      const out = Array.from(new Set([...hist,...exp])).filter(s=>!/(^|\s)nbsp\b/i.test(s)).slice(0,8);
      return out;
    }
    let ssIndex=-1, ssItems=[];
    function showSearchSuggest(){
      const q=$('#searchInput').value;
      const list=buildSearchSuggestions(q);
      const box=$('#searchSuggest');
      if(!list.length){ box.style.display='none'; ssItems=[]; ssIndex=-1; return; }
      const safe = window.DOMPurify?.sanitize || (x=>x);
      box.innerHTML = list.map((t,i)=>`<div class="search-sug-item" data-i="${i}"><span class="icon">ğŸ”</span><span class="text">${safe(t)}</span></div>`).join('');
      box.querySelectorAll('.search-sug-item').forEach(n=>{
        n.onclick=()=>{ $('#searchInput').value = list[+n.dataset.i]; doSearch(false); box.style.display='none'; };
      });
      ssItems=list; ssIndex=0;
      box.style.display='block';
    }
    $('#searchInput').addEventListener('input', showSearchSuggest);
    $('#searchInput').addEventListener('focus', showSearchSuggest);
    document.addEventListener('click', (e)=>{ if(!$('#inlineSearch').contains(e.target)) $('#searchSuggest').style.display='none'; });
    $('#searchInput').addEventListener('keydown', (e)=>{
      const box=$('#searchSuggest'); 
      if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); doSearch(true); box.style.display='none'; return; } // Ctrl/Cmd+Enter => ë°”ë¡œ ì´ë™
      if(box.style.display!=='block'||!ssItems.length) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); ssIndex=(ssIndex+1)%ssItems.length; box.querySelectorAll('.search-sug-item').forEach((n,i)=> n.classList.toggle('selected',i===ssIndex)); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); ssIndex=(ssIndex-1+ssItems.length)%ssItems.length; box.querySelectorAll('.search-sug-item').forEach((n,i)=> n.classList.toggle('selected',i===ssIndex)); }
      else if(e.key==='Enter'){ e.preventDefault(); if(ssIndex>=0){ $('#searchInput').value=ssItems[ssIndex]; } doSearch(false); box.style.display='none'; }
      else if(e.key==='Escape'){ box.style.display='none'; }
    });

    function renderOpenSuggestion(first){
      const box=$('#searchJump'); if(!first){ box.style.display='none'; return; }
      const safe = window.DOMPurify?.sanitize || (x=>x);
      box.innerHTML = `
        <span class="label">ğŸ”— ${L.ui.jumpFirst}</span>
        <span class="meta" title="${safe(first.title||first.link)}">${safe(first.title||first.link)}</span>
        <div style="margin-left:auto;display:flex;gap:.4rem">
          <button class="btn tiny" id="jumpGoBtn">${L.ui.jumpOpen}</button>
          <button class="btn tiny" id="jumpInsertBtn">${L.ui.jumpInsert}</button>
        </div>
      `;
      box.style.display='flex';
      $('#jumpGoBtn').onclick = ()=>{ openExternal(first.link); box.style.display='none'; };
      $('#jumpInsertBtn').onclick = ()=>{ insertSearchResult(first); box.style.display='none'; };
    }

    function insertSearchResult(first){
      const safe = window.DOMPurify?.sanitize || (x=>x);
      const q = $('#searchInput').value.replace(/\u00A0/g,' ').trim();
      const h = '<blockquote><p>ğŸ” <a href="'+first.link+'" target="_blank" rel="noopener">'+(first.title?safe(first.title):q)+'</a></p><p>'+(first.snippet?safe(first.snippet):'')+'</p></blockquote><p></p>';
      editor.model.change(function(w){ const frag=editor.data.toModel(editor.data.processor.toView(h)); w.insert(frag, editor.model.document.selection.getFirstPosition()); });
      showToast(L.msg.searchOK);
    }

    async function doSearch(preferNavigate=false){
      const q=$('#searchInput').value.replace(/\u00A0/g,' ').trim();
      if(q.length<2) return showToast(L.msg.searchTooShort);
      addHistory(q);
      try{
        const r=await fetch(apiUrl('search')+'?q='+encodeURIComponent(q));
        const j=await r.json(); const first=(j.links||[])[0];
        if(!first) return showToast(L.msg.noResults);
        if(preferNavigate){ openExternal(first.link); return; }
        // ì œì•ˆ ë°°ë„ˆ í‘œì‹œ
        renderOpenSuggestion(first);
      }catch(e){ showToast(L.msg.searchErr); }
    }
    $('#searchBtn').onclick = ()=>doSearch(false);

    /* ===== Save menu ===== */
    function titleFromContent(){
      const plain=htmlToText(editor?.getData?.()||'');
      const first=(plain.split(/\n|\./)[0]||'ThinkHelper').slice(0,80).replace(/[\\/:*?"<>|]/g,'_');
      return first || 'ThinkHelper';
    }
    function positionSaveMenu(){ const b=$('#saveBtn'), m=$('#saveMenu'); const r=b.getBoundingClientRect(); m.style.left=r.left+'px'; m.style.top=(r.bottom+6)+'px'; }
    function toggleSaveMenu(){ const m=$('#saveMenu'); if(m.style.display==='block'){m.style.display='none';return;} positionSaveMenu(); m.style.display='block';
      const onDoc=function(e){ if(!m.contains(e.target) && e.target!==$('#saveBtn')){ m.style.display='none'; document.removeEventListener('click',onDoc);} };
      setTimeout(function(){ document.addEventListener('click',onDoc); },0);
    }
    $('#saveBtn').onclick=toggleSaveMenu; window.addEventListener('resize',function(){ if($('#saveMenu').style.display==='block') positionSaveMenu(); });

    /* HTML doc ìƒì„± (PII ë§ˆìŠ¤í‚¹ ì˜µì…˜ ì ìš©) */
    function buildStandaloneHtmlDoc({maskPII=true}={}){
      const doc = document.implementation.createHTMLDocument(titleFromContent());
      const head = doc.head;
      head.appendChild(Object.assign(doc.createElement('meta'),{charset:'utf-8'}));
      head.appendChild(Object.assign(doc.createElement('meta'),{name:'viewport',content:'width=device-width,initial-scale=1'}));
      const style = doc.createElement('style');
      style.textContent = 'body{font-family:-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.6;padding:16px;color:#111}h2{margin:0 0 12px 0}blockquote{border-left:3px solid #ddd;margin:8px 0;padding:4px 8px;color:#555}a{color:#1565c0}.pii-pill-exp{display:inline-block;padding:0 .45em;border-radius:999px;border:1px dashed #f44336;background:#ffe7e7;color:#b71c1c}';
      head.appendChild(style);
      const h2 = doc.createElement('h2'); h2.textContent = titleFromContent(); doc.body.appendChild(h2);

      const tmp = document.createElement('div'); tmp.innerHTML = editor?.getData?.()||'';
      if(maskPII){
        const walker=document.createTreeWalker(tmp, NodeFilter.SHOW_TEXT, null);
        const nodes=[]; let n; while((n=walker.nextNode())) nodes.push(n);
        nodes.forEach(function(node){
          const text=node.nodeValue||''; const hits=findPIIMatches(text); if(!hits.length) return;
          const frag=document.createDocumentFragment(); let cur=0;
          hits.forEach(function(h){
            if(h.start>cur) frag.appendChild(doc.createTextNode(text.slice(cur,h.start)));
            const pill=doc.createElement('span'); pill.setAttribute('class','pii-pill-exp'); pill.textContent='â€¢â€¢â€¢â€¢';
            frag.appendChild(pill); cur=h.end;
          });
          if(cur<text.length) frag.appendChild(doc.createTextNode(text.slice(cur)));
          if(node.parentNode) node.parentNode.replaceChild(frag,node);
        });
      }
      Array.from(tmp.childNodes).forEach(ch=> doc.body.appendChild(doc.importNode(ch,true)));
      return '<!DOCTYPE html>\n'+doc.documentElement.outerHTML;
    }

    async function ensureHtml2Pdf(){
      if(window.html2pdf) return true;
      return new Promise(res=>{
        const s=document.createElement('script');
        s.src='https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js';
        s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s);
      });
    }
    function downloadBlob(blob,filename){
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click();
      setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0);
    }

    $('#saveMenuPdf').onclick = async function(){
      $('#saveMenu').style.display='none';
      const ok=await ensureHtml2Pdf(); if(!ok) return showToast(L.msg.pdfFail);
      const wrap=document.createElement('div'); wrap.style.padding='16px';
      const mask = (localStorage.getItem('pdfMask')!=='false'); // ê¸°ë³¸ ON
      const html = buildStandaloneHtmlDoc({maskPII:mask});
      const parsed = new DOMParser().parseFromString(html,'text/html');
      wrap.appendChild(parsed.body.cloneNode(true));
      try{
        await html2pdf().set({margin:10,filename:titleFromContent()+'.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(wrap).save();
        addLocalDoc(titleFromContent()+' (PDF)', editor.getData()||''); showToast(L.msg.pdfOK);
      }catch(e){ showToast(L.msg.pdfFail); }
    };
    $('#saveMenuDevice').onclick = function(){
      $('#saveMenu').style.display='none';
      const mask = (localStorage.getItem('pdfMask')!=='false');
      const html=buildStandaloneHtmlDoc({maskPII:mask}); downloadBlob(new Blob([html],{type:'text/html'}), titleFromContent()+'.html');
      addLocalDoc(titleFromContent()+' (HTML)', editor.getData()||''); showToast(L.msg.fileOK);
    };

    /* ===== Drive Export + Cloud draft ===== */
    async function ensureAccess(){
      if(accessToken && Date.now()<tokenExpiresAt) return accessToken;
      return new Promise(function(resolve){
        tokenClient.callback=function(resp){
          if(resp && resp.access_token){ accessToken=resp.access_token; tokenExpiresAt=Date.now()+((resp.expires_in||3600)-60)*1000; resolve(accessToken); }
          else{ showToast(L.msg.needLogin); resolve(null); }
        };
        tokenClient.requestAccessToken({prompt:''});
      });
    }
    async function uploadToDrive(token, blob, fileName, toGoogleDoc){
      const meta={name:fileName}; if(toGoogleDoc) meta.mimeType='application/vnd.google-apps.document';
      const form=new FormData();
      form.append('metadata', new Blob([JSON.stringify(meta)], {type:'application/json'}));
      form.append('file', blob);
      const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',{method:'POST',headers:{Authorization:'Bearer '+token},body:form});
      const j=await r.json(); return j.id||null;
    }
    $('#exportBtn').onclick = async function(){
      $('#saveMenu').style.display='none';
      const token=await ensureAccess(); if(!token) return showToast(L.msg.needLogin);
      const htmlDoc=buildStandaloneHtmlDoc({maskPII:(localStorage.getItem('pdfMask')!=='false')});
      const title=titleFromContent();
      const id=await uploadToDrive(token, new Blob([htmlDoc],{type:'text/html'}), 'thinkhelper_'+title+'.html', true);
      if(id){
        const li=document.createElement('li'); const a=document.createElement('a');
        a.href='https://docs.google.com/document/d/'+id+'/edit'; a.target='_blank'; a.rel='noopener'; a.textContent='ğŸ“„ Drive: '+title;
        li.appendChild(a); $('#docList').prepend(li);
        showToast(L.msg.exportOK);
      }else{ showToast(L.msg.exportFail); }
    };

    async function getAppDataFileIdByName(name){
      const token=await ensureAccess(); if(!token) return null;
      const q=encodeURIComponent("name='"+name+"' and 'appDataFolder' in parents and trashed=false");
      const r=await fetch('https://www.googleapis.com/drive/v3/files?q='+q+'&spaces=appDataFolder&fields=files(id,name)',{headers:{Authorization:'Bearer '+token}});
      const j=await r.json(); return (j.files && j.files[0] && j.files[0].id) ? j.files[0].id : null;
    }
    async function createAppDataFile(name,json){
      const token=await ensureAccess(); if(!token) return null;
      const meta={name:name,parents:['appDataFolder'],mimeType:'application/json'};
      const form=new FormData();
      form.append('metadata', new Blob([JSON.stringify(meta)], {type:'application/json'}));
      form.append('file', new Blob([JSON.stringify(json)], {type:'application/json'}));
      const r=await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id',{method:'POST',headers:{Authorization:'Bearer '+token},body:form});
      const j=await r.json(); return j.id||null;
    }
    async function updateAppDataFile(fileId,json){
      const token=await ensureAccess(); if(!token) return false;
      const r=await fetch('https://www.googleapis.com/upload/drive/v3/files/'+fileId+'?uploadType=media',{method:'PATCH',headers:{Authorization:'Bearer '+token,'Content-Type':'application/json'},body:JSON.stringify(json)});
      return r.ok;
    }
    async function readAppDataFile(fileId){
      const token=await ensureAccess(); if(!token) return null;
      const r=await fetch('https://www.googleapis.com/drive/v3/files/'+fileId+'?alt=media',{headers:{Authorization:'Bearer '+token}});
      if(!r.ok) return null; return r.json();
    }
    const saveCloudDraftDebounced = deb(async function(){
      if(!isLoggedIn) return;
      try{
        if(!cloudDraftFileId){
          cloudDraftFileId = await getAppDataFileIdByName('thinkhelper_draft.json');
          if(!cloudDraftFileId){
            cloudDraftFileId = await createAppDataFile('thinkhelper_draft.json',{title:'Cloud Draft',html:'',updatedAt:Date.now()});
          }
        }
        const payload={title:titleFromContent(), html:editor?.getData?.()||'', updatedAt:Date.now()};
        await updateAppDataFile(cloudDraftFileId, payload);
        renderDocList(payload);
      }catch(e){ console.warn('saveCloudDraft error',e); }
    }, 1200);

    async function loadCloudDraft(){
      try{
        cloudDraftFileId = await getAppDataFileIdByName('thinkhelper_draft.json');
        if(!cloudDraftFileId){
          cloudDraftFileId = await createAppDataFile('thinkhelper_draft.json',{title:'Cloud Draft',html:'',updatedAt:Date.now()});
        }
        const data = await readAppDataFile(cloudDraftFileId);
        if(data && data.html){
          const currentPlain = htmlToText(editor.getData()||'');
          if(!currentPlain){ editor.setData(data.html||''); showToast(L.msg.cloudLoaded); }
        }
        renderDocList(data||{title:'Cloud Draft',updatedAt:Date.now(),html:editor.getData()});
      }catch(e){ console.warn('loadCloudDraft error',e); }
    }

    /* ===== New Doc ===== */
    $('#newDocBtn').onclick=function(){ if(editor && editor.setData){ editor.setData(''); } try{ localStorage.removeItem(DRAFT_KEY); }catch(e){} showToast(L.msg.newDoc); };
    if($('#newDocCTA')){ $('#newDocCTA').addEventListener('click',()=>$('#newDocBtn').click()); }

    /* ===== Consent ===== */
    function updateConsentBadge(){
      const choice=localStorage.getItem('consent-ok'); const b=$('#consentBadge');
      if(choice==='0'){ b.textContent=L.ui.badgeOff; b.classList.add('off'); }
      else if(choice==='1'){ b.textContent=L.ui.badgeOn; b.classList.remove('off'); }
      else { b.textContent=L.ui.badgeWait; b.classList.remove('off'); }
    }
    function applyConsentEffect(){
      const choice=localStorage.getItem('consent-ok');
      if(choice==='0'){
        enableSuggestions=false;
        localStorage.setItem('enableSuggestions','false');
        $('#suggestions').style.display='none';
      }
      updateConsentBadge();
    }
    (function initConsent(){
      const choice=localStorage.getItem('consent-ok');
      if(choice===null){ document.querySelector('#consent').style.display='flex'; }
      else{ applyConsentEffect(); }
      $('#agreeBtn').onclick=function(){
        localStorage.setItem('consent-ok','1');
        document.querySelector('#consent').style.display='none';
        enableSuggestions = (localStorage.getItem('enableSuggestions')!=='false');
        applyConsentEffect();
        showToast(L.msg.consentSaved);
      };
      $('#declineBtn').onclick=function(){
        localStorage.setItem('consent-ok','0');
        document.querySelector('#consent').style.display='none';
        applyConsentEffect();
        showToast(L.msg.consentOff);
      };
      $('#consentClose').onclick=function(){ document.querySelector('#consent').style.display='none'; };
    })();

    /* ===== GIS OAuth ===== */
    function setSignedInUI(signed){
      isLoggedIn=!!signed;
      $('#authBtn').textContent = signed ? L.ui.authLogout : L.ui.authLogin;
      $('#authBtn').onclick = signed ? logout : login;
      $('#loginDisplay').textContent = (signed && userProfile) ? (userProfile.name || userProfile.email || '') : '';
    }
    async function fetchUserInfo(){
      try{
        const r=await fetch('https://www.googleapis.com/oauth2/v3/userinfo',{headers:{Authorization:'Bearer '+accessToken}});
        if(r.ok){ userProfile=await r.json(); }
      }catch(e){}
    }
    function initOAuth(){
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: OAUTH_SCOPES,
        callback: async function(resp){
          if(resp && resp.access_token){
            accessToken=resp.access_token; tokenExpiresAt=Date.now()+((resp.expires_in||3600)-60)*1000;
            await fetchUserInfo(); setSignedInUI(true); showToast(L.msg.loginOK); await loadCloudDraft();
          }else{
            showToast(L.msg.loginFail);
          }
        }
      });
      setSignedInUI(false);
    }
    function login(){ if(tokenClient){ tokenClient.requestAccessToken({prompt:'consent'}); } }
    async function logout(){
      try{
        if(accessToken){
          await fetch('https://oauth2.googleapis.com/revoke?token='+encodeURIComponent(accessToken),{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'}});
        }
      }catch(e){}
      accessToken=null; tokenExpiresAt=0; userProfile=null; setSignedInUI(false); showToast(L.msg.logoutOK);
    }
    function ensureGISLoaded(cb,tries){
      const t=typeof tries==='number'?tries:0;
      if(window.google?.accounts?.oauth2){ cb(); }
      else if(t<50){ setTimeout(()=>ensureGISLoaded(cb,t+1),120); }
    }
    (function initOAuthSafe(){ if(CLIENT_ID){ ensureGISLoaded(initOAuth,0); } })();

    /* ===== Gemini Chat(ìƒ˜í”Œ) ===== */
    function appendChat(role,text){
      const d=document.createElement('div'); d.className='chatMsg '+(role==='user'?'user':'ai'); d.textContent=text;
      $('#chatLog').appendChild(d); $('#chatLog').scrollTop=$('#chatLog').scrollHeight;
    }
    async function sendChat(){
      const v=$('#chatInput').value.trim(); if(!v) return; appendChat('user',v); $('#chatInput').value='';
      let reply='';
      try{
        const r=await fetch(apiUrl('gpt'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text:v})});
        const j=r.ok?await r.json():null; reply=(j && j.response && j.response.text) ? j.response.text : (j && j.text ? j.text : '');
      }catch(e){}
      if(!reply){ reply='â€¦'; }
      appendChat('ai',reply);
    }
    $('#chatBtn').onclick=function(){ $('#chatPanel').style.display='flex'; $('#chatInput').focus(); };
    $('#chatClose').onclick=function(){ $('#chatPanel').style.display='none'; };
    $('#chatFullscreenToggle').onclick=function(){ $('#chatPanel').classList.toggle('fullscreen'); };
    $('#chatInput').addEventListener('keydown',function(e){ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendChat(); } });

    /* ===== ì–¸ì–´ ìë™/ëª¨ë°”ì¼ ë™ê¸°í™” ===== */
    async function detectLangByIP(){
      try{
        const r = await fetch('https://ipapi.co/json/');
        if(!r.ok) throw new Error('ipapi failed');
        const j = await r.json();
        const cc = (j.country_code||'').toUpperCase();
        if(cc==='KR') return 'ko';
        if(cc==='JP') return 'ja';
        return 'en';
      }catch(e){
        const nav=(navigator.language||'en').slice(0,2).toLowerCase();
        return ['ko','en','ja'].includes(nav)?nav:'en';
      }
    }
    document.addEventListener('DOMContentLoaded', async function(){
      const langSource = localStorage.getItem('langSource'); // 'user' | 'auto' | null
      if(langSource==='user' && localStorage.getItem('lang')){
        applyLang(localStorage.getItem('lang'));
      }else{
        const detected = await detectLangByIP();
        applyLang(detected);
        localStorage.setItem('langSource','auto');
      }
      ['#languageSelect','#languageSelectMobile'].forEach(sel=>{
        const el=$(sel); if(!el) return;
        el.addEventListener('change', function(e){
          localStorage.setItem('langSource','user');
          applyLang(e.target.value || 'ko');
        });
      });
    });

    /* ===== Save draft before unload ===== */
    window.addEventListener('beforeunload', function(){
      try{ localStorage.setItem(DRAFT_KEY, editor?.getData?.()||''); }catch(e){}
    });

    /* ===== reCAPTCHA callback (ìš”ì²­ ì½”ë“œ ìœ ì§€) ===== */
    function onSubmit(token) {
      const form = document.getElementById("demo-form");
      if(form){ form.submit(); }
      showToast('reCAPTCHA verified');
    }
    window.onSubmit = onSubmit;
  </script>
</body>
</html>
