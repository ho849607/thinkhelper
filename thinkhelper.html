<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="color-scheme" content="light dark"/>
  <meta http-equiv="Permissions-Policy" content="identity-credentials-get=()"/>
  <title>ThinkHelper 3.3 (Mobile quick actions + Topic AI cache)</title>

  <!-- íŒŒë¹„ì½˜/ë§¤ë‹ˆí˜ìŠ¤íŠ¸: 404 ë°©ì§€ìš© ë°ì´í„° URL -->
  <link rel="icon" type="image/svg+xml"
        href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><rect width="64" height="64" rx="12" fill="%231976d2"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="34" fill="white">T</text></svg>'/>
  <link rel="manifest"
        href='data:application/manifest+json,{"name":"ThinkHelper","short_name":"ThinkHelper","start_url":".","display":"standalone","background_color":"#1976d2","theme_color":"#1976d2","icons":[]}'/>

  <!-- GA4 -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-9PM41E1HFW"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date()); gtag('config', 'G-9PM41E1HFW');
  </script>

  <!-- í•„ìˆ˜ ë¼ì´ë¸ŒëŸ¬ë¦¬(CDN) -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.3.1/classic/ckeditor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

  <style>
    :root{
      --primary:#1976d2; --primary-light:#e3f2fd; --primary-hover:#bbdefb;
      --bg:#f6f7fb; --fg:#262b33; --box:#fff; --border:#ccd3e0; --text-light:#fff;
      --sug-bg:#ffffff; --sug-hover:#eef4ff; --sug-text:#0f172a;
      --pill-bg:#ffe7e7; --pill-border:#f44336; --pill-dot:#b71c1c;
    }
    body.dark{
      --bg:#0f172a; --fg:#e2e8f0; --box:#0b1220; --border:#2a3550;
      --sug-bg:#0b1220; --sug-hover:#111a2e; --sug-text:#e2e8f0;
      --primary-light:#90CAF9; --primary-hover:#64B5F6;
      --pill-bg:#2a1111; --pill-border:#ef9a9a; --pill-dot:#ffb4b4;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{min-height:100vh;display:flex;flex-direction:column;font-family:-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;background:var(--bg);color:var(--fg);transition:background .3s,color .3s}
    header{display:flex;justify-content:space-between;align-items:center;padding:.6rem .9rem;background:var(--primary);color:var(--text-light);position:sticky;top:0;z-index:100;border-bottom:1px solid rgba(255,255,255,.2)}
    #logoWrap{display:flex;align-items:center;gap:.6rem}
    #logoWrap h1{font-size:1.05rem;font-weight:700}
    .toolbar{display:flex;align-items:center;gap:.4rem;flex-wrap:wrap}
    .btn{padding:.34rem .72rem;border:none;border-radius:10px;background:var(--box);color:var(--primary);cursor:pointer;font-size:.9rem;transition:background .2s}
    .btn:hover{background:var(--primary-hover)}
    .btn.tiny{padding:.24rem .5rem;font-size:.84rem}
    select{padding:.34rem;border:none;border-radius:10px;background:var(--box);color:var(--primary);font-size:.9rem}
    #sidebarToggle{display:none}
    @media (max-width:860px){
      #sidebarToggle{display:inline-flex}
      .toolbar> :not(#authBtn):not(#saveBtn):not(#helpBtn):not(#menuBtn):not(#recaptchaBtn){display:none !important}
      #menuBtn{display:inline-flex}
    }
    #menuBtn{display:none}
    .badge{display:inline-block;padding:.16rem .5rem;border-radius:999px;font-size:.78rem;background:rgba(255,255,255,.25);color:#fff}
    .badge.off{background:#d32f2f}

    main{flex:1;display:flex;min-height:0}
    aside{width:260px;background:var(--primary-light);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:auto}
    body.dark aside{background:#0f2334}
    @media (max-width:860px){
      aside{display:none}
      aside.open{display:flex;position:fixed;top:54px;bottom:0;left:0;z-index:250;width:80vw;max-width:320px}
    }
    aside h3{font-size:1rem;font-weight:700;padding:1rem .9rem;border-bottom:1px solid var(--border)}
    #docList,#chatList{list-style:none;font-size:.92rem}
    #docList li,#chatList li{display:flex;justify-content:space-between;align-items:center;padding:.6rem .85rem;border-bottom:1px dashed var(--border);cursor:pointer}
    #docList li small{opacity:.7}
    #docList li:hover,#chatList li:hover{background:var(--primary-hover)}
    #emptyCTA{padding:1rem .9rem;text-align:center;font-size:.88rem;color:#555}
    #newDocBtn{margin:.7rem; padding:.6rem 1rem;border:none;border-radius:10px;background:var(--primary);color:#fff;cursor:pointer;font-size:.92rem}
    #newDocBtn:hover{background:#1565c0}

    section{flex:1;display:flex;flex-direction:column;padding:1rem;background:var(--box);min-width:0;position:relative}
    #editor{flex:1;border:1px solid var(--border);border-radius:12px;padding:1rem;overflow:auto;background:inherit;color:inherit}
    #editor:empty::before{content:attr(data-placeholder);color:#9aa3b2;font-style:italic}
    .ck-editor__editable_inline{min-height:58vh!important}
    .ck-content{color:inherit;background:inherit;font-size:1.02rem;line-height:1.7}
    .ck-content a{color:var(--primary-hover)} body.dark .ck-content a{color:#90caf9}
    #charCount{display:none}

    #quickActions{display:flex;gap:.5rem;margin:.6rem 0 .2rem 0}
    #quickActions .btn{padding:.28rem .6rem;font-size:.85rem}

    #inlineSearch{display:flex;gap:.5rem;margin-top:1rem;position:relative}
    #inlineSearch input{flex:1;padding:.7rem 1rem;font-size:1rem;border:1px solid var(--border);border-radius:12px;background:inherit;color:inherit}
    #inlineSearch button{border-radius:12px}
    #inlineSearch input::placeholder{color:#8a93a3} body.dark #inlineSearch input::placeholder{color:#b8c1d4}

    #searchSuggest{
      position:absolute; top:100%; left:0; right:0; margin-top:6px;
      background:var(--sug-bg); color:var(--sug-text); border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(0,0,0,.22);
      display:none; z-index:1200; max-height:280px; overflow:auto;
    }
    .search-sug-item{padding:.6rem .9rem;border-bottom:1px dashed var(--border);cursor:pointer;display:flex;gap:.5rem;align-items:center}
    .search-sug-item:last-child{border-bottom:none}
    .search-sug-item:hover,.search-sug-item.selected{background:var(--sug-hover)}
    .search-sug-item .icon{opacity:.8}
    .search-sug-item .text{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    #searchJump{
      margin-top:8px; display:none; align-items:center; gap:.5rem;
      background:var(--sug-bg); color:var(--sug-text);
      border:1px solid var(--border); border-radius:12px; padding:8px 10px;
      box-shadow:0 8px 20px rgba(0,0,0,.12);
    }
    #searchJump .label{font-weight:700}
    #searchJump .meta{opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:45%}
    @media (max-width:860px){ #searchJump .meta{max-width:55%} }

    #suggestions{
      position:fixed;z-index:99999;max-height:260px;overflow:auto;min-width:280px;max-width:min(92vw,680px);
      background:var(--sug-bg);border:1px solid var(--border);border-radius:12px;padding:.25rem 0;
      box-shadow:0 12px 28px rgba(0,0,0,.22);font-size:.96rem;display:none;-webkit-overflow-scrolling:touch;
    }
    .suggestion-item{padding:.65rem .95rem;border-bottom:1px dashed var(--border);cursor:pointer;color:var(--sug-text);line-height:1.5;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .suggestion-item:last-child{border-bottom:none}
    .suggestion-item:hover,.suggestion-item.selected{background:var(--sug-hover)}
    .suggestion-item.selected{outline:2px solid var(--primary)}

    .ck-content .pii-pill{ background:var(--pill-bg); border:1px dashed var(--pill-border); color:transparent; border-radius:999px; padding:0 .5em; user-select:none; box-decoration-break:clone; }
    .ck-content .pii-pill::after{ content:"â€¢â€¢â€¢â€¢"; color:var(--pill-dot); letter-spacing:.12em; }

    #saveMenu{position:fixed;display:none;z-index:1600;min-width:240px;background:var(--box);color:var(--fg);border:1px solid var(--border);border-radius:12px;box-shadow:0 12px 28px rgba(0,0,0,.22)}
    #saveMenu button{display:block;width:100%;border:0;background:transparent;color:#0d1b2a;font-weight:700;font-size:.95rem;padding:.75rem 1rem;text-align:left;letter-spacing:.01em;border-bottom:1px dashed var(--border)}
    #saveMenu button:last-child{border-bottom:none}
    body.dark #saveMenu{background:#0b1220;border-color:#2a3550}
    body.dark #saveMenu button{color:#eaeef9}
    #saveMenu button:hover,#saveMenu button:focus{background:var(--primary);color:#fff}
    #saveMenu button:focus-visible{outline:3px solid var(--primary);outline-offset:2px}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:2000}
    .modal .card{width:min(92vw,760px);max-height:85vh;overflow:auto;background:var(--box);color:var(--fg);border:1px solid var(--border);border-radius:12px;box-shadow:0 20px 48px rgba(0,0,0,.35)}
    .modal .card header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal .card .content{padding:14px 16px}
    .modal .close{border:none;background:transparent;font-size:20px;cursor:pointer;color:inherit}

    #drawer{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-start;justify-content:flex-end;z-index:1600}
    #drawer .sheet{width:min(92vw,380px);height:100%;background:var(--box);color:var(--fg);border-left:1px solid var(--border);padding:1rem;display:flex;flex-direction:column;gap:.8rem}
    #drawer .row{display:flex;gap:.5rem;align-items:center}
    #drawer .row select, #drawer .row button, #drawer .row input{flex:1}
    #helpInlineMobile{font-size:.92rem;line-height:1.6;border-top:1px solid var(--border);padding-top:.6rem}

    .qa-grid{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
    .qa-grid .btn{width:100%}

    .grecaptcha-badge, .site-error, .error,
    small[style*="color:red"], .ck.ck-notification__message{display:none !important;}

    footer#legal{font-size:.8rem;opacity:.7;padding:.6rem 1rem;background:transparent;color:inherit}

    #chatPanel{
      position:fixed; right:16px; bottom:16px; width:420px; height:520px;
      display:none; flex-direction:column;
      background:var(--box); color:var(--fg); border:1px solid var(--border);
      border-radius:12px; box-shadow:0 12px 28px rgba(0,0,0,.22); z-index:1800;
    }
    #chatPanel.fullscreen{ left:0; right:0; top:54px; bottom:0; width:auto; height:auto; border-radius:0; }
    #chatHeader{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border); background:var(--primary-light)}
    #chatHeader .right{display:flex; gap:.4rem}
    #chatLog{flex:1; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:6px}
    .chatMsg{max-width:80%; padding:8px 10px; border-radius:12px; line-height:1.45}
    .chatMsg.user{align-self:flex-end; background:var(--primary-light)}
    .chatMsg.ai{align-self:flex-start; background:#eceff1}
    #chatInput{border:1px solid var(--border); border-radius:10px; padding:10px 12px; margin:10px}
    @media (max-width:860px){
      #chatPanel{ left:8px; right:8px; bottom:10px; width:auto; height:65vh; }
    }
  </style>
</head>
<body>
  <header>
    <div id="logoWrap">
      <button class="btn tiny" id="sidebarToggle" title="ì‚¬ì´ë“œë°”" aria-label="ì‚¬ì´ë“œë°”">â˜°</button>
      <h1 id="appTitle">ThinkHelper 3.3</h1>
    </div>
    <div class="toolbar">
      <span id="loginDisplay" style="color:#fff;margin-right:.2rem"></span>
      <span id="consentBadge" class="badge" title="ê°œì¸ì •ë³´ ë™ì˜ ìƒíƒœ"></span>
      <button class="btn" id="authBtn">Google ë¡œê·¸ì¸</button>

      <select id="languageSelect" aria-label="Language">
        <option value="ko">í•œêµ­ì–´</option><option value="en">English</option>
        <option value="ja">æ—¥æœ¬èª</option><option value="fr">FranÃ§ais</option>
        <option value="vi">Tiáº¿ng Viá»‡t</option>
      </select>
      <select id="modeSelect" aria-label="Mode">
        <option value="basic">ğŸ›  Basic</option><option value="journalist">ğŸ“° Journalist</option>
        <option value="research">ğŸ“‘ Research</option><option value="law">âš–ï¸ Legal</option>
        <option value="dev">ğŸ’» Developer</option>
      </select>

      <button class="btn" id="saveBtn">ğŸ’¾ ì €ì¥</button>
      <button class="btn" id="chatBtn">ğŸ’¬ ì±„íŒ…</button>
      <button class="btn" id="themeBtn">ğŸŒ™ í…Œë§ˆ</button>
      <button class="btn" id="settingsBtn">âš™ï¸ ì„¤ì •</button>
      <button class="btn" id="helpBtn">â“ ë„ì›€ë§</button>
      <button class="btn" id="shareNaverBtn">ë„¤ì´ë²„ ë¸”ë¡œê·¸</button>
      <button class="btn" id="shareTwitterBtn">X (Twitter)</button>
      <button class="btn g-recaptcha" id="recaptchaBtn"
        data-sitekey="6LdrQpwrAAAAAEfS6GhTaZwnTY5MpC69IEeRNDIT"
        data-callback="onSubmit"
        data-action="submit">reCAPTCHA</button>
      <button class="btn" id="menuBtn" aria-label="ë©”ë‰´">â˜°</button>
    </div>

    <div id="saveMenu" role="menu" aria-label="Save options">
      <button id="saveMenuPdf">ğŸ–¨ï¸ <span>PDFë¡œ ì €ì¥</span></button>
      <button id="saveMenuDevice">ğŸ’¾ <span>ê¸°ê¸°ì— ì €ì¥í•˜ê¸°(HTML)</span></button>
      <button id="exportBtn">ğŸ“‚ <span>Driveë¡œ ë‚´ë³´ë‚´ê¸°(Google Docs)</span></button>
    </div>
  </header>

  <main>
    <aside id="sidebar">
      <h3 id="docListTitle">ë¬¸ì„œ ëª©ë¡</h3>
      <div id="emptyCTA" style="display:none">
        <span id="emptyText">ì•„ì§ ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.</span><br/>
        <button id="newDocCTA" class="btn">+ ìƒˆ ë¬¸ì„œ</button>
      </div>
      <button class="btn" id="newDocBtn">â• ìƒˆ ë¬¸ì„œ</button>
      <ul id="docList"></ul>

      <h3 id="chatListTitle">ì±„íŒ… ê¸°ë¡</h3>
      <ul id="chatList"></ul>
    </aside>

    <section id="wrap">
      <div id="quickActions"><button class="btn tiny" id="copyBtn">ğŸ“‹ Copy (Ctrl/Cmd+C)</button></div>
      <div id="editor" data-placeholder="ì—¬ê¸°ì— ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."></div>
      <div id="charCount">0 ì</div>

      <div id="inlineSearch">
        <input id="searchInput" placeholder="ê²€ìƒ‰ (/ ë˜ëŠ” Ctrl+K)" autocomplete="off"/>
        <button class="btn" id="searchBtn">ğŸ” <span id="searchBtnText">ê²€ìƒ‰</span></button>
        <div id="searchSuggest"></div>
        <div id="searchJump" role="region" aria-live="polite"></div>
      </div>

      <div id="suggestions"></div>
    </section>
  </main>

  <footer id="legal">
    <div>
      This site is protected by reCAPTCHA and the Google
      <a href="https://policies.google.com/privacy" target="_blank" rel="noopener">Privacy Policy</a> and
      <a href="https://policies.google.com/terms" target="_blank" rel="noopener">Terms of Service</a> apply.
    </div>
    <div id="aiNotice" style="margin-top:.35rem;"></div>
  </footer>

  <!-- Drawer -->
  <div id="drawer" aria-hidden="true">
    <div class="sheet" role="dialog" aria-label="Quick Menu">
      <div class="qa-grid" style="margin-bottom:.2rem">
        <button class="btn" id="settingsBtnMobileQA">âš™ï¸ ì„¤ì •</button>
        <button class="btn" id="shareNaverBtnMobileQA">ë„¤ì´ë²„ ë¸”ë¡œê·¸</button>
        <button class="btn" id="shareTwitterBtnMobileQA">X (Twitter)</button>
        <button class="btn" id="themeBtnMobileQA">ğŸŒ™ ë‹¤í¬ëª¨ë“œ</button>
        <button class="btn" id="chatBtnMobileQA">ğŸ’¬ ì±„íŒ…</button>
      </div>
      <div class="row">
        <label style="min-width:88px" id="labelLang">Language</label>
        <select id="languageSelectMobile">
          <option value="ko">í•œêµ­ì–´</option><option value="en">English</option>
          <option value="ja">æ—¥æœ¬èª</option><option value="fr">FranÃ§ais</option>
          <option value="vi">Tiáº¿ng Viá»‡t</option>
        </select>
      </div>
      <div class="row">
        <label style="min-width:88px" id="labelMode">Mode</label>
        <select id="modeSelectMobile">
          <option value="basic">ğŸ›  Basic</option><option value="journalist">ğŸ“° Journalist</option>
          <option value="research">ğŸ“‘ Research</option><option value="law">âš–ï¸ Legal</option>
          <option value="dev">ğŸ’» Developer</option>
        </select>
      </div>
      <div id="helpInlineMobile"></div>
      <button class="btn" id="drawerClose" style="margin-top:auto">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- ë™ì˜ ëª¨ë‹¬ -->
  <div id="consent" class="modal" role="dialog" aria-modal="true" aria-labelledby="consentTitle">
    <div class="card">
      <header>
        <h3 id="consentTitle">ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ì•ˆë‚´</h3>
        <button class="close" id="consentClose" aria-label="ë‹«ê¸°">âœ•</button>
      </header>
      <div class="content">
        <p id="consentBody" style="line-height:1.7;margin:.4rem 0">
          ì‚¬ìš©ìëŠ” ë¡œê·¸ì¸ ì—†ì´ë„ ë³¸ ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¤ë§Œ,
          <strong>ë¡œê·¸ì¸ ì‹œ ë° ë¬¸ì„œë¥¼ ì‘ì„±í•  ë•Œ</strong> ì‚¬ìš©ìê°€ ì‘ì„±í•˜ëŠ” ë‚´ìš© ì¤‘ ì¼ë¶€ëŠ” í’ˆì§ˆ ê°œì„ ê³¼ ê¸°ëŠ¥ ì œê³µì„ ìœ„í•´ ìˆ˜ì§‘ë  ìˆ˜ ìˆë‹¤ëŠ” ê²ƒì— ë™ì˜í•©ë‹ˆë‹¤.
          ë™ì˜ë¥¼ ê±°ë¶€í•˜ë”ë¼ë„ ì„œë¹„ìŠ¤ëŠ” ì´ìš© ê°€ëŠ¥í•˜ì§€ë§Œ,
          <strong>ì´ ê²½ìš° ì¶”ì²œ ì—ë””í„° ê¸°ëŠ¥ì€ ë¹„í™œì„±í™”</strong>ë©ë‹ˆë‹¤.
        </p>
        <p style="margin:.4rem 0">
          <a id="privacyLink" href="https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing" target="_blank" rel="noopener">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ìì„¸íˆ ë³´ê¸°</a> Â·
          <a id="tosLink" href="https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing" target="_blank" rel="noopener">ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ìì„¸íˆ ë³´ê¸°</a>
        </p>
        <div style="display:flex;gap:.5rem;justify-content:flex-end;margin-top:10px">
          <button class="btn" id="declineBtn" style="background:#eee">ê±°ë¶€</button>
          <button class="btn" id="agreeBtn" style="background:#1976d2;color:#fff">ë™ì˜</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ë„ì›€ë§ ëª¨ë‹¬ -->
  <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="card">
      <header>
        <h3 id="helpTitle">ë„ì›€ë§</h3>
        <button class="close" data-close="#helpModal" aria-label="ë‹«ê¸°">âœ•</button>
      </header>
      <div class="content" id="helpContent"></div>
    </div>
  </div>

  <!-- GPT-Nano Chat -->
  <div id="chatPanel" role="dialog" aria-label="GPT-Nano Chat">
    <div id="chatHeader">
      <span id="chatTitle">ğŸ’¬ GPT-Nano Chat</span>
      <div class="right">
        <button class="btn tiny" id="chatFullscreenToggle">â¤¢ Full</button>
        <button class="btn tiny" id="chatClose">Close</button>
      </div>
    </div>
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Enterë¡œ ì „ì†¡" aria-label="Chat Input"/>
  </div>

  <form id="demo-form" action="#" method="post" style="display:none"></form>

  <script>
  'use strict';

  /* ===== helpers ===== */
  const $ = (sel)=>document.querySelector(sel);
  function apiUrl(path){ const p=(path||'').startsWith('/')?path:'/'+(path||''); return p.startsWith('/api/')?p:'/api'+p; }
  function isOnline(){ try { return navigator.onLine; } catch(_) { return true; } }
  const htmlToText = (html='')=>{ const tmp=document.createElement('div'); tmp.innerHTML=html; const t=(tmp.textContent||'').replace(/\u00A0/g,' '); return t.replace(/\s+/g,' ').trim(); };

  /* ===== i18n ===== */
  const PRIV_LINK='https://docs.google.com/document/d/1kmFzmp3ddJOKOp1TPsvsNzAuBKt6M0Vm0N_G5BIOZEE/edit?usp=sharing';
  const TOS_LINK='https://docs.google.com/document/d/1TLZ2m52s1mAd8BPzXDBQuXF6QZ_hLDZOyX6Y8TKALnE/edit?usp=sharing';

  const I18N = {
    ko:{ui:{authLogin:'Google ë¡œê·¸ì¸',authLogout:'ë¡œê·¸ì•„ì›ƒ',save:'ì €ì¥',chat:'ì±„íŒ…',theme:'í…Œë§ˆ',settings:'ì„¤ì •',help:'ë„ì›€ë§',naver:'ë„¤ì´ë²„ ë¸”ë¡œê·¸',twitter:'X (Twitter)',documents:'ë¬¸ì„œ ëª©ë¡',chats:'ì±„íŒ… ê¸°ë¡',newDoc:'â• ìƒˆ ë¬¸ì„œ',newDocCTA:'+ ìƒˆ ë¬¸ì„œ',empty:'ì•„ì§ ì €ì¥ëœ ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.',searchPH:'ê²€ìƒ‰ (/ ë˜ëŠ” Ctrl+K)',searchBtn:'ê²€ìƒ‰',savePdf:'PDFë¡œ ì €ì¥',saveHtml:'ê¸°ê¸°ì— ì €ì¥í•˜ê¸°(HTML)',exportDrive:'Driveë¡œ ë‚´ë³´ë‚´ê¸°(Google Docs)',drawerClose:'ë‹«ê¸°',drawerLang:'Language',drawerMode:'Mode',consentTitle:'ê°œì¸ì •ë³´ ìˆ˜ì§‘Â·ì´ìš© ì•ˆë‚´',consentBody:'You can use the service without signing in. ...',privacy:'ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨ ìì„¸íˆ ë³´ê¸°',tos:'ì„œë¹„ìŠ¤ ì´ìš©ì•½ê´€ ìì„¸íˆ ë³´ê¸°',agree:'ë™ì˜',decline:'ê±°ë¶€',badgeOn:'ì¶”ì²œ ON',badgeOff:'ì¶”ì²œ OFF',badgeWait:'ë™ì˜ ëŒ€ê¸°',helpTitle:'ë„ì›€ë§',helpHtml:`<ul style="line-height:1.8;margin-left:1rem"><li>ë¬¸ì„œ ì‘ì„±Â·ìš”ì•½</li><li>ì›¹ ê²€ìƒ‰ ê²°ê³¼ ì‚½ì…</li><li>PII ë§ˆìŠ¤í‚¹</li><li>ë³µì‚¬ ë²„íŠ¼ / ë¶™ì—¬ë„£ê¸° ë‹¨ì¶•í‚¤</li><li><a href="${PRIV_LINK}" target="_blank" rel="noopener">ê°œì¸ì •ë³´ ì²˜ë¦¬ë°©ì¹¨</a> Â· <a href="${TOS_LINK}" target="_blank" rel="noopener">ì´ìš©ì•½ê´€</a></li></ul>`,settingsTitle:'ì„¤ì •',labelSuggest:'ì¶”ì²œ ì—ë””í„° ì‚¬ìš©',labelInstant:'ëª¨ë°”ì¼ ì¦‰ì‹œ ì œì•ˆ(ì €ì‚¬ì–‘ ë¹„í™œì„± ê¶Œì¥)',labelPdfMask:'PDF ì €ì¥ ì‹œ ë§ˆìŠ¤í‚¹ ì ìš©',labelPiiHighlight:'ì—ë””í„°ì—ì„œ PII í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ',reopenConsent:'ê°œì¸ì •ë³´ ë™ì˜ ë‹¤ì‹œ ì„¤ì •',toggleTheme:'í…Œë§ˆ í† ê¸€',chatTitle:'ğŸ’¬ GPT-Nano Chat',chatFull:'â¤¢ Full',chatClose:'Close',chatPH:'Enterë¡œ ì „ì†¡',jumpFirst:'ì²« ê²°ê³¼',jumpOpen:'ë°”ë¡œ ì´ë™',jumpInsert:'ì—ë””í„°ì— ì‚½ì…',aiNotice:'âš ï¸ ì¸ê³µì§€ëŠ¥ ëª¨ë¸ì€ ì‹¤ìˆ˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ì •ë³´ëŠ” ë‹¤ì‹œ í•œ ë²ˆ í™•ì¸í•˜ì„¸ìš”.'},msg:{insertDone:'ì‚½ì…ë˜ì—ˆìŠµë‹ˆë‹¤.',searchTooShort:'ê²€ìƒ‰ì–´ë¥¼ 2ì ì´ìƒ ì…ë ¥í•˜ì„¸ìš”.',noResults:'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.',searchOK:'ê²€ìƒ‰ ê²°ê³¼ë¥¼ ê°€ì ¸ì™”ì–´ìš”.',searchErr:'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´ìš”.',newDoc:'ìƒˆ ë¬¸ì„œë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.',loginOK:'ë¡œê·¸ì¸ ì„±ê³µ',loginFail:'ë¡œê·¸ì¸ ì‹¤íŒ¨',needLogin:'ë¨¼ì € ë¡œê·¸ì¸í•´ ì£¼ì„¸ìš”.',logoutOK:'ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.',pdfFail:'PDF ì €ì¥ ì‹¤íŒ¨',pdfOK:'âœ… PDFë¡œ ì €ì¥í–ˆì–´ìš”',fileOK:'âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í–ˆì–´ìš”',exportFail:'ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨',exportOK:'âœ… Driveë¡œ ë‚´ë³´ë‚´ê¸° ì™„ë£Œ',cloudLoaded:'â˜ï¸ í´ë¼ìš°ë“œ ì´ˆì•ˆì„ ë¶ˆëŸ¬ì™”ì–´ìš”.',docLoaded:'ë¬¸ì„œë¥¼ ë¶ˆëŸ¬ì™”ì–´ìš”.',consentSaved:'ë™ì˜ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',consentOff:'ì¶”ì²œ ì—ë””í„°ê°€ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.',attachOK:'ì²¨ë¶€ë¥¼ ì‚½ì…í–ˆì–´ìš”.',popupBlocked:'íŒì—…ì´ ì°¨ë‹¨ë˜ì–´ ë§í¬ë¥¼ ë³µì‚¬í–ˆì–´ìš”!'}},
    en:{ui:{authLogin:'Sign in with Google',authLogout:'Sign out',save:'Save',chat:'Chat',theme:'Theme',settings:'Settings',help:'Help',naver:'Naver Blog',twitter:'X (Twitter)',documents:'Documents',chats:'Chat History',newDoc:'â• New document',newDocCTA:'+ New document',empty:'No documents yet.',searchPH:'Search (/ or Ctrl+K)',searchBtn:'Search',savePdf:'Save as PDF',saveHtml:'Save to device (HTML)',exportDrive:'Export to Drive (Google Docs)',drawerClose:'Close',drawerLang:'Language',drawerMode:'Mode',consentTitle:'Privacy Notice',consentBody:'You can use the service without signing in. ...',privacy:'View Privacy Policy',tos:'View Terms of Service',agree:'Agree',decline:'Decline',badgeOn:'Suggest ON',badgeOff:'Suggest OFF',badgeWait:'Pending',helpTitle:'Help',helpHtml:`<ul style="line-height:1.8;margin-left:1rem"><li>Draft & summarize</li><li>Insert web results</li><li>PII masking</li><li>Copy / paste shortcuts</li><li><a href="${PRIV_LINK}" target="_blank" rel="noopener">Privacy Policy</a> Â· <a href="${TOS_LINK}" target="_blank" rel="noopener">Terms of Service</a></li></ul>`,settingsTitle:'Settings',labelSuggest:'Use suggestion editor',labelInstant:'Instant suggestions (mobile)',labelPdfMask:'Apply masking when saving PDF',labelPiiHighlight:'Show PII highlight in editor',reopenConsent:'Review privacy consent',toggleTheme:'Toggle theme',chatTitle:'ğŸ’¬ GPT-Nano Chat',chatFull:'â¤¢ Full',chatClose:'Close',chatPH:'Press Enter to send',jumpFirst:'Top result',jumpOpen:'Open now',jumpInsert:'Insert to editor',aiNotice:'âš ï¸ AI models can make mistakes. Please double-check important information.'},msg:{insertDone:'Inserted.',searchTooShort:'Type at least 2 characters.',noResults:'No results.',searchOK:'Inserted a search result.',searchErr:'Search failed.',newDoc:'Starting a new document.',loginOK:'Signed in.',loginFail:'Failed to handle sign-in.',needLogin:'Please sign in first.',logoutOK:'Signed out.',pdfFail:'Failed to create PDF â€” please try again.',pdfOK:'âœ… Saved as PDF',fileOK:'âœ… Started downloading the file',exportFail:'Export failed â€” please try again.',exportOK:'âœ… Exported to Google Docs',cloudLoaded:'â˜ï¸ Loaded your cloud draft.',docLoaded:'Loaded the document.',consentSaved:'Consent saved.',consentOff:'Suggestion editor will be disabled.',attachOK:'Attachment inserted.',popupBlocked:'Popup blocked; copied the link instead!'}},
    ja:{ui:{authLogin:'Googleã§ãƒ­ã‚°ã‚¤ãƒ³',authLogout:'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',save:'ä¿å­˜',chat:'ãƒãƒ£ãƒƒãƒˆ',theme:'ãƒ†ãƒ¼ãƒ',settings:'è¨­å®š',help:'ãƒ˜ãƒ«ãƒ—',naver:'ãƒã‚¤ãƒãƒ¼ãƒ–ãƒ­ã‚°',twitter:'X(æ—§Twitter)',documents:'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',chats:'ãƒãƒ£ãƒƒãƒˆå±¥æ­´',newDoc:'â• æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',newDocCTA:'+ æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ',empty:'ã¾ã ä¿å­˜ã•ã‚ŒãŸæ–‡æ›¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚',searchPH:'æ¤œç´¢ (/ ã¾ãŸã¯ Ctrl+K)',searchBtn:'æ¤œç´¢',savePdf:'PDFã§ä¿å­˜',saveHtml:'ç«¯æœ«ã«ä¿å­˜(HTML)',exportDrive:'Driveã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ(Google Docs)',drawerClose:'é–‰ã˜ã‚‹',drawerLang:'Language',drawerMode:'Mode',consentTitle:'å€‹äººæƒ…å ±ã®å–æ‰±ã„',consentBody:'ã‚µã‚¤ãƒ³ã‚¤ãƒ³ãªã—ã§ã‚‚åˆ©ç”¨ã§ãã¾ã™ãŒâ€¦',privacy:'ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼',tos:'åˆ©ç”¨è¦ç´„',agree:'åŒæ„',decline:'æ‹’å¦',badgeOn:'ææ¡ˆ ON',badgeOff:'ææ¡ˆ OFF',badgeWait:'ä¿ç•™',helpTitle:'ãƒ˜ãƒ«ãƒ—',helpHtml:`<ul style="line-height:1.8;margin-left:1rem"><li>ä¸‹æ›¸ãï¼†è¦ç´„</li><li>ã‚¦ã‚§ãƒ–çµæœã®æŒ¿å…¥</li><li>PIIãƒã‚¹ã‚­ãƒ³ã‚°</li><li>ã‚³ãƒ”ãƒ¼/ãƒšãƒ¼ã‚¹ãƒˆã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</li><li><a href="${PRIV_LINK}" target="_blank" rel="noopener">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> Â· <a href="${TOS_LINK}" target="_blank" rel="noopener">åˆ©ç”¨è¦ç´„</a></li></ul>`,settingsTitle:'è¨­å®š',labelSuggest:'ææ¡ˆã‚¨ãƒ‡ã‚£ã‚¿ã‚’ä½¿ç”¨',labelInstant:'ãƒ¢ãƒã‚¤ãƒ«å³æ™‚ææ¡ˆ',labelPdfMask:'PDFä¿å­˜æ™‚ã«ãƒã‚¹ã‚­ãƒ³ã‚°',labelPiiHighlight:'ã‚¨ãƒ‡ã‚£ã‚¿ã§PIIã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ',reopenConsent:'åŒæ„ã‚’å†è¨­å®š',toggleTheme:'ãƒ†ãƒ¼ãƒåˆ‡æ›¿',chatTitle:'ğŸ’¬ GPT-Nano Chat',chatFull:'â¤¢ å…¨ç”»é¢',chatClose:'é–‰ã˜ã‚‹',chatPH:'Enterã§é€ä¿¡',jumpFirst:'ä¸Šä½çµæœ',jumpOpen:'ä»Šã™ãé–‹ã',jumpInsert:'ã‚¨ãƒ‡ã‚£ã‚¿ã«æŒ¿å…¥',aiNotice:'âš ï¸ AIãƒ¢ãƒ‡ãƒ«ã¯é–“é•ãˆã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚é‡è¦ãªæƒ…å ±ã¯å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚'},msg:{insertDone:'æŒ¿å…¥ã—ã¾ã—ãŸã€‚',searchTooShort:'2æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚',noResults:'çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚',searchOK:'æ¤œç´¢çµæœã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚',searchErr:'æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚',newDoc:'æ–°ã—ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’é–‹å§‹ã—ã¾ã™ã€‚',loginOK:'ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸ',loginFail:'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—',needLogin:'å…ˆã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚',logoutOK:'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚',pdfFail:'PDFã®ä½œæˆã«å¤±æ•—',pdfOK:'âœ… PDFã§ä¿å­˜ã—ã¾ã—ãŸ',fileOK:'âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚’é–‹å§‹ã—ã¾ã—ãŸ',exportFail:'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—',exportOK:'âœ… Google Docsã¸ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†',cloudLoaded:'â˜ï¸ ã‚¯ãƒ©ã‚¦ãƒ‰ä¸‹æ›¸ãã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚',docLoaded:'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚',consentSaved:'åŒæ„ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚',consentOff:'ææ¡ˆã‚¨ãƒ‡ã‚£ã‚¿ã¯ç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚',attachOK:'æ·»ä»˜ã‚’æŒ¿å…¥ã—ã¾ã—ãŸã€‚',popupBlocked:'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'}},
    fr:{ui:{authLogin:'Se connecter avec Google',authLogout:'Se dÃ©connecter',save:'Enregistrer',chat:'Chat',theme:'ThÃ¨me',settings:'ParamÃ¨tres',help:'Aide',naver:'Blog Naver',twitter:'X (Twitter)',documents:'Documents',chats:'Historique des chats',newDoc:'â• Nouveau document',newDocCTA:'+ Nouveau document',empty:'Aucun document pour le moment.',searchPH:'Rechercher (/ ou Ctrl+K)',searchBtn:'Rechercher',savePdf:'Enregistrer en PDF',saveHtml:'Enregistrer sur lâ€™appareil (HTML)',exportDrive:'Exporter vers Drive (Google Docs)',drawerClose:'Fermer',drawerLang:'Langue',drawerMode:'Mode',consentTitle:'Informations sur la confidentialitÃ©',consentBody:'Vous pouvez utiliser le service sans vous connecter...',privacy:'Voir la politique de confidentialitÃ©',tos:'Voir les conditions dâ€™utilisation',agree:'Accepter',decline:'Refuser',badgeOn:'Suggestions ON',badgeOff:'Suggestions OFF',badgeWait:'En attente',helpTitle:'Aide',helpHtml:`<ul style="line-height:1.8;margin-left:1rem"><li>RÃ©diger & rÃ©sumer</li><li>InsÃ©rer des rÃ©sultats Web</li><li>Masquage des informations personnelles</li><li>Bouton Copier / Raccourci Coller</li><li><a href="${PRIV_LINK}" target="_blank" rel="noopener">Politique de confidentialitÃ©</a> Â· <a href="${TOS_LINK}" target="_blank" rel="noopener">Conditions dâ€™utilisation</a></li></ul>`,settingsTitle:'ParamÃ¨tres',labelSuggest:'Activer lâ€™Ã©diteur de suggestions',labelInstant:'Suggestions instantanÃ©es (mobile)',labelPdfMask:'Masquer les PII lors de lâ€™export PDF',labelPiiHighlight:'Afficher la mise en Ã©vidence PII',reopenConsent:'GÃ©rer le consentement',toggleTheme:'Basculer le thÃ¨me',chatTitle:'ğŸ’¬ GPT-Nano Chat',chatFull:'â¤¢ Plein Ã©cran',chatClose:'Fermer',chatPH:'Appuyez sur EntrÃ©e pour envoyer',jumpFirst:'Meilleur rÃ©sultat',jumpOpen:'Ouvrir',jumpInsert:'InsÃ©rer dans lâ€™Ã©diteur',aiNotice:'âš ï¸ Les modÃ¨les dâ€™IA peuvent se tromper. Veuillez revÃ©rifier les informations importantes.'},msg:{insertDone:'InsÃ©rÃ©.',searchTooShort:'Saisissez au moins 2 caractÃ¨res.',noResults:'Aucun rÃ©sultat.',searchOK:'RÃ©sultat insÃ©rÃ©.',searchErr:'Ã‰chec de la recherche.',newDoc:'Nouveau document dÃ©marrÃ©.',loginOK:'ConnectÃ©.',loginFail:'Ã‰chec de connexion.',needLogin:'Veuillez vous connecter.',logoutOK:'DÃ©connectÃ©.',pdfFail:'Ã‰chec de crÃ©ation du PDF.',pdfOK:'âœ… EnregistrÃ© en PDF',fileOK:'âœ… TÃ©lÃ©chargement lancÃ©',exportFail:'Ã‰chec de lâ€™exportation.',exportOK:'âœ… ExportÃ© vers Google Docs',cloudLoaded:'â˜ï¸ Brouillon cloud chargÃ©.',docLoaded:'Document chargÃ©.',consentSaved:'Consentement enregistrÃ©.',consentOff:'Lâ€™Ã©diteur de suggestions sera dÃ©sactivÃ©.',attachOK:'PiÃ¨ce jointe insÃ©rÃ©e.',popupBlocked:'Popup bloquÃ©e ; lien copiÃ© !'}},
    vi:{ui:{authLogin:'ÄÄƒng nháº­p báº±ng Google',authLogout:'ÄÄƒng xuáº¥t',save:'LÆ°u',chat:'TrÃ² chuyá»‡n',theme:'Chá»§ Ä‘á»',settings:'CÃ i Ä‘áº·t',help:'Trá»£ giÃºp',naver:'Blog Naver',twitter:'X (Twitter)',documents:'TÃ i liá»‡u',chats:'Lá»‹ch sá»­ trÃ² chuyá»‡n',newDoc:'â• TÃ i liá»‡u má»›i',newDocCTA:'+ TÃ i liá»‡u má»›i',empty:'ChÆ°a cÃ³ tÃ i liá»‡u nÃ o.',searchPH:'TÃ¬m kiáº¿m (/ hoáº·c Ctrl+K)',searchBtn:'TÃ¬m',savePdf:'LÆ°u PDF',saveHtml:'LÆ°u vá» mÃ¡y (HTML)',exportDrive:'Xuáº¥t sang Drive (Google Docs)',drawerClose:'ÄÃ³ng',drawerLang:'NgÃ´n ngá»¯',drawerMode:'Cháº¿ Ä‘á»™',consentTitle:'ThÃ´ng bÃ¡o quyá»n riÃªng tÆ°',consentBody:'Báº¡n cÃ³ thá»ƒ dÃ¹ng dá»‹ch vá»¥ mÃ  khÃ´ng cáº§n Ä‘Äƒng nháº­p...',privacy:'Xem ChÃ­nh sÃ¡ch quyá»n riÃªng tÆ°',tos:'Xem Äiá»u khoáº£n dá»‹ch vá»¥',agree:'Äá»“ng Ã½',decline:'Tá»« chá»‘i',badgeOn:'Gá»£i Ã½ Báº¬T',badgeOff:'Gá»£i Ã½ Táº®T',badgeWait:'Äang chá»',helpTitle:'Trá»£ giÃºp',helpHtml:`<ul style="line-height:1.8;margin-left:1rem"><li>Soáº¡n & tÃ³m táº¯t</li><li>ChÃ¨n káº¿t quáº£ web</li><li>áº¨n thÃ´ng tin nháº¡y cáº£m (PII)</li><li>NÃºt Sao chÃ©p / phÃ­m táº¯t DÃ¡n</li><li><a href="${PRIV_LINK}" target="_blank" rel="noopener">ChÃ­nh sÃ¡ch quyá»n riÃªng tÆ°</a> Â· <a href="${TOS_LINK}" target="_blank" rel="noopener">Äiá»u khoáº£n dá»‹ch vá»¥</a></li></ul>`,settingsTitle:'CÃ i Ä‘áº·t',labelSuggest:'DÃ¹ng trÃ¬nh biÃªn táº­p gá»£i Ã½',labelInstant:'Gá»£i Ã½ tá»©c thá»i (di Ä‘á»™ng)',labelPdfMask:'áº¨n PII khi xuáº¥t PDF',labelPiiHighlight:'Hiá»ƒn thá»‹ tÃ´ sÃ¡ng PII',reopenConsent:'Quáº£n lÃ½ cháº¥p thuáº­n',toggleTheme:'Äá»•i chá»§ Ä‘á»',chatTitle:'ğŸ’¬ GPT-Nano Chat',chatFull:'â¤¢ ToÃ n mÃ n hÃ¬nh',chatClose:'ÄÃ³ng',chatPH:'Nháº¥n Enter Ä‘á»ƒ gá»­i',jumpFirst:'Káº¿t quáº£ hÃ ng Ä‘áº§u',jumpOpen:'Má»Ÿ',jumpInsert:'ChÃ¨n vÃ o trÃ¬nh biÃªn táº­p',aiNotice:'âš ï¸ MÃ´ hÃ¬nh AI cÃ³ thá»ƒ máº¯c lá»—i. HÃ£y kiá»ƒm tra láº¡i thÃ´ng tin quan trá»ng.'},msg:{insertDone:'ÄÃ£ chÃ¨n.',searchTooShort:'Nháº­p Ã­t nháº¥t 2 kÃ½ tá»±.',noResults:'KhÃ´ng cÃ³ káº¿t quáº£.',searchOK:'ÄÃ£ chÃ¨n káº¿t quáº£ tÃ¬m kiáº¿m.',searchErr:'TÃ¬m kiáº¿m tháº¥t báº¡i.',newDoc:'Báº¯t Ä‘áº§u tÃ i liá»‡u má»›i.',loginOK:'ÄÃ£ Ä‘Äƒng nháº­p.',loginFail:'ÄÄƒng nháº­p tháº¥t báº¡i.',needLogin:'Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c.',logoutOK:'ÄÃ£ Ä‘Äƒng xuáº¥t.',pdfFail:'Táº¡o PDF tháº¥t báº¡i.',pdfOK:'âœ… ÄÃ£ lÆ°u PDF',fileOK:'âœ… Báº¯t Ä‘áº§u táº£i xuá»‘ng',exportFail:'Xuáº¥t tháº¥t báº¡i.',exportOK:'âœ… ÄÃ£ xuáº¥t sang Google Docs',cloudLoaded:'â˜ï¸ ÄÃ£ táº£i báº£n nhÃ¡p trÃªn Ä‘Ã¡m mÃ¢y.',docLoaded:'ÄÃ£ táº£i tÃ i liá»‡u.',consentSaved:'ÄÃ£ lÆ°u cháº¥p thuáº­n.',consentOff:'TrÃ¬nh gá»£i Ã½ sáº½ bá»‹ táº¯t.',attachOK:'ÄÃ£ chÃ¨n tá»‡p Ä‘Ã­nh kÃ¨m.',popupBlocked:'Cá»­a sá»• báº­t lÃªn bá»‹ cháº·n; Ä‘Ã£ sao chÃ©p liÃªn káº¿t!'}}
  };

  // ì „ì—­ ìƒíƒœ
  let uiLang = localStorage.getItem('lang') || 'ko';
  let L = I18N[uiLang] || I18N.ko;

  function applyLang(lang){
    uiLang = ['ko','en','ja','fr','vi'].includes(lang)?lang:'ko';
    L = I18N[uiLang] || I18N.ko;

    $('#saveBtn').textContent = 'ğŸ’¾ '+L.ui.save;
    $('#chatBtn').textContent = 'ğŸ’¬ '+L.ui.chat;
    $('#themeBtn').textContent = 'ğŸŒ™ '+L.ui.theme;
    $('#settingsBtn').textContent = 'âš™ï¸ '+L.ui.settings;
    $('#helpBtn').textContent = 'â“ '+L.ui.help;
    $('#shareNaverBtn').textContent = L.ui.naver;
    $('#shareTwitterBtn').textContent = L.ui.twitter;
    $('#docListTitle').textContent = L.ui.documents;
    $('#chatListTitle').textContent = L.ui.chats;
    $('#newDocBtn').textContent = L.ui.newDoc;
    if($('#newDocCTA')) $('#newDocCTA').textContent = L.ui.newDocCTA;
    $('#emptyText').textContent = L.ui.empty;
    $('#searchInput').placeholder = L.ui.searchPH;
    $('#searchBtnText').textContent = L.ui.searchBtn;
    $('#saveMenuPdf span').textContent = L.ui.savePdf;
    $('#saveMenuDevice span').textContent = L.ui.saveHtml;
    $('#exportBtn span').textContent = L.ui.exportDrive;

    $('#labelLang').textContent = L.ui.drawerLang;
    $('#labelMode').textContent = L.ui.drawerMode;

    $('#chatTitle').textContent = L.ui.chatTitle;
    $('#chatFullscreenToggle').textContent = L.ui.chatFull;
    $('#chatClose').textContent = L.ui.chatClose;
    $('#chatInput').placeholder = L.ui.chatPH;

    $('#aiNotice').textContent = L.ui.aiNotice || '';

    localStorage.setItem('lang', uiLang);
    if($('#languageSelect')) $('#languageSelect').value = uiLang;
    if($('#languageSelectMobile')) $('#languageSelectMobile').value = uiLang;
    document.documentElement.setAttribute('lang', uiLang);

    const sj=$('#searchJump'); if(sj) sj.style.display='none';
  }

  /* ===== caches ===== */
  const AI_CACHE_KEY = 'thinkhelper:aiCache:v1';
  const CHAT_CACHE_KEY = 'thinkhelper:chatCache:v1';
  const loadCache = (k)=>{try{return JSON.parse(localStorage.getItem(k)||'{}')}catch(_){return{}}};
  const saveCache = (k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch(_){}};
  const aiCache = loadCache(AI_CACHE_KEY);
  const chatCache = loadCache(CHAT_CACHE_KEY);
  const cacheKeyFromIntent = (intent)=>[uiLang,intent.type||'next',(intent.topic||'').toLowerCase().trim().slice(0,80)].join('|');

  /* ===== suggestion engine (ë¡œì»¬ + gptnano) ===== */
  const LOCAL_KB = {'í•œí™”ê·¸ë£¹':{pros:['ë°©ì‚°Â·ì—ë„ˆì§€ ì¤‘ì‹¬ í¬íŠ¸í´ë¦¬ì˜¤ë¡œ ê²½ê¸° ë³€ë™ ë¶„ì‚°.','ìš°ì£¼Â·ì²¨ë‹¨ì†Œì¬Â·AI ë“± ì‹ ì„±ì¥ íˆ¬ì í™•ëŒ€.','ESG ê²½ì˜ê³¼ ì‚¬íšŒê³µí—Œ í™œë™ì„ ì§€ì†ì ìœ¼ë¡œ ê°•í™”.'],cons:['ëŒ€ê·œëª¨ íˆ¬ìì— ë”°ë¥¸ ì¬ë¬´ ë ˆë²„ë¦¬ì§€ì™€ íšŒìˆ˜ ê¸°ê°„ ë¶€ë‹´.','ì£¼ìš” ì‚¬ì—…ì˜ ëŒ€ì™¸ ë³€ë™ì„± ë° ê²½ê¸° ë¯¼ê°ë„ ë†’ìŒ.','ì‚¬ì—…Â·ì§€ë°°êµ¬ì¡° ë‹¨ìˆœí™” ë° ì‹œë„ˆì§€ ê·¹ëŒ€í™” ê³¼ì œê°€ ë‚¨ìŒ.']}};

  function sanitizeLine(s){
    if(!s) return '';
    let t=String(s).replace(/\u00A0/g,' ').replace(/&nbsp;?/gi,' ').replace(/&amp;?/gi,' ë° ').replace(/&[a-zA-Z]+;?/g,' ').replace(/[?ï¼Ÿ]+$/,'').replace(/^\s*[-â€¢â—]\s*/,'').replace(/\s{2,}/g,' ').trim();
    if(t.length<2) return '';
    if(!/[.!?â€¦]$/.test(t)) t+=(uiLang==='ko'?'':'')+'.';
    t=t.replace(/\s+\./g,'.'); return t;
  }
  function textBeforeCaret(max=140){
    const sel=window.getSelection(); if(!sel||!sel.anchorNode) return '';
    const nodeText=sel.anchorNode.textContent||''; const off=Math.min(sel.anchorOffset||0,nodeText.length);
    return nodeText.slice(Math.max(0,off-max), off);
  }
  function fallbackDetectIntent(ctx){
    const s=(ctx||'').replace(/\s+/g,' ').trim();
    const m=s.match(/([ê°€-í£A-Za-z0-9&\s]{1,40})(?:ì˜|ì—\s*ëŒ€í•œ)?\s*(ì¥ë‹¨ì |ì¥ì |ë‹¨ì )$/);
    if(m){ const topic=m[1].trim().replace(/&/g,' ').replace(/^(ì—\s*ëŒ€í•œ|ê´€ë ¨)\s*/,'').trim(); return {type:'proscons',topic}; }
    if(/ì‹¤í–‰|ë‹¤ìŒ\s*ë‹¨ê³„|ë¡œë“œë§µ|ê³„íš$/.test(s)) return {type:'plan',topic:''};
    if(/ë³´ê³ ì„œ|ì œì•ˆì„œ|ê¸°íšì•ˆ|ëª©ì°¨$/.test(s)) return {type:'report',topic:''};
    if(/ì¸ê³µì§€ëŠ¥|AI/i.test(s)) return {type:'value',topic:'ì¸ê³µì§€ëŠ¥ì´ ìš°ë¦¬ì—ê²Œ ì œê³µí•˜ëŠ” ê°€ì¹˜'};
    return {type:'next',topic:''};
  }
  function localSuggestions(intent){
    const list=[];
    if(intent.type==='proscons'){
      const k=LOCAL_KB[intent.topic];
      if(k){ k.pros.forEach(v=>list.push('ì¥ì : '+v)); k.cons.forEach(v=>list.push('ë‹¨ì : '+v)); list.push('ìš”ì•½: ì„±ì¥ ê¸°íšŒëŠ” í¬ë‚˜ ì¬ë¬´Â·ëŒ€ì™¸ ë¦¬ìŠ¤í¬ ê´€ë¦¬ê°€ í•µì‹¬.'); }
      else list.push('ì¥ì : í•µì‹¬ ì—­ëŸ‰ìœ¼ë¡œ ì‹œì¥ ì‹ ë¢°ì™€ ì ìœ ìœ¨ì„ í™•ë³´í•œë‹¤.','ì¥ì : í¬íŠ¸í´ë¦¬ì˜¤ ë‹¤ë³€í™”ë¡œ ë¦¬ìŠ¤í¬ë¥¼ ë¶„ì‚°í•œë‹¤.','ë‹¨ì : ì™¸ë¶€ ë³€ìˆ˜ì— ë”°ë¥¸ ì‹¤ì  ë³€ë™ì„±ì´ ì¡´ì¬í•œë‹¤.','ë‹¨ì : íˆ¬ì í™•ëŒ€ì— ë”°ë¥¸ ë¹„ìš©Â·í˜„ê¸ˆíë¦„ ë¶€ë‹´ì´ ë’¤ë”°ë¥¸ë‹¤.','ìš”ì•½: ê°•ì ì€ ë¶„ëª…í•˜ì§€ë§Œ ì•ˆì •ì  ì‹¤í–‰ê³¼ ë¦¬ìŠ¤í¬ ê´€ë¦¬ê°€ í•„ìš”í•˜ë‹¤.');
    }else if(intent.type==='plan'){
      list.push('ë‹¤ìŒ ë‹¨ê³„: ëª©í‘œë¥¼ ìˆ˜ì¹˜ë¡œ ì •ì˜í•˜ê³  ë§ˆì¼ìŠ¤í†¤ì„ í™•ì •í•œë‹¤.','ë‹¤ìŒ ë‹¨ê³„: í•µì‹¬ ì§€í‘œ(KPI)ì™€ ì±…ì„ìë¥¼ ì§€ì •í•œë‹¤.','ë‹¤ìŒ ë‹¨ê³„: ë¦¬ìŠ¤í¬Â·ì˜ì¡´ì„±ì„ ì‚¬ì „ì— ëª©ë¡í™”í•˜ê³  ì™„í™”ì•ˆì„ ë§ˆë ¨í•œë‹¤.','ë‹¤ìŒ ë‹¨ê³„: 2ì£¼ ë‹¨ìœ„ ì ê²€ ë¦¬ë“¬ì„ ì„¤ì •í•œë‹¤.');
    }else if(intent.type==='report'){
      list.push('ëª©ì°¨: ê°œìš” â†’ ë¬¸ì œì •ì˜ â†’ ë°ì´í„°ë¶„ì„ â†’ ëŒ€ì•ˆ â†’ ì‹¤í–‰ê³„íš â†’ ë¦¬ìŠ¤í¬ â†’ ê²°ë¡ .','ì„œë¡ : ë³¸ ë³´ê³ ì„œëŠ” í•µì‹¬ ìŸì ê³¼ ì‹¤í–‰ ê°€ëŠ¥í•œ ëŒ€ì•ˆì„ ê°„ê²°íˆ ì œì‹œí•œë‹¤.','í•µì‹¬ ìš”ì•½: ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ì›ì¸ì„ ê·œëª…í•˜ê³  ìš°ì„ ìˆœìœ„ë¥¼ ì œì•ˆí•œë‹¤.','ê²°ë¡ : ë‹¨ê³„ì  ì‹¤í–‰ìœ¼ë¡œ íš¨ê³¼ë¥¼ ê·¹ëŒ€í™”í•˜ê³  ë¦¬ìŠ¤í¬ë¥¼ í†µì œí•œë‹¤.');
    }else if(intent.type==='value'){
      list.push('í•µì‹¬ ê°€ì¹˜: ìƒì‚°ì„± ìë™í™”ì™€ ì˜ì‚¬ê²°ì • ë³´ì¡°ë¡œ ì‹œê°„Â·ë¹„ìš©ì„ ì ˆê°í•œë‹¤.','í•µì‹¬ ê°€ì¹˜: ê°œì¸í™” ì¶”ì²œê³¼ ì°½ì‘ ë³´ì¡°ë¡œ ì‚¬ìš©ì ê²½í—˜ì„ í–¥ìƒí•œë‹¤.','í•µì‹¬ ê°€ì¹˜: ë°˜ë³µ ì‘ì—… í‘œì¤€í™”ë¡œ í’ˆì§ˆì„ ê· ì¼í™”í•œë‹¤.','ì ìš© ì˜ˆ: ê³ ê°ì§€ì› ìš”ì•½Â·ì´ˆì•ˆ ìƒì„±Â·QA ìë™ì‘ë‹µì„ ë‹¨ê³„ì  ë„ì….');
    }else{
      const last=textBeforeCaret(20);
      if(/[ì€ëŠ”ì´ê°€]$/.test(last)) list.push('ì¦‰, í•µì‹¬ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.');
      list.push('í•µì‹¬ ìš”ì ë¶€í„° ê°„ê²°í•˜ê²Œ ì •ë¦¬í•œë‹¤.','ê·¼ê±° ë°ì´í„°ë¥¼ ì œì‹œí•´ ì£¼ì¥ì„ ëª…í™•íˆ í•œë‹¤.','ë‹¤ìŒ ë‹¨ê³„ì˜ ì‹¤í–‰ ê³„íšì„ êµ¬ì²´í™”í•œë‹¤.');
    }
    return list;
  }

  async function requestNanoJSON(prompt, timeoutMs=1800){
    const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs);
    try{
      const r=await fetch(apiUrl('chat'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'gptnano',input:prompt,response_format:'json'}),signal:ctrl.signal});
      clearTimeout(t); if(!r.ok) return null;
      const j=await r.json();
      if(j && Array.isArray(j.suggestions)) return j;
      const raw=j?.text||j?.output||''; if(!raw) return null;
      return {suggestions:String(raw).split(/\r?\n/).map(sanitizeLine).filter(Boolean)};
    }catch(e){ clearTimeout(t); return null; }
  }

  async function smartSuggest(ctx){
    let intent=fallbackDetectIntent(ctx||'');
    const context=(ctx||'').trim();
    const editorHead=htmlToText((window.editor && editor.getData && editor.getData())||'').slice(0,220);

    const key=cacheKeyFromIntent(intent);
    if(aiCache[key]) return aiCache[key].slice(0,8);

    if(isOnline()){
      const prompt=`ì—­í• : í•œêµ­ì–´ ê¸€ì“°ê¸° ë³´ì¡°.
ì•„ë˜ ë¬¸ë§¥ì—ì„œ "ì£¼ì œ(topic)"ì™€ "ì˜ë„(intent)"ë¥¼ ì¶”ë¡ í•˜ê³ , ì£¼ì œì— ë§ëŠ” í•œ ì¤„ ì œì•ˆ 4~8ê°œë¥¼ ë§Œë“¤ì–´ JSONìœ¼ë¡œë§Œ ì‘ë‹µí•˜ì„¸ìš”.
ê·œì¹™: ì§ˆë¬¸í˜• ê¸ˆì§€, íŠ¹ìˆ˜ê¸°í˜¸ & ê¸ˆì§€, ë„ˆë¬´ ì¥ë¬¸ ê¸ˆì§€(í•œ ì¤„ 40ì ë‚´ì™¸).
ê°€ëŠ¥í•œ intent: ["proscons","plan","report","value","next"]
ì‘ë‹µ ì˜ˆì‹œ: {"topic":"ì¸ê³µì§€ëŠ¥ì´ ìš°ë¦¬ì—ê²Œ ì œê³µí•˜ëŠ” ê°€ì¹˜","intent":"value","suggestions":["í•µì‹¬ ê°€ì¹˜: ...","..."]}
ë¬¸ë§¥:
- ì»¤ì„œ ì¸ê·¼: """${context}"""
- ë¬¸ì„œ ì„œë‘: """${editorHead}"""
í˜„ì¬ ì¶”ì • intent: "${intent.type||'next'}"`;
      const res=await requestNanoJSON(prompt,1800);
      if(res && Array.isArray(res.suggestions) && res.suggestions.length){
        if(res.intent) intent.type=String(res.intent).trim()||intent.type;
        if(res.topic) intent.topic=String(res.topic).trim()||intent.topic;
        const cleaned=Array.from(new Set(res.suggestions.map(sanitizeLine))).filter(Boolean).slice(0,8);
        if(cleaned.length){ aiCache[cacheKeyFromIntent(intent)]=cleaned; saveCache(AI_CACHE_KEY,aiCache); return cleaned; }
      }
    }
    const fb=localSuggestions(intent).map(sanitizeLine).filter(Boolean).slice(0,8);
    if(fb.length){ aiCache[cacheKeyFromIntent(intent)]=fb; saveCache(AI_CACHE_KEY,aiCache); }
    return fb;
  }

  function positionSuggestions(){
    const el=$('#suggestions'); if(!el) return;
    const sel=window.getSelection(); let rect=null;
    try{ rect=sel?.rangeCount? sel.getRangeAt(0).getClientRects?.()[0] : null; }catch{ rect=null; }
    const fallback=$('#editor').getBoundingClientRect(); const r=rect||fallback;
    el.style.left=Math.max(8,(r.left||fallback.left)+12)+'px';
    el.style.top=((r.bottom||fallback.top+48)+6)+'px';
  }
  function insertAtCursorText(text){
    if(!editor||!text) return;
    const clean=sanitizeLine(text); if(!clean) return;
    editor.model.change(w=>{ const node=w.createText(clean+' '); editor.model.insertContent(node, editor.model.document.selection); });
    showToast(L.msg.insertDone,900);
  }
  let suggestionIndex=-1, currentSuggestions=[];
  function renderSuggestions(list){
    const el=$('#suggestions');
    if(!list||!list.length){ el.style.display='none'; suggestionIndex=-1; currentSuggestions=[]; return; }
    const safe=window.DOMPurify?.sanitize||(x=>x);
    el.innerHTML=list.map((t,i)=>`<div class="suggestion-item" data-i="${i}">${safe(t)}</div>`).join('');
    el.querySelectorAll('.suggestion-item').forEach(n=> n.onclick=()=>{ insertAtCursorText(list[+n.dataset.i]); el.style.display='none'; });
    currentSuggestions=list; suggestionIndex=0; document.querySelectorAll('#suggestions .suggestion-item').forEach((n,i)=> n.classList.toggle('selected',i===suggestionIndex));
    el.style.display='block'; requestAnimationFrame(positionSuggestions);
  }
  function highlightSuggestion(){ document.querySelectorAll('#suggestions .suggestion-item').forEach((n,i)=> n.classList.toggle('selected',i===suggestionIndex)); }

  let editor, piiLockActive=false;
  let enableSuggestions=(localStorage.getItem('enableSuggestions')!=='false');
  let enableInstant=(localStorage.getItem('enableInstant')!=='false');
  const STOP_WORDS=new Set(['nbsp','amp','lt','gt','quot','apos','copy','reg','deg','ndash','mdash','â„¢','Â®','Â©','Â·','â€¢','â€”','â€“','...','â€¦','',' ']);

  async function updateEditorSuggestions(){
    const box=$('#suggestions');
    if(!enableSuggestions || piiLockActive){ if(box) box.style.display='none'; return; }
    const ctx=textBeforeCaret(120);
    if(!ctx.trim()){ if(box) box.style.display='none'; return; }
    window.updateEditorSuggestions=updateEditorSuggestions;
    const list=(await smartSuggest(ctx)).map(sanitizeLine).filter(Boolean).filter(s=>!STOP_WORDS.has(s.toLowerCase())).slice(0,8);
    renderSuggestions(list);
  }

  document.addEventListener('keydown',function(e){
    const el=$('#suggestions'); const visible=el&&el.style.display==='block';
    if(visible && currentSuggestions.length){
      if(e.key==='ArrowDown'){ e.preventDefault(); suggestionIndex=(suggestionIndex+1)%currentSuggestions.length; highlightSuggestion(); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); suggestionIndex=(suggestionIndex-1+currentSuggestions.length)%currentSuggestions.length; highlightSuggestion(); }
      else if(e.key==='Tab' && !e.ctrlKey && !e.metaKey){ e.preventDefault(); const idx=suggestionIndex>=0?suggestionIndex:0; insertAtCursorText(currentSuggestions[idx]); el.style.display='none'; }
      else if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); const idx=suggestionIndex>=0?suggestionIndex:0; insertAtCursorText(currentSuggestions[idx]); el.style.display='none'; }
      else if(e.key==='Escape'){ el.style.display='none'; }
    }
  });

  function showToast(text,ms=2300){
    const t=document.createElement('div'); t.className='toast'; t.textContent=text;
    Object.assign(t.style,{position:'fixed',left:'50%',transform:'translateX(-50%)',bottom:'18px',background:'#333',color:'#fff',padding:'.6rem .9rem',borderRadius:'8px',zIndex:3000});
    document.body.appendChild(t);
    setTimeout(()=>{t.style.opacity='0'; t.style.transition='opacity .25s';}, ms-250);
    setTimeout(()=>t.remove(), ms);
  }

  /* ===== local docs ===== */
  const LOCAL_DOCS_KEY='thinkhelper:localDocs:v1';
  const DRAFT_KEY='thinkhelper:editorDraft:v1';
  const loadLocalDocs=()=>{try{return JSON.parse(localStorage.getItem(LOCAL_DOCS_KEY)||'[]');}catch(e){return[];}};
  const saveLocalDocs=(l)=>{try{localStorage.setItem(LOCAL_DOCS_KEY,JSON.stringify(l));}catch(e){}};
  function addLocalDoc(title, html){
    const list=loadLocalDocs(); list.unshift({id:'local-'+Date.now(), title, html, updatedAt:Date.now()});
    saveLocalDocs(list); renderDocList(); return list[0];
  }
  function renderDocList(cloudMeta=null){
    const ul=$('#docList'); if(!ul) return; ul.innerHTML='';
    const safe=window.DOMPurify?.sanitize||(x=>x);
    if(cloudMeta){
      const li=document.createElement('li');
      li.innerHTML=`<span>â˜ï¸ ${safe(cloudMeta.title||'Cloud Draft')}</span><small>${new Date(cloudMeta.updatedAt||Date.now()).toLocaleString()}</small>`;
      li.onclick=()=>{ if(cloudMeta.html){ editor.setData(cloudMeta.html); showToast(L.msg.cloudLoaded); } };
      ul.appendChild(li);
    }
    const list=loadLocalDocs();
    if(!cloudMeta && list.length===0 && ul.children.length===0) $('#emptyCTA').style.display='block';
    else $('#emptyCTA').style.display='none';
    list.forEach(d=>{
      const li=document.createElement('li');
      li.innerHTML=`<span>ğŸ’¾ ${safe(d.title)}</span><small>${new Date(d.updatedAt).toLocaleString()}</small>`;
      li.onclick=()=>{ editor.setData(d.html||''); showToast(L.msg.docLoaded); };
      ul.appendChild(li);
    });
  }

  /* ===== share ===== */
  function openPopup(u){
    const w=600,h=640,y=(window.outerHeight/2+window.screenY-h/2),x=(window.outerWidth/2+window.screenX-w/2);
    const win=window.open(u,'_blank',`noopener,width=${w},height=${h},left=${x},top=${y}`);
    if(!win && navigator.clipboard?.writeText){ navigator.clipboard.writeText(u).then(()=> showToast(L.msg.popupBlocked)); }
  }
  function openExternal(u){
    const win=window.open(u,'_blank','noopener');
    if(!win && navigator.clipboard?.writeText){ navigator.clipboard.writeText(u).then(()=> showToast(L.msg.popupBlocked)); }
  }
  function getSharePayload(){ const html=editor?.getData?.()||''; const text=htmlToText(html); return { title:text.slice(0,80)||'ThinkHelper', url:location.href }; }
  function bindShare(btn,builder){ if(btn) btn.onclick=()=>{ const p=getSharePayload(); openPopup(builder(p.title,p.url)); }; }

  /* ===== CKEditor Upload (base64) ===== */
  const fileToDataURL=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});
  class Base64UploadAdapter{ constructor(loader){this.loader=loader;} async upload(){const f=await this.loader.file;if(f.size>5*1024*1024) throw new Error('ì´ë¯¸ì§€ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤.(ìµœëŒ€ 5MB)'); return {default: await fileToDataURL(f)};} abort(){} }

  /* ===== PII ===== */
  const PII_PATTERNS=[{type:'rrn',rx:/\b\d{6}[- ]?\d{7}\b/g},{type:'card',rx:/\b(?:\d{4}[- ]?){3}\d{4}\b/g},{type:'dl',rx:/\b\d{2}-\d{2}-\d{6}-\d{2}\b/g},{type:'passport',rx:/\b[A-Z]{1}\d{7,8}\b/g},{type:'phone',rx:/\b(?:1\d{2}|01[016789]|0\d{1,2})[- ]?\d{3,4}[- ]?\d{4}\b/g},{type:'email',rx:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}\b/g},{type:'acct',rx:/\b\d{2,6}(?:-\d{2,6}){1,3}\b/g},{type:'addr',rx:/(?:[ê°€-í£]{2,10}(ì‹œ|êµ°|êµ¬))\s?.{0,20}?\d{1,4}(?:-\d{1,3})?\b/g}];
  const NAME_WITH_CUE=/(?:ì´ë¦„|ì„±í•¨|Name)\s*[:ï¼š]?\s*([ê°€-í£]{2,4}|[A-Z][a-z]+(?:\s[A-Z][a-z]+)+)/u;
  function findPIIMatches(text){
    const m=[]; for(const o of PII_PATTERNS){ o.rx.lastIndex=0; let r; while((r=o.rx.exec(text))!==null){ m.push({start:r.index,end:r.index+r[0].length,type:o.type}); } }
    const nm=NAME_WITH_CUE.exec(text); if(nm) m.push({start:nm.index,end:nm.index+nm[0].length,type:'name'});
    m.sort((a,b)=> a.start===b.start? b.end-a.end : a.start-b.start);
    const out=[]; let last=-1;
    for(const x of m){ if(x.start>=last){ out.push(x); last=x.end; } } return out;
  }

  async function copySelection(){
    try{
      const sel=window.getSelection(); const text=sel && sel.toString ? sel.toString() : '';
      if(text){ await navigator.clipboard?.writeText(text); showToast('âœ… Copied'); return; }
    }catch(_){}
    try{
      const tmp=document.createElement('textarea'); tmp.style.position='fixed'; tmp.style.opacity='0';
      tmp.value=htmlToText(editor?.getData?.()||''); document.body.appendChild(tmp); tmp.select(); document.execCommand('copy'); tmp.remove();
      showToast('âœ… Copied');
    }catch(_){ showToast('Copy failed'); }
  }

  /* ===== PDF/Export ===== */
  function titleFromContent(){ const plain=htmlToText(editor?.getData?.()||''); const first=(plain.split(/\n|\./)[0]||'ThinkHelper').slice(0,80).replace(/[\\/:*?"<>|]/g,'_'); return first||'ThinkHelper'; }
  function positionSaveMenu(){ const b=$('#saveBtn'), m=$('#saveMenu'); const r=b.getBoundingClientRect(); m.style.left=r.left+'px'; m.style.top=(r.bottom+6)+'px'; }
  function toggleSaveMenu(){ const m=$('#saveMenu'); if(m.style.display==='block'){m.style.display='none';return;} positionSaveMenu(); m.style.display='block'; const onDoc=(e)=>{ if(!m.contains(e.target) && e.target!==$('#saveBtn')){ m.style.display='none'; document.removeEventListener('click',onDoc);} }; setTimeout(()=>document.addEventListener('click',onDoc),0); }
  function buildStandaloneHtmlDoc({maskPII=true}={}){
    const doc=document.implementation.createHTMLDocument(titleFromContent());
    const head=doc.head; head.appendChild(Object.assign(doc.createElement('meta'),{charset:'utf-8'})); head.appendChild(Object.assign(doc.createElement('meta'),{name:'viewport',content:'width=device-width,initial-scale=1'}));
    const style=doc.createElement('style'); style.textContent='body{font-family:-apple-system,Segoe UI,Roboto,sans-serif;line-height:1.6;padding:16px;color:#111}h2{margin:0 0 12px 0}blockquote{border-left:3px solid #ddd;margin:8px 0;padding:4px 8px;color:#555}a{color:#1565c0}.pii-pill-exp{display:inline-block;padding:0 .45em;border-radius:999px;border:1px dashed #f44336;background:#ffe7e7;color:#b71c1c}'; head.appendChild(style);
    const h2=doc.createElement('h2'); h2.textContent=titleFromContent(); doc.body.appendChild(h2);
    const tmp=document.createElement('div'); tmp.innerHTML=editor?.getData?.()||'';
    if(maskPII){
      const walker=document.createTreeWalker(tmp,NodeFilter.SHOW_TEXT,null); const nodes=[]; let n; while((n=walker.nextNode())) nodes.push(n);
      nodes.forEach(function(node){ const text=node.nodeValue||''; const hits=findPIIMatches(text); if(!hits.length) return; const frag=doc.createDocumentFragment(); let cur=0; hits.forEach(function(h){ if(h.start>cur) frag.appendChild(doc.createTextNode(text.slice(cur,h.start))); const pill=doc.createElement('span'); pill.setAttribute('class','pii-pill-exp'); pill.textContent='â€¢â€¢â€¢â€¢'; frag.appendChild(pill); cur=h.end; }); if(cur<text.length) frag.appendChild(doc.createTextNode(text.slice(cur))); if(node.parentNode) node.parentNode.replaceChild(frag,node); });
    }
    Array.from(tmp.childNodes).forEach(ch=> doc.body.appendChild(doc.importNode(ch,true)));
    return '<!DOCTYPE html>\n'+doc.documentElement.outerHTML;
  }
  async function ensureHtml2Pdf(){ if(window.html2pdf) return true; return new Promise(res=>{ const s=document.createElement('script'); s.src='https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js'; s.onload=()=>res(true); s.onerror=()=>res(false); document.head.appendChild(s); }); }
  function downloadBlob(blob,filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; document.body.appendChild(a); a.click(); setTimeout(()=>{URL.revokeObjectURL(a.href); a.remove();},0); }

  /* ===== Auth/Drive via server (no client id exposed) ===== */
  let isLoggedIn=false, userProfile=null;
  function setSignedInUI(signed){
    isLoggedIn=!!signed;
    const labelSignIn=L?.ui?.authLogin||'Sign in'; const labelSignOut=L?.ui?.authLogout||'Sign out';
    $('#authBtn').textContent = signed ? labelSignOut : labelSignIn;
    $('#authBtn').onclick = signed ? logout : login;
    $('#loginDisplay').textContent = (signed && userProfile) ? (userProfile.name || userProfile.email || '') : '';
  }
  async function getMe(){ try{ const r=await fetch(apiUrl('google/me'),{credentials:'include'}); return r.ok?await r.json():null; }catch(_){ return null; } }
  async function login(){
    try{
      const r=await fetch(apiUrl('google/login'),{method:'POST',credentials:'include'}); const j=r.ok?await r.json():null;
      if(!j?.auth_url) throw new Error('No auth_url');
      const w=520,h=640,y=(window.outerHeight/2+window.screenY-h/2),x=(window.outerWidth/2+window.screenX-w/2);
      const win=window.open(j.auth_url,'_blank',`noopener,width=${w},height=${h},left=${x},top=${y}`);
      let me=null,tries=0;
      while(tries<60){ await new Promise(res=>setTimeout(res,1000)); me=await getMe(); if(me?.email) break; if(win && win.closed) break; tries++; }
      if(me?.email){ userProfile=me; setSignedInUI(true); showToast(L.msg.loginOK); await loadCloudDraft(); } else { showToast(L.msg.loginFail); }
    }catch(_){ showToast(L.msg.loginFail); }
  }
  async function logout(){ try{ await fetch(apiUrl('google/logout'),{method:'POST',credentials:'include'}); }catch(_){ } userProfile=null; setSignedInUI(false); showToast(L.msg.logoutOK); }

  const debCloud=(fn,ms=1200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
  async function saveCloudDraftNow(){
    if(!isLoggedIn) return;
    const payload={title:titleFromContent(), html:editor?.getData?.()||'', updatedAt:Date.now()};
    try{
      await fetch(apiUrl('google/appdata/draft'),{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});
      renderDocList(payload);
    }catch(e){ console.warn('saveCloudDraft error',e); }
  }
  const saveCloudDraftDebounced=debCloud(saveCloudDraftNow,1200);
  async function loadCloudDraft(){
    try{
      const r=await fetch(apiUrl('google/appdata/draft'),{credentials:'include'});
      if(!r.ok){ renderDocList({title:'Cloud Draft',updatedAt:Date.now(),html:editor?.getData?.()||''}); return; }
      const data=await r.json();
      if(data && data.html){ const currentPlain=htmlToText(editor?.getData?.()||''); if(!currentPlain){ editor.setData(data.html||''); showToast(L.msg.cloudLoaded); } }
      renderDocList(data||{title:'Cloud Draft',updatedAt:Date.now(),html:editor?.getData?.()||''});
    }catch(e){ console.warn('loadCloudDraft error',e); }
  }

  /* ===== Consent ===== */
  function updateConsentBadge(){
    const choice=localStorage.getItem('consent-ok'); const b=$('#consentBadge');
    if(choice==='0'){ b.textContent=L.ui.badgeOff; b.classList.add('off'); }
    else if(choice==='1'){ b.textContent=L.ui.badgeOn; b.classList.remove('off'); }
    else { b.textContent=L.ui.badgeWait; b.classList.remove('off'); }
  }
  function applyConsentEffect(){
    const choice=localStorage.getItem('consent-ok');
    if(choice==='0'){
      enableSuggestions=false; localStorage.setItem('enableSuggestions','false');
      const s=$('#suggestions'); if(s) s.style.display='none';
    }
    updateConsentBadge();
  }
  function initConsent(){
    const choice=localStorage.getItem('consent-ok');
    if(choice===null){ $('#consent').style.display='flex'; }
    else{ applyConsentEffect(); }
    $('#agreeBtn').onclick=function(){
      localStorage.setItem('consent-ok','1'); $('#consent').style.display='none';
      enableSuggestions=(localStorage.getItem('enableSuggestions')!=='false'); applyConsentEffect(); showToast(L.msg.consentSaved);
    };
    $('#declineBtn').onclick=function(){
      localStorage.setItem('consent-ok','0'); $('#consent').style.display='none';
      applyConsentEffect(); showToast(L.msg.consentOff);
    };
    $('#consentClose').onclick=function(){ $('#consent').style.display='none'; };
  }

  /* ===== Search ===== */
  const SEARCH_HISTORY_KEY='thinkhelper:searchHistory';
  const getHistory=()=>{try{return JSON.parse(localStorage.getItem(SEARCH_HISTORY_KEY)||'[]');}catch(e){return[];}};
  const addHistory=q=>{ if(!q) return; const arr=getHistory().filter(x=>x!==q); arr.unshift(q); localStorage.setItem(SEARCH_HISTORY_KEY, JSON.stringify(arr.slice(0,30))); };
  function sanitizeQuery(q){ return (q||'').replace(/\u00A0/g,' ').replace(/&nbsp;?/gi,' ').replace(/&amp;?/gi,' ').replace(/\s{2,}/g,' ').trim(); }
  function buildSearchSuggestions(q){
    q=sanitizeQuery(q||''); if(!q) return getHistory().slice(0,8);
    const hist=getHistory().filter(h=>h.toLowerCase().startsWith(q.toLowerCase()));
    const lang=uiLang;
    const exp=lang==='ko'?[`${q} ì˜ë¯¸`,`${q} ì˜ˆì‹œ`,`${q} í•µì‹¬`,`${q} ìš”ì•½`,`${q} ì¥ë‹¨ì `,`${q} ì‰½ê²Œ ì„¤ëª…`]
      : lang==='ja'?[`${q} ã¨ã¯`,`${q} ä¾‹`,`${q} è¦ç‚¹`,`${q} è¦ç´„`,`${q} é•·æ‰€ çŸ­æ‰€`,`ã‚„ã•ã—ã ${q}`]
      : lang==='fr'?[`${q} signification`,`exemples ${q}`,`points clÃ©s ${q}`,`${q} rÃ©sumÃ©`,`${q} avantages inconvÃ©nients`,`expliquer ${q}`]
      : lang==='vi'?[`${q} lÃ  gÃ¬`,`vÃ­ dá»¥ ${q}`,`Ä‘iá»ƒm chÃ­nh ${q}`,`${q} tÃ³m táº¯t`,`Æ°u nhÆ°á»£c Ä‘iá»ƒm ${q}`,`giáº£i thÃ­ch ${q}`]
      : [`${q} meaning`,`${q} examples`,`${q} key points`,`${q} summary`,`${q} pros and cons`,`explain ${q}`];
    return Array.from(new Set([...hist,...exp.map(sanitizeQuery)])).filter(Boolean).slice(0,8);
  }
  let ssIndex=-1, ssItems=[];
  function showSearchSuggest(){
    const q=$('#searchInput').value; const list=buildSearchSuggestions(q); const box=$('#searchSuggest');
    if(!list.length){ box.style.display='none'; ssItems=[]; ssIndex=-1; return; }
    const safe=window.DOMPurify?.sanitize||(x=>x);
    box.innerHTML=list.map((t,i)=>`<div class="search-sug-item" data-i="${i}"><span class="icon">ğŸ”</span><span class="text">${safe(t)}</span></div>`).join('');
    box.querySelectorAll('.search-sug-item').forEach(n=>{ n.onclick=()=>{ $('#searchInput').value=list[+n.dataset.i]; doSearch(false); box.style.display='none'; }; });
    ssItems=list; ssIndex=0; box.style.display='block';
  }
  function renderOpenSuggestion(first){
    const box=$('#searchJump'); if(!first){ box.style.display='none'; return; }
    const safe=window.DOMPurify?.sanitize||(x=>x);
    box.innerHTML=`<span class="label">ğŸ”— ${L.ui.jumpFirst}</span><span class="meta" title="${safe(first.title||first.link)}">${safe(first.title||first.link)}</span><div style="margin-left:auto;display:flex;gap:.4rem"><button class="btn tiny" id="jumpGoBtn">${L.ui.jumpOpen}</button><button class="btn tiny" id="jumpInsertBtn">${L.ui.jumpInsert}</button></div>`;
    box.style.display='flex';
    $('#jumpGoBtn').onclick=()=>{ openExternal(first.link); box.style.display='none'; };
    $('#jumpInsertBtn').onclick=()=>{ insertSearchResult(first); box.style.display='none'; };
  }
  function insertSearchResult(first){
    const safe=window.DOMPurify?.sanitize||(x=>x);
    const q=($('#searchInput').value||'').trim();
    const h='<blockquote><p>ğŸ” <a href="'+first.link+'" target="_blank" rel="noopener">'+(first.title?safe(first.title):q)+'</a></p><p>'+(first.snippet?safe(first.snippet):'')+'</p></blockquote><p></p>';
    editor.model.change(function(w){ const frag=editor.data.toModel(editor.data.processor.toView(h)); w.insert(frag, editor.model.document.selection.getFirstPosition()); });
    showToast(L.msg.searchOK);
  }
  async function doSearch(preferNavigate=false){
    const q=(($('#searchInput').value)||'').trim();
    if(q.length<2) return showToast(L.msg.searchTooShort);
    addHistory(q);
    try{
      const r=await fetch(apiUrl('search')+'?q='+encodeURIComponent(q));
      const j=await r.json(); const first=(j.links||[])[0];
      if(!first) return showToast(L.msg.noResults);
      if(preferNavigate){ openExternal(first.link); return; }
      renderOpenSuggestion(first);
    }catch(_){ showToast(L.msg.searchErr); }
  }

  /* ===== Consent/UI/etc init after DOM ready ===== */
  document.addEventListener('DOMContentLoaded', async ()=>{
    // ì–¸ì–´ ì ìš© (ê°€ì¥ ë¨¼ì €)
    const langSource=localStorage.getItem('langSource');
    if(langSource!=='user'){
      const nav=(navigator.language||'en').slice(0,2).toLowerCase();
      if(['ko','en','ja','fr','vi'].includes(nav)) uiLang=nav;
    }
    applyLang(uiLang);
    if($('#languageSelect')) $('#languageSelect').addEventListener('change', e=>{ localStorage.setItem('langSource','user'); applyLang(e.target.value||'ko'); });
    if($('#languageSelectMobile')) $('#languageSelectMobile').addEventListener('change', e=>{ localStorage.setItem('langSource','user'); applyLang(e.target.value||'ko'); });

    // ì—ë””í„° ì´ˆê¸°í™”
    async function initEditor(){
      if(!window.ClassicEditor){ console.error('ClassicEditor not loaded'); return; }
      const ed=await ClassicEditor.create($('#editor'),{extraPlugins:[]});
      ed.plugins.get('FileRepository').createUploadAdapter=function(loader){ return new Base64UploadAdapter(loader); };
      editor=ed;

      // PII í‘œì‹œ attribute
      editor.model.schema.extend('$text',{allowAttributes:['piiType']});
      editor.conversion.for('downcast').attributeToElement({ model:'piiType', view:(val,api)=> api.writer.createAttributeElement('span',{class:'pii-pill','data-type':val},{priority:5}) });
      editor.conversion.for('dataDowncast').attributeToElement({ model:'piiType', view:(val,api)=> api.writer.createAttributeElement('span',{class:'pii-pill','data-type':val},{priority:5}) });

      // ë“œë˜í”„íŠ¸ ë¡œë“œ
      try{ const saved=localStorage.getItem(DRAFT_KEY); if(saved && !editor.getData()) editor.setData(saved); }catch(_){}
      const scanPII=function(){
        editor.model.change(function(writer){
          const root=editor.model.document.getRoot();
          writer.removeAttribute('piiType', editor.model.createRangeIn(root));
          const walker=editor.model.createRangeIn(root).getWalker({ignoreElementEnd:true});
          for(const step of walker){
            if(!step.item.is('textProxy')) continue;
            const base=step.previousPosition; const data=step.item.data||''; if(!data.trim()||!base) continue;
            const matches=findPIIMatches(data);
            for(const m of matches){ const s=base.getShiftedBy(m.start), e=base.getShiftedBy(m.end); writer.setAttribute('piiType', m.type, writer.createRange(s,e)); }
          }
        });
        const sel=editor.model.document.selection;
        piiLockActive=!!sel.getAttribute('piiType'); if(piiLockActive) $('#suggestions').style.display='none';
      };

      const deb=(fn,ms=200)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};};
      const saveDraft=deb(function(){ try{ localStorage.setItem(DRAFT_KEY, editor.getData()||''); }catch(_){ } saveCloudDraftDebounced(); },500);
      const updateEditorSuggestionsDebounced=deb(updateEditorSuggestions,140);

      const onChanged=function(){ scanPII(); if(enableInstant && window.innerWidth<=860) updateEditorSuggestions(); else updateEditorSuggestionsDebounced(); saveDraft(); };
      ed.model.document.on('change:data', onChanged);
      ed.model.document.selection.on('change:range', function(){ const sel=editor.model.document.selection; piiLockActive=!!sel.getAttribute('piiType'); if(!piiLockActive) updateEditorSuggestionsDebounced(); else $('#suggestions').style.display='none'; });

      const el=ed.ui.view.editable.element;
      ['input','keyup','mouseup','touchend','focus'].forEach(evt=>{ el.addEventListener(evt,function(){ if(!piiLockActive) updateEditorSuggestions(); },{passive:true}); });
      window.addEventListener('resize',function(){ if($('#suggestions').style.display==='block') positionSuggestions(); });
      document.addEventListener('scroll',function(){ if($('#suggestions').style.display==='block') positionSuggestions(); },true);

      el.addEventListener('drop', async function(e){
        const files=e.dataTransfer?.files; if(!files||!files.length) return;
        const non=[]; for(let i=0;i<files.length;i++){ if(!files[i].type.startsWith('image/')) non.push(files[i]); }
        if(!non.length) return; e.preventDefault();
        for(const f of non){
          const url=URL.createObjectURL(f);
          editor.model.change(function(w){
            const frag=editor.data.toModel(editor.data.processor.toView('<p>ğŸ“ <a href="'+url+'" download="'+encodeURIComponent(f.name)+'">'+f.name+'</a></p>'));
            w.insert(frag, editor.model.document.selection.getFirstPosition());
          });
        }
        showToast(L.msg.attachOK);
      });

      renderDocList();
      document.querySelectorAll('small[style*="color:red"]').forEach(n=>n.remove());
    }
    await initEditor();

    /* ì„¤ì •/ëª¨ë‹¬ í•¸ë“¤ë§ */
    function syncSettingsUI(){
      $('#toggleSuggestions').checked=(localStorage.getItem('enableSuggestions')!=='false');
      $('#toggleInstant').checked=(localStorage.getItem('enableInstant')!=='false');
      $('#togglePdfMask').checked=(localStorage.getItem('pdfMask')!=='false');
      $('#togglePiiHighlight').checked=(localStorage.getItem('piiHighlight')!=='false');
      const denied=localStorage.getItem('consent-ok')==='0'; $('#toggleSuggestions').disabled=denied;
    }
    $('#settingsBtn').onclick=function(){ syncSettingsUI(); $('#settingsModal').style.display='flex'; };
    $('#settingsBtnMobileQA').onclick=function(){ syncSettingsUI(); $('#settingsModal').style.display='flex'; };
    document.querySelectorAll('.modal .close,[data-close]').forEach(btn=>{
      btn.addEventListener('click',()=>{ const sel=btn.getAttribute('data-close'); if(sel) document.querySelector(sel).style.display='none'; else $('#consent').style.display='none'; });
    });
    document.querySelectorAll('.modal').forEach(m=>{ m.addEventListener('click',e=>{ if(e.target===m) m.style.display='none'; }); });

    $('#toggleSuggestions').addEventListener('change', e=>{ localStorage.setItem('enableSuggestions', e.target.checked?'true':'false'); enableSuggestions=e.target.checked; if(!enableSuggestions) $('#suggestions').style.display='none'; else updateEditorSuggestions(); });
    $('#toggleInstant').addEventListener('change', e=>{ localStorage.setItem('enableInstant', e.target.checked?'true':'false'); enableInstant=e.target.checked; });
    $('#togglePdfMask').addEventListener('change', e=>{ localStorage.setItem('pdfMask', e.target.checked?'true':'false'); });
    $('#togglePiiHighlight').addEventListener('change', e=>{
      localStorage.setItem('piiHighlight', e.target.checked?'true':'false');
      document.body.classList.toggle('hide-pii', !e.target.checked);
      const cssId='pii-hide-style'; let s=document.getElementById(cssId);
      if(!e.target.checked){ if(!s){ s=document.createElement('style'); s.id=cssId; s.textContent='.ck-content .pii-pill{visibility:hidden}'; document.head.appendChild(s);} }
      else if(s){ s.remove(); }
    });
    $('#toggleThemeInSettings').onclick=()=> document.body.classList.toggle('dark');
    $('#reopenConsent').onclick=()=> $('#consent').style.display='flex';

    /* ì €ì¥ ë©”ë‰´ */
    $('#saveBtn').onclick=toggleSaveMenu;
    window.addEventListener('resize',()=>{ if($('#saveMenu').style.display==='block') positionSaveMenu(); });
    $('#saveMenuPdf').onclick=async function(){
      $('#saveMenu').style.display='none'; const ok=await ensureHtml2Pdf(); if(!ok) return showToast(L.msg.pdfFail);
      const wrap=document.createElement('div'); wrap.style.padding='16px';
      const mask=(localStorage.getItem('pdfMask')!=='false'); const html=buildStandaloneHtmlDoc({maskPII:mask});
      const parsed=new DOMParser().parseFromString(html,'text/html'); wrap.appendChild(parsed.body.cloneNode(true));
      try{ await html2pdf().set({margin:10,filename:titleFromContent()+'.pdf',image:{type:'jpeg',quality:0.98},html2canvas:{scale:2,useCORS:true},jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}}).from(wrap).save();
        addLocalDoc(titleFromContent()+' (PDF)', editor.getData()||''); showToast(L.msg.pdfOK);
      }catch(_){ showToast(L.msg.pdfFail); }
    };
    $('#saveMenuDevice').onclick=function(){
      $('#saveMenu').style.display='none'; const mask=(localStorage.getItem('pdfMask')!=='false');
      const html=buildStandaloneHtmlDoc({maskPII:mask}); downloadBlob(new Blob([html],{type:'text/html'}), titleFromContent()+'.html');
      addLocalDoc(titleFromContent()+' (HTML)', editor.getData()||''); showToast(L.msg.fileOK);
    };

    /* ê³µìœ  */
    bindShare($('#shareNaverBtn'),(t,u)=>`https://share.naver.com/web/shareView?url=${encodeURIComponent(u)}&title=${encodeURIComponent(t)}`);
    bindShare($('#shareTwitterBtn'),(t,u)=>`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(u)}`);
    const bindShareMobile=(btn,builder)=>{ if(btn) btn.onclick=()=>{ const p=getSharePayload(); openPopup(builder(p.title,p.url)); $('#drawer').style.display='none'; }; };
    bindShareMobile($('#shareNaverBtnMobileQA'),(t,u)=>`https://share.naver.com/web/shareView?url=${encodeURIComponent(u)}&title=${encodeURIComponent(t)}`);
    bindShareMobile($('#shareTwitterBtnMobileQA'),(t,u)=>`https://twitter.com/intent/tweet?text=${encodeURIComponent(t)}&url=${encodeURIComponent(u)}`);

    /* ë³µì‚¬ */
    $('#copyBtn').onclick=copySelection;

    /* Drawer/í…Œë§ˆ */
    function applyTimeTheme(){ const h=new Date().getHours(); document.body.classList.toggle('dark',(h>=18||h<6)); }
    applyTimeTheme(); setInterval(applyTimeTheme,5*60*1000);
    $('#themeBtn').onclick=()=> document.body.classList.toggle('dark');
    $('#themeBtnMobileQA').onclick=()=>{ document.body.classList.toggle('dark'); $('#drawer').style.display='none'; };
    const drawer=$('#drawer'); $('#sidebarToggle').onclick=()=>{ if(window.innerWidth<=860){ drawer.style.display='flex'; drawer.setAttribute('aria-hidden','false'); } else { $('#sidebar').classList.toggle('open'); } };
    $('#menuBtn').onclick=()=>{ drawer.style.display='flex'; drawer.setAttribute('aria-hidden','false'); };
    $('#drawerClose').onclick=()=>{ drawer.style.display='none'; drawer.setAttribute('aria-hidden','true'); };
    drawer.addEventListener('click',(e)=>{ if(e.target===drawer){ drawer.style.display='none'; drawer.setAttribute('aria-hidden','true'); } });

    // ì…ë ¥ ì¶”ì²œ: ë“œë¡œì–´ê°€ ì—´ë¦¬ë©´ ìˆ¨ê¹€
    (function(){
      const isMobile=()=>window.matchMedia('(max-width: 860px)').matches; let pausedByDrawer=false;
      function pauseSuggestions(){ if(!isMobile()) return; pausedByDrawer=true; const box=$('#suggestions'); if(box) box.style.display='none'; }
      function resumeSuggestions(){ if(!isMobile()) return; pausedByDrawer=false; if(typeof window.updateEditorSuggestions==='function'){ setTimeout(window.updateEditorSuggestions,0); } }
      ;['menuBtn','sidebarToggle'].forEach(id=>{ const el=document.getElementById(id); if(el) el.addEventListener('click',pauseSuggestions,{capture:true}); });
      const drawerEl=document.getElementById('drawer'); const drawerClose=document.getElementById('drawerClose');
      if(drawerClose) drawerClose.addEventListener('click',resumeSuggestions,{capture:true});
      if(drawerEl) drawerEl.addEventListener('click',(e)=>{ if(e.target===drawerEl) resumeSuggestions(); });
      (function patch(){ if(typeof window.updateEditorSuggestions!=='function'){ setTimeout(patch,50); return; }
        const orig=window.updateEditorSuggestions;
        window.updateEditorSuggestions=function(){ if(pausedByDrawer && isMobile()){ const box=document.getElementById('suggestions'); if(box) box.style.display='none'; return; } return orig.apply(this,arguments); };
      })();
    })();

    /* ë„ì›€ë§ */
    function openHelpModal(){
      const safe=window.DOMPurify?.sanitize||(x=>x);
      document.getElementById('helpTitle').textContent = (L?.ui?.helpTitle)||'ë„ì›€ë§';
      document.getElementById('helpContent').innerHTML = safe((L?.ui?.helpHtml)||'<p>ë„ì›€ë§ ë‚´ìš©ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</p>');
      document.getElementById('helpModal').style.display='flex';
    }
    document.getElementById('helpBtn').addEventListener('click', openHelpModal);

    /* ë™ì˜ ë°°ì§€/ëª¨ë‹¬ */
    initConsent();

    /* Auth ìƒíƒœ í™•ì¸ */
    try{
      const me=await getMe();
      if(me?.email){ userProfile=me; setSignedInUI(true); await loadCloudDraft(); }
      else setSignedInUI(false);
    }catch(_){ setSignedInUI(false); }

    /* ê²€ìƒ‰ ë°”ì¸ë”© */
    $('#searchInput').addEventListener('input', showSearchSuggest);
    $('#searchInput').addEventListener('focus', showSearchSuggest);
    document.addEventListener('click',(e)=>{ if(!$('#inlineSearch').contains(e.target)) $('#searchSuggest').style.display='none'; });
    $('#searchInput').addEventListener('keydown',(e)=>{
      const box=$('#searchSuggest');
      if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ e.preventDefault(); doSearch(true); box.style.display='none'; return; }
      if(box.style.display!=='block'||!ssItems.length) return;
      if(e.key==='ArrowDown'){ e.preventDefault(); ssIndex=(ssIndex+1)%ssItems.length; box.querySelectorAll('.search-sug-item').forEach((n,i)=> n.classList.toggle('selected',i===ssIndex)); }
      else if(e.key==='ArrowUp'){ e.preventDefault(); ssIndex=(ssIndex-1+ssItems.length)%ssItems.length; box.querySelectorAll('.search-sug-item').forEach((n,i)=> n.classList.toggle('selected',i===ssIndex)); }
      else if(e.key==='Enter'){ e.preventDefault(); if(ssIndex>=0){ $('#searchInput').value=ssItems[ssIndex]; } doSearch(false); box.style.display='none'; }
      else if(e.key==='Escape'){ box.style.display='none'; }
    });
    $('#searchBtn').onclick=()=>doSearch(false);

    /* ì±„íŒ… */
    function appendChat(role,text){ const d=document.createElement('div'); d.className='chatMsg '+(role==='user'?'user':'ai'); d.textContent=text; $('#chatLog').appendChild(d); $('#chatLog').scrollTop=$('#chatLog').scrollHeight; }
    async function sendChat(){
      const v=$('#chatInput').value.trim(); if(!v) return; appendChat('user',v); $('#chatInput').value='';
      const key=[uiLang,v].join('|'); let reply='';
      if(chatCache[key]) reply=chatCache[key];
      else if(isOnline()){
        try{
          const r=await fetch(apiUrl('chat'),{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'gptnano',input:v})});
          const j=r.ok?await r.json():null; reply=j?.output||j?.text||j?.message||'';
          if(reply){ chatCache[key]=reply; saveCache(CHAT_CACHE_KEY,chatCache); }
        }catch(_){ reply=''; }
      }
      if(!reply){ reply='(ì˜¤í”„ë¼ì¸) ìºì‹œì— ì—†ëŠ” ì§ˆë¬¸ì…ë‹ˆë‹¤. ëŒ€ì‹  ë¬¸ì„œ ì‘ì„± í…œí”Œë¦¿:\n- í•µì‹¬ ìš”ì•½ í•œ ì¤„\n- ê·¼ê±° ë°ì´í„°/ì‚¬ë¡€\n- ë‹¤ìŒ ë‹¨ê³„ 3ê°€ì§€\n- ê¸°ëŒ€ íš¨ê³¼ ë° ë¦¬ìŠ¤í¬'; }
      appendChat('ai',reply);
    }
    $('#chatBtn').onclick=function(){ $('#chatPanel').style.display='flex'; $('#chatInput').focus(); };
    $('#chatBtnMobileQA').onclick=function(){ $('#chatPanel').style.display='flex'; $('#chatInput').focus(); $('#drawer').style.display='none'; };
    $('#chatClose').onclick=function(){ $('#chatPanel').style.display='none'; };
    $('#chatFullscreenToggle').onclick=function(){ $('#chatPanel').classList.toggle('fullscreen'); };
    $('#chatInput').addEventListener('keydown',function(e){ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); sendChat(); } });

    /* ê¸°íƒ€ */
    $('#newDocBtn').onclick=function(){ if(editor && editor.setData){ editor.setData(''); } try{ localStorage.removeItem(DRAFT_KEY); }catch(_){ } showToast(L.msg.newDoc); };
    if($('#newDocCTA')) $('#newDocCTA').addEventListener('click',()=>$('#newDocBtn').click());
    window.addEventListener('beforeunload', function(){ try{ localStorage.setItem(DRAFT_KEY, editor?.getData?.()||''); }catch(_){ } });
  });

  /* reCAPTCHA ì½œë°± (ì „ì—­) */
  function onSubmit(token){ const form=document.getElementById("demo-form"); if(form){ form.submit(); } showToast('reCAPTCHA verified'); }
  window.onSubmit=onSubmit;
  </script>

  <!-- ì„¤ì • ëª¨ë‹¬(ë§ˆì§€ë§‰ì— ë‘¬ì„œ DOM ì¡´ì¬ ë³´ì¥) -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="card">
      <header>
        <h3 id="settingsTitle">ì„¤ì •</h3>
        <button class="close" data-close="#settingsModal" aria-label="ë‹«ê¸°">âœ•</button>
      </header>
      <div class="content">
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="toggleSuggestions" id="labelSuggest">ì¶”ì²œ ì—ë””í„° ì‚¬ìš©</label>
          <input type="checkbox" id="toggleSuggestions"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="toggleInstant" id="labelInstant">ëª¨ë°”ì¼ ì¦‰ì‹œ ì œì•ˆ(ì €ì‚¬ì–‘ ë¹„í™œì„± ê¶Œì¥)</label>
          <input type="checkbox" id="toggleInstant"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="togglePdfMask" id="labelPdfMask">PDF ì €ì¥ ì‹œ ë§ˆìŠ¤í‚¹ ì ìš©</label>
          <input type="checkbox" id="togglePdfMask"/>
        </div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin:.4rem 0">
          <label for="togglePiiHighlight" id="labelPiiHighlight">ì—ë””í„°ì—ì„œ PII í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ</label>
          <input type="checkbox" id="togglePiiHighlight"/>
        </div>
        <hr style="margin:10px 0; border:none; border-top:1px solid var(--border)"/>
        <div style="display:flex;gap:.5rem;flex-wrap:wrap">
          <button class="btn" id="reopenConsent">ê°œì¸ì •ë³´ ë™ì˜ ë‹¤ì‹œ ì„¤ì •</button>
          <button class="btn" id="toggleThemeInSettings">í…Œë§ˆ í† ê¸€</button>
        </div>
        <p style="margin-top:10px;font-size:.92rem;color:#555">
          â€¢ ë³µì‚¬ëŠ” ìƒë‹¨ <b>Copy</b> ë²„íŠ¼, <b>ë¶™ì—¬ë„£ê¸°</b>ëŠ” <code>Ctrl/âŒ˜+V</code>.<br/>
          â€¢ <b>ë˜ëŒë¦¬ê¸°/ë‹¤ì‹œí•˜ê¸°</b>: <code>Ctrl/âŒ˜+Z</code> / <code>Ctrl/âŒ˜+Shift+Z</code> ë˜ëŠ” <code>Ctrl/âŒ˜+Y</code>.<br/>
          â€¢ PDF ì €ì¥ ì‹œ PII ë§ˆìŠ¤í‚¹ì€ ìœ„ í† ê¸€ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        </p>
      </div>
    </div>
  </div>
</body>
</html>
