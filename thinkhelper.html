<!-- public/index.html â€” ThinkHelper 2.5 (Cloud Run ë²„ì „, /api í¬í•¨) -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ThinkHelper 2.5</title>
  <link rel="icon" href="data:,">

  <!-- ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.ckeditor.com/ckeditor5/41.0.0/classic/ckeditor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.3/dist/purify.min.js"></script>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STYLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <style>
    :root{
      --primary:#1976d2; --primary-light:#e3f2fd; --primary-hover:#bbdefb;
      --bg:#f4f4f4; --fg:#333; --box:#fff; --border:#ccc; --text-light:#fff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      height:100vh;display:flex;flex-direction:column;
      font-family:-apple-system,Segoe UI,Roboto,sans-serif;
      background:var(--bg);color:var(--fg);transition:background .3s,color .3s;
    }
    body.dark{background:#121212;color:#e0e0e0;}
    body.dark header{background:#1f1f1f;} body.dark aside{background:#1b1b1b;}
    body.dark section{background:#1e1e1e;}
    body.dark #editor,body.dark input,body.dark select,body.dark .btn{
      background:#2a2a2a;color:#e0e0e0;border-color:#444;
    }

    /* â”€â”€ Header / Side bar â”€â”€ */
    header{
      display:flex;justify-content:space-between;align-items:center;
      padding:.6rem 1rem;background:var(--primary);color:var(--text-light);
      position:sticky;top:0;z-index:100;
    }
    header h1{font-size:1.25rem;}
    .btn{
      margin-left:.45rem;padding:.35rem .75rem;border:none;border-radius:4px;
      background:var(--box);color:var(--primary);cursor:pointer;transition:background .2s;
    }
    .btn:hover{background:var(--primary-light);}
    .btn.tiny{padding:.2rem .4rem;font-size:.75rem;margin-left:0;}

    main{flex:1;display:flex;min-height:0;}
    aside{
      width:220px;padding:.9rem;background:var(--primary-light);
      border-right:1px solid var(--border);overflow:auto;
    }
    #docList{list-style:none;font-size:.9rem;}
    #docList li{
      display:flex;justify-content:space-between;align-items:center;
      padding:.5rem .2rem;border-bottom:1px dashed var(--border);cursor:pointer;
    }
    #docList li:hover{background:var(--primary-light);}
    .doc-del{margin-left:.4rem;color:#888;cursor:pointer;}
    .doc-del:hover{color:#f44336;}

    /* â”€â”€ Editor section â”€â”€ */
    section{
      flex:1;display:flex;flex-direction:column;padding:1rem;background:var(--box);
      position:relative;transition:height .25s;min-width:0;
    }
    section.collapsed{height:64px!important;}
    #editor{
      flex:1;border:1px solid var(--border);border-radius:4px;padding:.9rem;overflow:auto;
      transition:height .25s,padding .25s,border .25s;background:inherit;color:inherit;
    }
    section.collapsed #editor{height:0;padding:0;border:none;overflow:hidden;}
    .ck-editor__editable_inline{min-height:60vh!important;}
    #charCount{text-align:right;margin-top:.45rem;font-size:.85rem;color:var(--primary);}

    /* â”€â”€ Search / autocomplete â”€â”€ */
    #inlineSearch{display:flex;gap:.5rem;margin-top:1rem;position:relative;}
    #inlineSearch input{
      flex:1;padding:.55rem;font-size:1rem;border:1px solid var(--border);
      border-radius:4px;background:inherit;color:inherit;
    }
    #autocomplete{
      display:none;position:absolute;top:100%;left:0;right:0;z-index:25;
      list-style:none;margin:.35rem 0 0;padding:0;max-height:160px;overflow:auto;
      border:1px solid var(--border);border-radius:4px;background:var(--box);font-size:.9rem;
    }
    #autocomplete li{padding:.45rem .55rem;border-bottom:1px dashed var(--border);cursor:pointer;}
    #autocomplete li:hover{background:var(--primary-light);}

    /* â”€â”€ Inline suggestions â”€â”€ */
    #suggestions{
      display:none;position:absolute;z-index:30;max-width:260px;max-height:200px;overflow:auto;
      background:var(--box);border:1px solid var(--border);border-radius:6px;
      padding:.35rem .5rem;box-shadow:0 2px 6px rgba(0,0,0,.15);font-size:.9rem;
    }
    .suggestion-item{
      padding:.4rem .6rem;border-radius:4px;background:var(--primary-light);
      cursor:pointer;white-space:nowrap;
    }
    .suggestion-item:hover,.suggestion-item.active{background:var(--primary-hover);}

    /* â”€â”€ Preview popup â”€â”€ */
    #previewPopup{
      display:none;position:absolute;z-index:40;background:var(--box);
      border:1px solid var(--border);border-radius:6px;box-shadow:0 3px 8px rgba(0,0,0,.2);
      padding:.6rem;max-width:280px;
    }
    #previewPopup h4{margin-bottom:.5rem;font-size:1rem;}
    #previewPopup button{
      margin-top:.5rem;padding:.3rem .6rem;border:none;border-radius:4px;
      background:var(--primary);color:#fff;cursor:pointer;
    }

    /* â”€â”€ Chat panel â”€â”€ */
    #chatPanel{
      display:none;position:fixed;bottom:1rem;right:1rem;width:360px;height:460px;
      background:var(--box);border:1px solid var(--border);border-radius:6px;
      box-shadow:0 3px 8px rgba(0,0,0,.2);flex-direction:column;overflow:hidden;z-index:300;
    }
    #chatHeader{
      display:flex;justify-content:space-between;align-items:center;
      padding:.55rem;background:var(--primary);color:var(--text-light);
    }
    #chatLog{flex:1;overflow-y:auto;padding:.6rem;font-size:.85rem;}
    .chatMsg{margin:.45rem 0;padding:.5rem .75rem;border-radius:6px;max-width:85%;word-break:break-word;}
    .chatMsg.user{align-self:flex-end;background:var(--primary-light);}
    .chatMsg.ai{align-self:flex-start;background:#eee;}
    #chatInput{border:none;border-top:1px solid var(--border);
               padding:.6rem;width:100%;background:inherit;color:inherit;outline:none;}

    footer{text-align:center;padding:.6rem;font-size:.8rem;color:#666;border-top:1px solid var(--border);}
  </style>
</head>

<body>
  <!-- â”€â”€â”€â”€â”€ Header â”€â”€â”€â”€â”€ -->
  <header>
    <div>
      <h1>ThinkHelper 2.5</h1>
      <select id="modeSelect" aria-label="ì‘ì„± ëª¨ë“œ">
        <option value="basic">ğŸ›  Basic</option>
        <option value="journalist">ğŸ“° Journalist</option>
        <option value="research">ğŸ“‘ Research</option>
        <option value="law">âš–ï¸ Legal</option>
        <option value="dev">ğŸ’» Developer</option>
      </select>
    </div>
    <div>
      <button class="btn" id="foldBtn">ğŸ“„ ì ‘ê¸°/í¼ì¹˜ê¸°</button>
      <button class="btn" id="saveBtn">ğŸ’¾ ì €ì¥</button>
      <button class="btn" id="exportBtn">â¬‡ï¸ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn" id="chatBtn">ğŸ’¬ ì±„íŒ…</button>
      <button class="btn" id="themeBtn">ğŸŒ™ í…Œë§ˆ</button>
    </div>
  </header>

  <!-- â”€â”€â”€â”€â”€ Main â”€â”€â”€â”€â”€ -->
  <main>
    <aside><h3>ë¬¸ì„œ ëª©ë¡</h3><ul id="docList"></ul></aside>
    <section id="wrap">
      <div id="editor"></div>
      <div id="charCount">0ì</div>

      <div id="inlineSearch">
        <input id="searchInput" placeholder="ê²€ìƒ‰(/) ë˜ëŠ” Ctrl+K" autocomplete="off">
        <button class="btn" id="searchBtn" aria-label="ê²€ìƒ‰">ğŸ” ê²€ìƒ‰</button>
      </div>
      <ul id="autocomplete"></ul>
      <div id="suggestions"></div>
      <div id="previewPopup"></div>
    </section>
  </main>

  <!-- â”€â”€â”€â”€â”€ Chat â”€â”€â”€â”€â”€ -->
  <div id="chatPanel" role="dialog" aria-modal="true">
    <div id="chatHeader">ğŸ’¬ Gemini Chat<button class="btn" id="chatClose">âœ–ï¸ ë‹«ê¸°</button></div>
    <div id="chatLog"></div>
    <input id="chatInput" placeholder="Enter ë¡œ ì „ì†¡">
  </div>

  <footer>âš ï¸ AI ì¶œë ¥ì€ ì˜¤ë¥˜ê°€ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¤‘ìš”í•œ ë‚´ìš©ì€ ë°˜ë“œì‹œ ê²€ì¦í•˜ì„¸ìš”.</footer>

  <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ SCRIPT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <script>
    /* ========= UTIL ========= */
    const $ = id => document.getElementById(id);
    const deb = (fn,ms=300)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);}};

    /* ========= THEME ========= */
    function setTheme(dark){
      document.body.classList.toggle('dark',dark);
      localStorage.setItem('theme',dark?'dark':'light');
    }
    (()=>{const s=localStorage.getItem('theme');
      setTheme(s? s==='dark' : (new Date().getHours()>=18||new Date().getHours()<6));})();
    $('themeBtn').onclick=()=>setTheme(!document.body.classList.contains('dark'));

    /* ========= APP STATE ========= */
    $('foldBtn').onclick=()=>$('wrap').classList.toggle('collapsed');
    let mode='basic'; $('modeSelect').onchange=e=>mode=e.target.value;

    /* === Cloud Run endpoint ( /api í¬í•¨ ) === */
    const API='https://api-w7dmw4n5zq-du.a.run.app/api';

    /* ========= LOCAL fallback maps ========= */
    /* (KO_MAP, EN_MAP, koQA, enQA ì •ì˜ëŠ” ìƒëµ ì—†ì´ ë™ì¼, ì•„ë˜ ì½”ë“œ ê·¸ëŒ€ë¡œ ìœ ì§€) */
    const KO_MAP={ê°€:['ê°€ë°©','ê°€ê²Œ','ê°€êµ¬','ê°€ì¡±','ê°€ì¹˜'],ë‚˜:['ë‚˜ë¬´','ë‚˜ë¼','ë‚˜ë¹„','ë‚˜ì´','ë‚˜ì—´'],
      ë‹¤:['ë‹¤ë¦¬','ë‹¤ì§','ë‹¤ë°©','ë‹¤ì–‘','ë‹¤íˆ¼'],ë¼:['ë¼ë””ì˜¤','ë¼ë©´','ë¼ë²¨','ë¼ì´ë¸Œ','ë¼ìš´ë“œ'],
      ë§ˆ:['ë§ˆìŒ','ë§ˆì„','ë§ˆë²•','ë§ˆì°¨','ë§ˆì¼“'],ë°”:['ë°”ë‹¤','ë°”ëŒ','ë°”ëŠ˜','ë°”ë³´','ë°”ìœ„'],
      ì‚¬:['ì‚¬ê³¼','ì‚¬ë‘','ì‚¬ì „','ì‚¬ë§‰','ì‚¬ìŠ´'],ì•„:['ì•„ì¹¨','ì•„ì´','ì•„ì´ìŠ¤','ì•„íŒŒíŠ¸','ì•„ë¹ '],
      ì:['ììœ ','ìë™ì°¨','ìë£Œ','ìì—°','ìì „ê±°'],ì°¨:['ì°¨ëŸ‰','ì°¨íŠ¸','ì°¨í‘œ','ì°¨ì´','ì°¨ì›'],
      ì¹´:['ì¹´ë“œ','ì¹´ë©”ë¼','ì¹´ì¹´ì˜¤','ì¹´í˜','ì¹´ìš´íŠ¸'],íƒ€:['íƒ€ì›Œ','íƒ€ì','íƒ€ì„','íƒ€ì¼','íƒ€ê¹ƒ'],
      íŒŒ:['íŒŒë‘','íŒŒë„','íŒŒì›Œ','íŒŒì¼','íŒŒí‹°'],í•˜:['í•˜ëŠ˜','í•˜íŠ¸','í•˜ì´','í•˜ë§ˆ','í•˜ë£¨']};
    const EN_MAP={a:['apple','angel','album','area','award'],b:['banana','bird','bridge','brown','brave'],
      c:['city','cloud','circle','coffee','candle'],d:['dog','dance','dream','drama','draft'],
      e:['eagle','earth','energy','event','extra'],f:['flower','forest','future','focus','fresh'],
      g:['grape','green','garden','giant','glory'],h:['house','heart','happy','human','hobby'],
      i:['island','idea','image','issue','iron'],j:['juice','jungle','jewel','judge','joint'],
      k:['kite','king','kitchen','kit','kind'],l:['lion','light','logic','lake','leaf'],
      m:['moon','music','market','magic','model'],n:['night','note','nature','number','noble'],
      o:['ocean','orange','orbit','order','owner'],p:['piano','paper','peace','power','party'],
      q:['queen','quick','quiet','quest','quote'],r:['river','road','robot','rain','ready'],
      s:['sun','star','smart','story','style'],t:['tree','travel','table','trend','trust'],
      u:['umbrella','union','unique','urban','upper'],v:['violet','value','voice','visit','vivid'],
      w:['whale','water','world','window','wise'],x:['xylophone','xenon','xerox','xmas','x-ray'],
      y:['yacht','yellow','youth','yield','yummy'],z:['zebra','zero','zone','zoom','zen']};
    const koQA=w=>`${w}ì´(ê°€) ë¬´ì—‡ì¸ê°€ìš”?`;
    const enQA=w=>`What is ${w}?`;

    function fallbackSuggest(keyword){
      const ch=(keyword||'')[0];
      const isKo=/[ê°€-í£]/.test(ch), isEn=/[A-Za-z]/.test(ch);
      let words,sent;
      if(isKo){words=KO_MAP[ch]||KO_MAP['ê°€'];sent=words.slice(0,3).map(koQA);}
      else if(isEn){words=EN_MAP[ch.toLowerCase()]||EN_MAP['a'];sent=words.slice(0,3).map(enQA);}
      else{words=EN_MAP['a'];sent=words.slice(0,3).map(enQA);}
      return {words,sentences:sent};
    }

    async function postSuggest(keyword,mode){
      if(!keyword.trim()) return fallbackSuggest(keyword);
      try{
        const r=await fetch(`${API}/suggestAI`,{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({keyword,mode,context:''})
        });
        if(!r.ok) throw new Error(`HTTP ${r.status}`);
        return await r.json();
      }catch(e){
        console.warn('suggestAI fallback',e.message);
        return fallbackSuggest(keyword);
      }
    }
    async function searchAPI(q){
      try{
        const r=await fetch(`${API}/search?q=${encodeURIComponent(q)}`);
        if(!r.ok) throw new Error();
        return (await r.json()).links||[];
      }catch{return[];}
    }

    /* ========= POPUP ========= */
    const popup=$('previewPopup');
    function showPopup(html,l,t){
      popup.innerHTML=html;
      popup.style.left=l+'px';
      popup.style.top=t+'px';
      popup.style.display='block';
    }
    function hidePopup(){popup.style.display='none';}
    document.addEventListener('click',e=>{
      if(!popup.contains(e.target)) hidePopup();
    });

    /* ========= CKEditor ========= */
    let editor;
    ClassicEditor.create($('editor')).then(ed=>{
      editor=ed;

      /* ê¸€ììˆ˜ */
      ed.model.document.on('change:data',()=>{
        $('charCount').textContent=
          ed.getData().replace(/<[^>]*>/g,'').length+'ì';
      });

      /* ì¸ë¼ì¸ ì¶”ì²œ */
      const sug=$('suggestions'); let items=[],stage='word',last='';
      ed.model.document.on('change:data',deb(async ()=>{
        const plain=ed.getData().replace(/<[^>]*>/g,'');
        const pos=ed.model.document.selection.getFirstPosition();
        const word=plain.slice(0,pos.offset).match(/(\S+)$/)?.[1]||'';
        if(!word){sug.style.display='none';return;}
        if(word!==last){last=word;stage='word';}
        const {words,sentences}=await postSuggest(word,mode);
        items=(stage==='word'?words:sentences).slice(0,3);
        if(!items.length){sug.style.display='none';return;}

        const sel=window.getSelection();
        if(!sel.rangeCount){sug.style.display='none';return;}
        const rect=sel.getRangeAt(0).getClientRects()[0];
        if(!rect){sug.style.display='none';return;}
        const wrap=$('wrap').getBoundingClientRect();

        sug.innerHTML=items.map((t,i)=>`<div class="suggestion-item" data-i="${i}">
          ${DOMPurify.sanitize(t)}</div>`).join('');
        sug.querySelectorAll('.suggestion-item').forEach(el=>{
          el.onclick=()=>{
            const i=+el.dataset.i;
            editor.model.change(w=>w.insertText(items[i]+' ',pos));
            sug.style.display='none';
          };
        });
        sug.style.left=(rect.left-wrap.left)+'px';
        sug.style.top=(rect.bottom-wrap.top+4)+'px';
        sug.style.display='block';
      },300));

      /* ê²€ìƒ‰ & í”„ë¦¬ë·° */
      const ac=$('autocomplete');
      $('searchInput').addEventListener('input',deb(async e=>{
        const q=e.target.value.trim();
        if(q.length<2){ac.style.display='none';return;}
        const links=await searchAPI(q);
        ac.innerHTML=links.slice(0,6).map((l,i)=>`
          <li data-i="${i}">
            <strong>${DOMPurify.sanitize(l.title)}</strong><br>
            <small>${DOMPurify.sanitize(l.snippet)}</small><br>
            <button class="btn tiny" data-open="${l.link}">ì´ë™</button>
          </li>`).join('');
        ac.querySelectorAll('li').forEach(li=>{
          const idx=+li.dataset.i;
          /* ë¯¸ë¦¬ë³´ê¸° & ì‚½ì… */
          li.onclick=()=>{
            const item=links[idx];
            const wrap=$('wrap').getBoundingClientRect();
            const r=li.getBoundingClientRect();
            showPopup(
              `<h4>${DOMPurify.sanitize(item.title)}</h4>
               <p>${DOMPurify.sanitize(item.snippet)}</p>
               <button id="btnInsert">ì´ ì •ë³´ ì‚½ì…</button>`,
              r.left-wrap.left,r.bottom-wrap.top+4
            );
            document.getElementById('btnInsert').onclick=()=>{
              ac.style.display='none'; hidePopup();
              editor.model.change(w=>{
                const html=`<blockquote><p><a href="${item.link}" target="_blank">
                             ${DOMPurify.sanitize(item.title)}</a></p>
                             <small>${DOMPurify.sanitize(item.snippet)}</small></blockquote><p></p>`;
                w.insert(editor.data.toModel(editor.data.processor.toView(html)),
                         editor.model.document.selection.getFirstPosition());
              });
            };
          };
          /* â€˜ì´ë™â€™ ë²„íŠ¼ â†’ ìƒˆ íƒ­ */
          li.querySelector('[data-open]').onclick=e=>{
            e.stopPropagation();
            window.open(e.currentTarget.dataset.open,'_blank');
          };
        });
        ac.style.display=links.length?'block':'none';
      },250));

      $('searchInput').addEventListener('keydown',e=>{
        if(e.key==='Enter'){e.preventDefault();$('searchBtn').click();}
      });
      $('searchBtn').onclick=()=>{
        const q=$('searchInput').value.trim();
        if(!q) return;
        if(confirm(`Googleì—ì„œ â€œ${q}â€ ê²€ìƒ‰ í˜ì´ì§€ë¥¼ ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¹Œìš”?`)){
          window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`,'_blank');
          return;
        }
        /* ë‚´ë¶€ ê²€ìƒ‰ ì‚½ì… */
        searchAPI(q).then(links=>{
          if(!links.length) return alert('ê²€ìƒ‰ê²°ê³¼ ì—†ìŒ');
          const it=links[0];
          editor.model.change(w=>{
            const html=`<blockquote><p><a href="${it.link}" target="_blank">
                         ${DOMPurify.sanitize(it.title)}</a></p>
                         <small>${DOMPurify.sanitize(it.snippet)}</small></blockquote><p></p>`;
            w.insert(editor.data.toModel(editor.data.processor.toView(html)),
                     editor.model.document.selection.getFirstPosition());
          });
        });
      };

      /* ë¬¸ì„œ ì €ì¥ / ë¶ˆëŸ¬ì˜¤ê¸° */
      function loadDocs(){
        const ul=$('docList'); ul.innerHTML='';
        const ks=Object.keys(localStorage).filter(k=>k.startsWith('doc-')).sort().reverse();
        if(!ks.length){ul.innerHTML='<li style="color:#777">ë¬¸ì„œ ì—†ìŒ</li>';return;}
        ks.forEach(k=>{
          const {title,html}=JSON.parse(localStorage.getItem(k));
          const li=document.createElement('li');
          li.textContent=title;
          li.onclick=()=>editor.setData(html);
          const del=document.createElement('span');
          del.textContent='âœ–ï¸'; del.className='doc-del';
          del.onclick=e=>{e.stopPropagation();localStorage.removeItem(k);loadDocs();};
          li.appendChild(del); ul.appendChild(li);
        });
      }
      $('saveBtn').onclick=()=>{
        const html=editor.getData();
        const title=html.replace(/<[^>]*>/g,'').trim().split(/[\n\.]/)[0]||'ë¬´ì œ';
        localStorage.setItem('doc-'+Date.now(),JSON.stringify({title,html}));
        alert('âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤'); loadDocs();
      };
      $('exportBtn').onclick=()=>{
        const blob=new Blob([editor.getData()],{type:'text/html'});
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='thinkhelper.html';
        a.click(); URL.revokeObjectURL(url);
      };
      loadDocs();

      /* ì±„íŒ… */
      $('chatBtn').onclick=()=>$('chatPanel').style.display='flex';
      $('chatClose').onclick=()=>$('chatPanel').style.display='none';
      $('chatInput').addEventListener('keydown',async e=>{
        if(e.key!=='Enter'||e.isComposing) return;
        const q=e.target.value.trim(); if(!q) return; e.target.value='';
        const log=$('chatLog');
        const add=(cls,txt)=>{const d=document.createElement('div');d.className='chatMsg '+cls;
                              d.textContent=txt; log.appendChild(d); log.scrollTop=log.scrollHeight; return d;};
        add('user',q); const ai=add('ai','âŒ›');
        try{
          const r=await fetch(`${API}/gpt`,{
            method:'POST',headers:{'Content-Type':'application/json'},
            body:JSON.stringify({text:q})
          });
          const j=await r.json(); ai.textContent=j.response?.text||'(ì˜¤ë¥˜)';
        }catch{ai.textContent='(ì„œë²„ ì˜¤ë¥˜)';}
      });

    }).catch(console.error);
  </script>
</body>
</html>
